# Story 5.5: Opportunity Detection

## Status

Draft

## Story

**As a** profit optimizer,
**I want** the system to identify pricing opportunities,
**so that** I can maximize margins while remaining competitive.

## Acceptance Criteria

1. Algorithm identifies when user's prices could be adjusted without losing competitive position
2. Opportunities ranked by potential impact on revenue/margin
3. Notifications for "price ceiling" opportunities when all competitors raise prices
4. Detection of "price floor" warnings when market prices drop significantly
5. Weekly opportunity report summarizes missed and captured opportunities
6. Simulation tool shows potential impact of following recommendations

## Tasks / Subtasks

- [ ] Task 1: Build opportunity detection algorithm (AC: 1, 3, 4)
  - [ ] Create OpportunityDetectionService in apps/api/app/Services/
  - [ ] Implement competitive position analysis
  - [ ] Identify price adjustment windows
  - [ ] Detect market-wide price movements
  - [ ] Calculate safe price adjustment ranges

- [ ] Task 2: Implement revenue/margin impact calculation (AC: 2)
  - [ ] Create RevenueImpactCalculator service
  - [ ] Estimate volume impact of price changes
  - [ ] Calculate potential margin improvements
  - [ ] Factor in historical elasticity data
  - [ ] Rank opportunities by financial impact

- [ ] Task 3: Create price ceiling/floor detection (AC: 3, 4)
  - [ ] Monitor competitor price movements in real-time
  - [ ] Identify unanimous price increases (ceiling)
  - [ ] Detect market-wide price drops (floor)
  - [ ] Set threshold parameters for notifications
  - [ ] Create alert triggers for critical events

- [ ] Task 4: Build opportunity tracking system (AC: 5)
  - [ ] Create Opportunity model and migration
  - [ ] Track identified vs acted-upon opportunities
  - [ ] Record opportunity windows and durations
  - [ ] Calculate missed revenue estimates
  - [ ] Store opportunity history for analysis

- [ ] Task 5: Develop simulation engine (AC: 6)
  - [ ] Create PriceSimulationService
  - [ ] Build what-if scenario calculator
  - [ ] Simulate competitive responses
  - [ ] Project revenue/volume impacts
  - [ ] Generate simulation reports with charts

- [ ] Task 6: Create opportunity API endpoints (AC: 1-6)
  - [ ] GET /api/v1/opportunities/current - Active opportunities
  - [ ] GET /api/v1/opportunities/history - Past opportunities
  - [ ] POST /api/v1/opportunities/simulate - Run simulation
  - [ ] GET /api/v1/opportunities/report/weekly - Weekly summary
  - [ ] PUT /api/v1/opportunities/{id}/action - Record action taken

- [ ] Task 7: Build opportunity dashboard UI (AC: 1, 2, 5, 6)
  - [ ] Create opportunity cards component
  - [ ] Build impact visualization charts
  - [ ] Design simulation interface
  - [ ] Add opportunity history timeline
  - [ ] Create weekly report viewer
  - [ ] Implement action tracking UI

- [ ] Task 8: Write comprehensive tests (AC: 1-6)
  - [ ] Unit tests for OpportunityDetectionService
  - [ ] Test revenue impact calculations
  - [ ] Verify ceiling/floor detection logic
  - [ ] Feature tests for opportunity API
  - [ ] Test simulation accuracy
  - [ ] Validate report generation

## Dev Notes

### Competitive Analysis Data

- Use PriceChange model for competitor pricing
- Station model for identifying competitors by radius
- Calculate relative price positions
- Track price movements over time windows
- Consider all fuel types: 'regular', 'premium', 'diesel'
  [Source: architecture/data-models.md#pricechange-model]

### Revenue Calculation Factors

- Historical sales volume data (if available)
- Price elasticity estimates
- Competitor distance weighting
- Time-of-day patterns
- Seasonal demand variations
- Local market conditions

### File Locations

Based on project structure:

- Services: apps/api/app/Services/OpportunityDetectionService.php, PriceSimulationService.php
- Models: apps/api/app/Models/Opportunity.php, OpportunityAction.php
- Controllers: apps/api/app/Http/Controllers/Api/OpportunityController.php
- Jobs: apps/api/app/Jobs/WeeklyOpportunityReportJob.php
- UI Components: apps/web/src/components/features/opportunities/
- Dashboard: apps/web/src/pages/optimization/opportunities/
  [Source: architecture/unified-project-structure.md]

### Opportunity Detection Logic

- Compare user's prices to competitor average
- Identify gaps where price could increase
- Consider customer loyalty threshold (e.g., $0.50 difference)
- Factor in brand positioning
- Account for location advantages
- Weight by competitor proximity

### Simulation Parameters

- Price adjustment range (min/max)
- Competitor response probability
- Volume impact elasticity
- Time horizon (days/weeks)
- Confidence levels
- Market condition scenarios

### Performance Optimization

- Cache opportunity calculations: `opportunities:{user_id}:{date}`
- Queue heavy simulation computations
- Pre-calculate common scenarios
- Index price_changes table for efficient queries
- Use Redis for temporary simulation data
  [Source: architecture/coding-standards.md#critical-fullstack-rules]

## Testing

### Testing Standards from Architecture

- Backend unit tests: apps/api/tests/Unit/
- Test opportunity detection algorithms
- Verify revenue impact calculations
- Mock market scenarios in tests
- Feature tests: apps/api/tests/Feature/
- Test API endpoints with various data sets
- Frontend tests: apps/web/tests/unit/
- Test simulation UI interactions
- Verify chart data rendering
  [Source: architecture/testing-strategy.md]

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-31 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
