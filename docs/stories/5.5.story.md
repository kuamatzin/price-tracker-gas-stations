# Story 5.5: Opportunity Detection

## Status

Draft

## Story

**As a** multi-station owner,
**I want** the system to identify pricing opportunities for each of my stations,
**so that** I can maximize margins while remaining competitive across my portfolio.

## Acceptance Criteria

1. Algorithm identifies when station prices could be adjusted without losing competitive position per station
2. Opportunities ranked by potential impact on revenue/margin for each station and portfolio
3. Notifications for "price ceiling" opportunities when competitors raise prices in each station's market
4. Detection of "price floor" warnings when market prices drop significantly per station area
5. Weekly opportunity report summarizes missed and captured opportunities by station and portfolio
6. Simulation tool shows potential impact of following recommendations per station and across portfolio
7. Cross-station opportunity analysis identifies patterns and strategies that work across multiple stations
8. Portfolio optimization recommendations suggest coordinated pricing strategies across stations

## Tasks / Subtasks

- [ ] Task 1: Build station-aware opportunity detection algorithm (AC: 1, 3, 4, 7)
  - [ ] Create OpportunityDetectionService with station_numero parameter in apps/api/app/Services/
  - [ ] Implement competitive position analysis per station market
  - [ ] Identify price adjustment windows for each station
  - [ ] Detect market-wide price movements by station area
  - [ ] Calculate safe price adjustment ranges per station
  - [ ] Add cross-station opportunity pattern analysis

- [ ] Task 2: Implement station-aware revenue/margin impact calculation (AC: 2, 8)
  - [ ] Create RevenueImpactCalculator service with station_numero parameter
  - [ ] Estimate volume impact of price changes per station
  - [ ] Calculate potential margin improvements by station and portfolio
  - [ ] Factor in station-specific historical elasticity data
  - [ ] Rank opportunities by financial impact per station and cumulative portfolio impact
  - [ ] Add portfolio-level revenue optimization scenarios

- [ ] Task 3: Create station-aware price ceiling/floor detection (AC: 3, 4, 7)
  - [ ] Monitor competitor price movements in real-time per station market
  - [ ] Identify unanimous price increases (ceiling) in each station's competitive area
  - [ ] Detect market-wide price drops (floor) by station region
  - [ ] Set station-specific threshold parameters for notifications
  - [ ] Create alert triggers for critical events per station
  - [ ] Track cross-station ceiling/floor pattern correlations

- [ ] Task 4: Build station-aware opportunity tracking system (AC: 5, 8)
  - [ ] Create Opportunity model and migration with station_numero field
  - [ ] Track identified vs acted-upon opportunities per station
  - [ ] Record opportunity windows and durations by station
  - [ ] Calculate missed revenue estimates per station and portfolio
  - [ ] Store opportunity history for station-specific analysis
  - [ ] Track cross-station opportunity patterns and success rates

- [ ] Task 5: Develop station-aware simulation engine (AC: 6, 8)
  - [ ] Create PriceSimulationService with station_numero parameter
  - [ ] Build what-if scenario calculator per station and portfolio
  - [ ] Simulate competitive responses in each station's market
  - [ ] Project revenue/volume impacts by station and cumulative
  - [ ] Generate simulation reports with charts per station and portfolio overview
  - [ ] Add coordinated multi-station pricing strategy simulations

- [ ] Task 6: Create station-aware opportunity API endpoints (AC: 1-8)
  - [ ] GET /api/v1/stations/{numero}/opportunities/current - Active station opportunities
  - [ ] GET /api/v1/opportunities/portfolio/current - Portfolio opportunities
  - [ ] GET /api/v1/stations/{numero}/opportunities/history - Station opportunity history
  - [ ] GET /api/v1/opportunities/portfolio/history - Portfolio opportunity history
  - [ ] POST /api/v1/stations/{numero}/opportunities/simulate - Run station simulation
  - [ ] POST /api/v1/opportunities/portfolio/simulate - Run portfolio simulation
  - [ ] GET /api/v1/opportunities/report/weekly - Weekly summary by station and portfolio
  - [ ] PUT /api/v1/opportunities/{id}/action - Record action taken with station context
  - [ ] GET /api/v1/opportunities/patterns/cross-station - Cross-station opportunity patterns

- [ ] Task 7: Build station-aware opportunity dashboard UI (AC: 1, 2, 5, 6, 7, 8)
  - [ ] Create opportunity cards component with station identification
  - [ ] Build impact visualization charts per station and portfolio
  - [ ] Design simulation interface with station selection and portfolio scenarios
  - [ ] Add opportunity history timeline filterable by station
  - [ ] Create weekly report viewer with station breakdowns
  - [ ] Implement action tracking UI with station context
  - [ ] Build cross-station opportunity comparison views
  - [ ] Add portfolio optimization strategy dashboard

- [ ] Task 8: Write comprehensive tests for multi-station architecture (AC: 1-8)
  - [ ] Unit tests for OpportunityDetectionService with station parameters
  - [ ] Test revenue impact calculations per station and portfolio
  - [ ] Verify ceiling/floor detection logic by station market
  - [ ] Feature tests for station-aware opportunity API endpoints
  - [ ] Test simulation accuracy for individual stations and portfolio scenarios
  - [ ] Validate report generation with station context
  - [ ] Test cross-station opportunity pattern detection
  - [ ] Test portfolio optimization recommendations

## Dev Notes

### Competitive Analysis Data

- Use PriceChange model for competitor pricing
- Station model for identifying competitors by radius
- Calculate relative price positions
- Track price movements over time windows
- Consider all fuel types: 'regular', 'premium', 'diesel'
  [Source: architecture/data-models.md#pricechange-model]

### Revenue Calculation Factors

- Historical sales volume data (if available)
- Price elasticity estimates
- Competitor distance weighting
- Time-of-day patterns
- Seasonal demand variations
- Local market conditions

### File Locations

Based on project structure:

- Services: apps/api/app/Services/OpportunityDetectionService.php, PriceSimulationService.php
- Models: apps/api/app/Models/Opportunity.php, OpportunityAction.php
- Controllers: apps/api/app/Http/Controllers/Api/OpportunityController.php
- Jobs: apps/api/app/Jobs/WeeklyOpportunityReportJob.php
- UI Components: apps/web/src/components/features/opportunities/
- Dashboard: apps/web/src/pages/optimization/opportunities/
  [Source: architecture/unified-project-structure.md]

### Multi-Station Opportunity Detection Logic

- Compare each station's prices to station-specific competitor average
- Identify gaps where station prices could increase
- Consider station-specific customer loyalty threshold based on market dynamics
- Factor in brand positioning per station market
- Account for individual station location advantages
- Weight by competitor proximity to each specific station
- Compare opportunity patterns across user's station portfolio
- Identify stations with consistently better/worse opportunity capture rates

### Multi-Station Simulation Parameters

- Price adjustment range (min/max) per station market
- Station-specific competitor response probability
- Volume impact elasticity by station characteristics
- Time horizon (days/weeks) with station market considerations
- Confidence levels based on station-specific data quality
- Market condition scenarios per station region
- Cross-station coordination effects
- Portfolio-level optimization constraints and objectives

### Multi-Station Performance Optimization

- Cache station opportunity calculations: `opportunities:{station_numero}:{user_id}:{date}`
- Cache portfolio opportunities: `opportunities:portfolio:{user_id}:{date}`
- Cache cross-station patterns: `patterns:{user_id}:{station_list}:{date}`
- Queue heavy simulation computations with station context
- Pre-calculate common scenarios per station and portfolio
- Index price_changes table for efficient queries by station_numero
- Use Redis for temporary simulation data with station partitioning
- Batch process multiple stations for opportunity detection efficiency
  [Source: architecture/coding-standards.md#critical-fullstack-rules]

## Testing

### Testing Standards from Architecture

- Backend unit tests: apps/api/tests/Unit/
- Test opportunity detection algorithms
- Verify revenue impact calculations
- Mock market scenarios in tests
- Feature tests: apps/api/tests/Feature/
- Test API endpoints with various data sets
- Frontend tests: apps/web/tests/unit/
- Test simulation UI interactions
- Verify chart data rendering
  [Source: architecture/testing-strategy.md]

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-31 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
