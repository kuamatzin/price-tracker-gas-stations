# Story 5.2: Automated Price Monitoring

## Status

Draft

## Story

**As a** station owner,
**I want** automatic monitoring of competitor price changes,
**so that** I'm immediately informed of market movements.

## Acceptance Criteria

1. System checks for price changes after each scraper run completion
2. Significant changes (>5% or user threshold) trigger immediate alerts
3. Alerts include context: which competitor, fuel type, old/new price, percentage change
4. Daily summary compiles all changes in user's area at configured time
5. Smart grouping prevents alert fatigue (combines multiple small changes)
6. Opt-in for regional alerts beyond immediate competitor radius

## Tasks / Subtasks

- [ ] Task 1: Implement price change detection system (AC: 1, 2)
  - [ ] Create PriceMonitoringService in apps/api/app/Services/
  - [ ] Implement change detection after scraper completion
  - [ ] Calculate percentage changes for all fuel types
  - [ ] Compare against user-defined thresholds
  - [ ] Identify significant price movements

- [ ] Task 2: Build immediate alert triggering (AC: 2, 3)
  - [ ] Create PriceAlertJob for processing detected changes
  - [ ] Implement competitor identification logic
  - [ ] Format alert messages with complete context
  - [ ] Dispatch immediate notifications via Telegram
  - [ ] Handle alert delivery failures with retry logic

- [ ] Task 3: Develop daily summary system (AC: 4)
  - [ ] Create DailySummaryJob scheduled job
  - [ ] Aggregate all price changes by user's area
  - [ ] Group changes by station and fuel type
  - [ ] Format summary in readable digest format
  - [ ] Schedule delivery at user-configured times

- [ ] Task 4: Implement smart alert grouping (AC: 5)
  - [ ] Create alert batching logic for multiple changes
  - [ ] Define rules for combining similar changes
  - [ ] Implement time-window based grouping (e.g., 15-minute windows)
  - [ ] Prevent duplicate alerts for same change
  - [ ] Add cooldown periods between alerts

- [ ] Task 5: Add regional alert subscription (AC: 6)
  - [ ] Extend User notification_preferences for regional settings
  - [ ] Create RegionalAlertService for broader monitoring
  - [ ] Add municipality and state-level alert options
  - [ ] Implement opt-in/opt-out mechanism via API
  - [ ] Filter regional alerts by significance thresholds

- [ ] Task 6: Create monitoring configuration API (AC: 1, 2, 4, 6)
  - [ ] PUT /api/v1/users/monitoring-preferences
  - [ ] GET /api/v1/monitoring/status - Current monitoring status
  - [ ] POST /api/v1/monitoring/test - Test alert delivery
  - [ ] GET /api/v1/monitoring/history - Recent price changes

- [ ] Task 7: Build monitoring dashboard components (AC: 1-6)
  - [ ] Create price monitoring settings page
  - [ ] Add threshold configuration UI
  - [ ] Build alert history viewer component
  - [ ] Display recent competitor movements
  - [ ] Show regional price trends visualization

- [ ] Task 8: Write comprehensive tests (AC: 1-6)
  - [ ] Unit tests for PriceMonitoringService
  - [ ] Feature tests for monitoring API endpoints
  - [ ] Integration tests for alert delivery
  - [ ] Test smart grouping logic
  - [ ] Verify daily summary generation

## Dev Notes

### User Notification Preferences

The User model includes notification_preferences (jsonb) with:

- price_change_threshold: number (percentage)
- alert_radius_km: number
- fuel_types: FuelType[]
- daily_summary_time?: string (HH:mm format)
- telegram_enabled: boolean
- email_enabled: boolean
  [Source: architecture/data-models.md#user-model]

### Scraper Integration

Price monitoring triggers after scraper completion:

- Scraper runs are managed by Laravel Scheduler
- Process manager: Supervisor 4.2+ keeps scraper running
- Queue system: Laravel Queues with Redis driver
- Changes detected by comparing PriceChange records
  [Source: architecture/tech-stack.md#technology-stack-table]

### File Locations

Based on project structure:

- Services: apps/api/app/Services/PriceMonitoringService.php, RegionalAlertService.php
- Jobs: apps/api/app/Jobs/PriceAlertJob.php, DailySummaryJob.php
- Controllers: apps/api/app/Http/Controllers/Api/MonitoringController.php
- Dashboard UI: apps/web/src/pages/monitoring/
- Components: apps/web/src/components/features/monitoring/
  [Source: architecture/unified-project-structure.md]

### Telegram Integration

- Bot Framework: BotMan 2.8+ for Laravel
- User's telegram_chat_id stored in User model
- Notifications sent via BotMan's messaging methods
- Handle delivery failures with exponential backoff
  [Source: architecture/tech-stack.md#technology-stack-table]

### Performance Considerations

- Cache monitoring status: `monitoring:{user_id}:status`
- Batch database queries for efficiency
- Use Redis for temporary alert grouping windows
- Queue all notification dispatches
- Implement rate limiting for alert frequency
  [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Price Change Detection

- PriceChange model stores only changes, not daily snapshots
- Compare detected_at timestamps to find new changes
- Calculate percentage: ((new - old) / old) \* 100
- Group by station_numero and fuel_type
  [Source: architecture/data-models.md#pricechange-model]

## Testing

### Testing Standards from Architecture

- Backend tests: apps/api/tests/Unit/ and Feature/
- Test monitoring service logic in Unit/PriceMonitoringServiceTest.php
- Test API endpoints in Feature/MonitoringApiTest.php
- Mock Telegram notifications in tests
- Frontend components: apps/web/tests/unit/
- Test threshold configuration UI components
- Verify alert history display logic
  [Source: architecture/testing-strategy.md]

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-31 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
