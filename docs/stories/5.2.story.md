# Story 5.2: Automated Price Monitoring

## Status

Draft

## Story

**As a** multi-station owner,
**I want** automatic monitoring of competitor price changes for each of my stations,
**so that** I'm immediately informed of market movements affecting any of my locations.

## Acceptance Criteria

1. System checks for price changes per station after each scraper run completion
2. Significant changes (>5% or station-specific threshold) trigger immediate alerts
3. Alerts include station context: which station affected, competitor details, fuel type, old/new price, percentage change
4. Daily summary compiles all changes for each user's station at configured time
5. Smart grouping prevents alert fatigue per station (combines multiple small changes)
6. Opt-in for regional alerts beyond each station's immediate competitor radius
7. Different monitoring thresholds can be configured per station
8. Station name/numero included in all alert messages

## Tasks / Subtasks

- [ ] Task 1: Implement station-aware price change detection system (AC: 1, 2, 7)
  - [ ] Create StationPriceMonitoringService in apps/api/app/Services/
  - [ ] Accept station_numero as parameter for monitoring
  - [ ] Implement change detection per station after scraper completion
  - [ ] Calculate percentage changes for all fuel types per station
  - [ ] Compare against station-specific thresholds
  - [ ] Identify significant price movements for each station
  - [ ] Process multiple stations in parallel

- [ ] Task 2: Build station-aware immediate alert triggering (AC: 2, 3, 8)
  - [ ] Create StationPriceAlertJob for processing detected changes
  - [ ] Include station_numero in job payload
  - [ ] Implement competitor identification relative to affected station
  - [ ] Format alert messages with station name and complete context
  - [ ] Dispatch immediate notifications via Telegram with station identifier
  - [ ] Handle alert delivery failures with retry logic per station

- [ ] Task 3: Develop station-aware daily summary system (AC: 4, 8)
  - [ ] Create StationDailySummaryJob scheduled job
  - [ ] Aggregate all price changes per user's station
  - [ ] Group changes by user station, then by competitor and fuel type
  - [ ] Format summary with station headers in readable digest format
  - [ ] Schedule delivery at user-configured times
  - [ ] Include station performance comparison in summary

- [ ] Task 4: Implement station-aware smart alert grouping (AC: 5)
  - [ ] Create alert batching logic per station
  - [ ] Define rules for combining similar changes within same station area
  - [ ] Implement time-window based grouping per station (e.g., 15-minute windows)
  - [ ] Prevent duplicate alerts for same change at same station
  - [ ] Add cooldown periods between alerts per station
  - [ ] Maintain separate grouping windows for each station

- [ ] Task 5: Add station-specific regional alert subscription (AC: 6, 7)
  - [ ] Extend notification_preferences for per-station regional settings
  - [ ] Create StationRegionalAlertService for broader monitoring
  - [ ] Add municipality and state-level alert options per station
  - [ ] Implement opt-in/opt-out mechanism per station via API
  - [ ] Filter regional alerts by station-specific significance thresholds
  - [ ] Store preferences with station_numero reference

- [ ] Task 6: Create station-aware monitoring configuration API (AC: 1, 2, 4, 6, 7)
  - [ ] PUT /api/v1/stations/{numero}/monitoring-preferences - Per-station preferences
  - [ ] GET /api/v1/stations/{numero}/monitoring/status - Station monitoring status
  - [ ] GET /api/v1/monitoring/status - All stations monitoring overview
  - [ ] POST /api/v1/stations/{numero}/monitoring/test - Test alert for specific station
  - [ ] GET /api/v1/stations/{numero}/monitoring/history - Station's recent price changes
  - [ ] Add station_numero validation middleware

- [ ] Task 7: Build station-aware monitoring dashboard components (AC: 1-8)
  - [ ] Create station-specific price monitoring settings page
  - [ ] Add per-station threshold configuration UI
  - [ ] Build alert history viewer with station filters
  - [ ] Display recent competitor movements per station
  - [ ] Show regional price trends per station area
  - [ ] Add station selector for monitoring configuration
  - [ ] Create multi-station monitoring overview dashboard

- [ ] Task 8: Write comprehensive tests (AC: 1-8)
  - [ ] Unit tests for StationPriceMonitoringService
  - [ ] Test multi-station monitoring scenarios
  - [ ] Feature tests for station-specific monitoring API endpoints
  - [ ] Integration tests for per-station alert delivery
  - [ ] Test smart grouping logic per station
  - [ ] Verify daily summary generation with multiple stations
  - [ ] Test station access validation

## Dev Notes

### User Notification Preferences

The User model includes notification_preferences (jsonb) with:

- price_change_threshold: number (percentage)
- alert_radius_km: number
- fuel_types: FuelType[]
- daily_summary_time?: string (HH:mm format)
- telegram_enabled: boolean
- email_enabled: boolean
  [Source: architecture/data-models.md#user-model]

### Scraper Integration

Price monitoring triggers after scraper completion:

- Scraper runs are managed by Laravel Scheduler
- Process manager: Supervisor 4.2+ keeps scraper running
- Queue system: Laravel Queues with Redis driver
- Changes detected by comparing PriceChange records
  [Source: architecture/tech-stack.md#technology-stack-table]

### File Locations

Based on project structure:

- Services: apps/api/app/Services/PriceMonitoringService.php, RegionalAlertService.php
- Jobs: apps/api/app/Jobs/PriceAlertJob.php, DailySummaryJob.php
- Controllers: apps/api/app/Http/Controllers/Api/MonitoringController.php
- Dashboard UI: apps/web/src/pages/monitoring/
- Components: apps/web/src/components/features/monitoring/
  [Source: architecture/unified-project-structure.md]

### Telegram Integration

- Bot Framework: BotMan 2.8+ for Laravel
- User's telegram_chat_id stored in User model
- Notifications sent via BotMan's messaging methods
- Handle delivery failures with exponential backoff
  [Source: architecture/tech-stack.md#technology-stack-table]

### Performance Considerations

- Cache monitoring status: `monitoring:{user_id}:status`
- Batch database queries for efficiency
- Use Redis for temporary alert grouping windows
- Queue all notification dispatches
- Implement rate limiting for alert frequency
  [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Price Change Detection

- PriceChange model stores only changes, not daily snapshots
- Compare detected_at timestamps to find new changes
- Calculate percentage: ((new - old) / old) \* 100
- Group by station_numero and fuel_type
  [Source: architecture/data-models.md#pricechange-model]

## Testing

### Testing Standards from Architecture

- Backend tests: apps/api/tests/Unit/ and Feature/
- Test monitoring service logic in Unit/PriceMonitoringServiceTest.php
- Test API endpoints in Feature/MonitoringApiTest.php
- Mock Telegram notifications in tests
- Frontend components: apps/web/tests/unit/
- Test threshold configuration UI components
- Verify alert history display logic
  [Source: architecture/testing-strategy.md]

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-31 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
