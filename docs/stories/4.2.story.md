# Story 4.2: Authentication & Dashboard Layout

## Status

Ready for development

## Story

**As a** dashboard user,
**I want** to securely log in and navigate the dashboard,
**so that** I can access my personalized pricing data.

## Acceptance Criteria

1. Login page with email/password form and "Remember Me" functionality
2. JWT token storage in localStorage with auto-refresh before expiration
3. Dashboard layout with responsive navigation (hamburger menu on mobile)
4. User profile dropdown with station name, logout option, and settings link
5. Persistent sidebar on desktop, bottom navigation on mobile
6. Loading states and error boundaries for graceful error handling

## Tasks / Subtasks

- [x] **Task 1: Create Login Page Component** (AC: 1)
  - [x] Create src/pages/auth/Login.tsx with form layout
  - [x] Implement email/password fields with validation
  - [x] Add "Remember Me" checkbox functionality
  - [x] Create "Forgot Password" link
  - [x] Style with Shadcn/ui Form components
  - [x] Add loading state during authentication
  - [x] Handle and display authentication errors

- [x] **Task 2: Implement Authentication Store** (AC: 2)
  - [x] Create src/stores/authStore.ts with Zustand
  - [x] Store user profile, token, and expiration
  - [x] Implement login action calling API
  - [x] Implement logout action with token cleanup
  - [x] Add token persistence to localStorage
  - [x] Create isAuthenticated computed property
  - [x] Handle "Remember Me" preference

- [x] **Task 3: Set Up Token Management** (AC: 2)
  - [x] Implement token storage in localStorage
  - [x] Create token refresh mechanism
  - [x] Set up refresh timer before expiration
  - [x] Handle token expiration gracefully
  - [x] Update Axios interceptors for auto-refresh
  - [x] Clear tokens on logout
  - [x] Handle concurrent refresh attempts

- [x] **Task 4: Create Dashboard Layout Component** (AC: 3, 5)
  - [x] Create src/components/layout/DashboardLayout.tsx
  - [x] Implement desktop sidebar navigation
  - [x] Create mobile bottom navigation bar
  - [x] Add responsive breakpoint detection
  - [x] Implement layout transition animations
  - [x] Create content area with proper spacing
  - [x] Add breadcrumb navigation

- [ ] **Task 5: Build Sidebar Navigation** (AC: 5)
  - [ ] Create src/components/layout/Sidebar.tsx
  - [ ] Add navigation menu items with icons
  - [ ] Implement active route highlighting
  - [ ] Add collapsible sidebar for desktop
  - [ ] Create station selector in sidebar
  - [ ] Add quick stats widget
  - [ ] Implement keyboard navigation

- [ ] **Task 6: Implement Mobile Navigation** (AC: 3, 5)
  - [ ] Create src/components/layout/MobileNav.tsx
  - [ ] Build bottom tab navigation
  - [ ] Add hamburger menu for additional options
  - [ ] Implement slide-out drawer for menu
  - [ ] Create mobile-optimized header
  - [ ] Add gesture support for navigation
  - [ ] Handle safe area insets

- [ ] **Task 7: Create User Profile Dropdown** (AC: 4)
  - [ ] Create src/components/layout/UserMenu.tsx
  - [ ] Display user name and station
  - [ ] Add avatar or initials display
  - [ ] Implement dropdown menu with options
  - [ ] Add logout functionality
  - [ ] Create settings navigation link
  - [ ] Add subscription tier indicator

- [ ] **Task 8: Implement Loading States** (AC: 6)
  - [ ] Create src/components/common/LoadingScreen.tsx
  - [ ] Build skeleton loaders for content
  - [ ] Add spinner components
  - [ ] Create progress indicators
  - [ ] Implement loading overlays
  - [ ] Add suspense boundaries
  - [ ] Create shimmer effects

- [ ] **Task 9: Set Up Error Boundaries** (AC: 6)
  - [ ] Create src/components/common/ErrorBoundary.tsx
  - [ ] Implement error catching and logging
  - [ ] Create fallback UI components
  - [ ] Add error recovery options
  - [ ] Integrate with Sentry reporting
  - [ ] Create user-friendly error messages
  - [ ] Add retry mechanisms

- [ ] **Task 10: Build Authentication Service** (AC: 1, 2)
  - [ ] Create src/services/auth.service.ts
  - [ ] Implement login API call
  - [ ] Implement logout API call
  - [ ] Add token refresh API call
  - [ ] Create password reset methods
  - [ ] Handle API error responses
  - [ ] Add request/response logging

- [ ] **Task 11: Create Protected Dashboard Pages** (AC: 3)
  - [ ] Update src/pages/Dashboard.tsx with layout
  - [ ] Create dashboard home content
  - [ ] Add quick action cards
  - [ ] Implement recent activity feed
  - [ ] Add price summary widgets
  - [ ] Create alert notifications area
  - [ ] Build responsive grid layout

- [ ] **Task 12: Implement Route Guards** (AC: 2, 6)
  - [ ] Update ProtectedRoute component
  - [ ] Add authentication checks
  - [ ] Implement redirect logic
  - [ ] Handle loading states
  - [ ] Add role-based access control
  - [ ] Create route transition animations
  - [ ] Handle deep linking

- [ ] **Task 13: Write Unit Tests** (AC: All)
  - [ ] Test login form validation
  - [ ] Test authentication store actions
  - [ ] Test token management logic
  - [ ] Test layout responsiveness
  - [ ] Test navigation components
  - [ ] Test error boundaries
  - [ ] Test loading states

- [ ] **Task 14: Write Integration Tests** (AC: 1, 2)
  - [ ] Test complete login flow
  - [ ] Test token refresh mechanism
  - [ ] Test logout functionality
  - [ ] Test protected route access
  - [ ] Test API error handling
  - [ ] Test remember me functionality

## Dev Notes

### Previous Story Context

[Source: Story 4.1]

Story 4.1 established:

- React app structure with TypeScript and Vite
- React Router configuration with routes
- Zustand state management setup
- Shadcn/ui component library integration
- Axios API client with interceptors
- Responsive breakpoints (320px, 768px, 1024px)

### Authentication API Endpoints

[Source: apps/api/routes/api/v1.php]

Available auth endpoints:

```
POST /api/v1/auth/login         - User login
POST /api/v1/auth/logout        - User logout
POST /api/v1/auth/refresh       - Token refresh
POST /api/v1/auth/register      - User registration
POST /api/v1/auth/forgot-password - Password reset request
POST /api/v1/auth/reset-password  - Password reset confirmation
```

### Login Response Structure

[Source: apps/api/app/Http/Controllers/Auth/LoginController.php]

```json
{
  "token": "string",
  "expires_at": "2024-01-01T00:00:00Z",
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "User Name",
    "station": {
      "numero": "E12345",
      "nombre": "Pemex Centro",
      "municipio": "Guadalajara",
      "entidad": "Jalisco"
    },
    "subscription_tier": "premium"
  }
}
```

### Token Configuration

[Source: apps/api/config/sanctum.php]

- **Expiration**: 1440 minutes (24 hours)
- **Auto-revoke**: Previous tokens revoked on new login
- **Abilities**: Based on subscription tier

### Authentication Store Structure

[Source: docs/architecture/frontend-architecture.md]

```typescript
interface AuthState {
  user: User | null;
  token: string | null;
  expiresAt: string | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  rememberMe: boolean;

  // Actions
  login: (email: string, password: string, remember: boolean) => Promise<void>;
  logout: () => Promise<void>;
  refresh: () => Promise<void>;
  checkAuth: () => void;
}
```

### Protected Route Pattern

[Source: docs/architecture/frontend-architecture.md]

```typescript
export const ProtectedRoute = () => {
  const { isAuthenticated, isLoading } = useAuthStore();

  if (isLoading) {
    return <LoadingScreen />;
  }

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }

  return <Outlet />;
};
```

### Dashboard Layout Structure

Layout component hierarchy:

```
DashboardLayout
├── Header
│   ├── Logo
│   ├── Search (desktop only)
│   └── UserMenu
├── Sidebar (desktop)
│   ├── Navigation
│   ├── StationSelector
│   └── QuickStats
├── MobileNav (mobile)
│   └── TabBar
└── MainContent
    ├── Breadcrumbs
    └── <Outlet /> (page content)
```

### Responsive Breakpoints

[Source: Story 4.1 - AC 6]

```css
/* Mobile First Approach */
@media (min-width: 320px) /* Mobile */ @media (min-width: 768px) /* Tablet/Desktop transition */ @media (min-width: 1024px); /* Desktop */
```

### Navigation Structure

Main navigation items:

```typescript
const navItems = [
  { path: "/dashboard", label: "Inicio", icon: "Home" },
  { path: "/prices", label: "Precios", icon: "DollarSign" },
  { path: "/analytics", label: "Análisis", icon: "TrendingUp" },
  { path: "/alerts", label: "Alertas", icon: "Bell" },
  { path: "/settings", label: "Configuración", icon: "Settings" },
];
```

### Error Handling

[Source: apps/api/app/Http/Controllers/Auth/LoginController.php]

Login error responses:

- **401**: Invalid credentials
- **422**: Validation errors
- **423**: Account locked (too many attempts)
- **500**: Server error

Error display pattern:

```typescript
interface AuthError {
  code: string;
  message: string;
  field?: string; // For field-specific errors
}
```

### Token Storage Strategy

LocalStorage implementation:

```typescript
const TOKEN_KEY = "fuelintel_token";
const TOKEN_EXPIRY_KEY = "fuelintel_token_expiry";
const USER_KEY = "fuelintel_user";

// Store on login
localStorage.setItem(TOKEN_KEY, token);
localStorage.setItem(TOKEN_EXPIRY_KEY, expiresAt);
localStorage.setItem(USER_KEY, JSON.stringify(user));

// Clear on logout
localStorage.removeItem(TOKEN_KEY);
localStorage.removeItem(TOKEN_EXPIRY_KEY);
localStorage.removeItem(USER_KEY);
```

### Token Refresh Logic

```typescript
// Check token expiry and refresh if needed
const checkTokenExpiry = () => {
  const expiresAt = localStorage.getItem(TOKEN_EXPIRY_KEY);
  if (!expiresAt) return;

  const expiryTime = new Date(expiresAt).getTime();
  const currentTime = Date.now();
  const timeUntilExpiry = expiryTime - currentTime;

  // Refresh if less than 5 minutes remaining
  if (timeUntilExpiry < 5 * 60 * 1000 && timeUntilExpiry > 0) {
    refreshToken();
  }
};

// Set up refresh timer
useEffect(() => {
  const interval = setInterval(checkTokenExpiry, 60000); // Check every minute
  return () => clearInterval(interval);
}, []);
```

### Loading States

Loading state patterns:

```typescript
// Page-level loading
<LoadingScreen message="Cargando dashboard..." />

// Component-level loading
<Skeleton className="h-32 w-full" />

// Button loading
<Button disabled={isLoading}>
  {isLoading && <Spinner className="mr-2" />}
  Iniciar Sesión
</Button>
```

### Error Boundary Implementation

```typescript
class ErrorBoundary extends Component {
  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    // Log to Sentry
    Sentry.captureException(error, { contexts: { react: errorInfo } });
  }

  render() {
    if (this.state.hasError) {
      return <ErrorFallback onReset={this.resetError} />;
    }
    return this.props.children;
  }
}
```

### Component File Structure

[Source: Story 4.1]

```
src/
├── pages/
│   └── auth/
│       └── Login.tsx
├── components/
│   └── layout/
│       ├── DashboardLayout.tsx
│       ├── Sidebar.tsx
│       ├── MobileNav.tsx
│       ├── Header.tsx
│       └── UserMenu.tsx
├── stores/
│   └── authStore.ts
└── services/
    └── auth.service.ts
```

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

- **Framework**: Vitest with React Testing Library
- **Coverage Target**: 80% for authentication components
- **Mock Strategy**: MSW for API mocking
- **Test Location**: apps/web/tests/

### Specific Test Cases

1. Test login form submission with valid credentials
2. Test login form validation errors
3. Test remember me functionality
4. Test token storage and retrieval
5. Test token refresh mechanism
6. Test logout clears all auth data
7. Test protected route redirects
8. Test responsive layout changes
9. Test error boundary catches errors
10. Test loading states display correctly
11. Test user menu dropdown functionality
12. Test navigation active state

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-30 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
