# Story 3.2: Price Query Commands

## Status

Draft

## Story

**As a** bot user,
**I want** to check current prices using simple commands,
**so that** I can get pricing information without complex interactions.

## Acceptance Criteria

1. /precios returns current prices for user's registered station location
2. /precios_competencia shows competitor prices within configured radius
3. /precio_promedio displays average prices for user's municipio
4. /precio [station_name] searches and returns prices for specific station
5. Commands support fuel type filters (/precios premium, /precios diesel)
6. Response formatted as easy-to-read table with emoji indicators for price changes (ğŸ“ˆğŸ“‰)

## Tasks / Subtasks

- [ ] **Task 1: Create price query command classes** (AC: 1, 5)
  - [ ] Create PreciosCommand class extending BaseCommand from Story 3.1
  - [ ] Implement fuel type parsing from command arguments (premium, diesel, regular)
  - [ ] Retrieve user's registered station from telegram_users table
  - [ ] Query current prices via PricingService
  - [ ] Format response with price table and emoji indicators

- [ ] **Task 2: Implement competitor prices command** (AC: 2)
  - [ ] Create PreciosCompetenciaCommand class
  - [ ] Get user's configured radius from session/preferences
  - [ ] Use PricingService->findNearbyStations() with user's station coordinates
  - [ ] Sort results by distance from user's station
  - [ ] Format as table showing station name, distance, and prices

- [ ] **Task 3: Build average price command** (AC: 3)
  - [ ] Create PrecioPromedioCommand class
  - [ ] Query user's municipio_id from their registered station
  - [ ] Calculate average prices per fuel type for the municipio
  - [ ] Include comparison with user's station prices
  - [ ] Show percentage difference from average

- [ ] **Task 4: Implement station search command** (AC: 4)
  - [ ] Create PrecioCommand class with station name parameter
  - [ ] Implement fuzzy search for station names using Levenshtein distance
  - [ ] Handle multiple matches with inline keyboard selection
  - [ ] Query and display prices for selected station
  - [ ] Cache search results in Redis for 5 minutes

- [ ] **Task 5: Add price change indicators** (AC: 6)
  - [ ] Query price history for last 24 hours
  - [ ] Calculate price changes for each fuel type
  - [ ] Add emoji indicators: ğŸ“ˆ (increase), ğŸ“‰ (decrease), â¡ï¸ (no change)
  - [ ] Include percentage change in response
  - [ ] Format prices with proper peso symbol and decimals

- [ ] **Task 6: Create PricingService for Telegram** (AC: 1, 2, 3)
  - [ ] Create app/Services/Telegram/PricingService.php
  - [ ] Implement getCurrentStationPrices() method
  - [ ] Implement getNearbyCompetitorPrices() method
  - [ ] Implement getMunicipioPriceAverages() method
  - [ ] Add Redis caching with 5-minute TTL

- [ ] **Task 7: Extend TelegramController webhook handler** (AC: All)
  - [ ] Register new price commands in telegram config
  - [ ] Add command routing for price queries
  - [ ] Implement typing indicator during price lookups
  - [ ] Handle command parameters and fuel type filters
  - [ ] Add error handling for missing station registration

- [ ] **Task 8: Create response formatters** (AC: 6)
  - [ ] Build TableFormatter class for price tables
  - [ ] Implement markdown table generation
  - [ ] Add emoji indicator logic based on price changes
  - [ ] Format currency with 2 decimal places
  - [ ] Support multiple fuel types in single table

- [ ] **Task 9: Add caching layer** (AC: All)
  - [ ] Cache current prices with key pattern: `telegram:prices:{station_numero}:{fuel_type}`
  - [ ] Cache municipio averages: `telegram:avg:{municipio_id}:{fuel_type}`
  - [ ] Cache nearby stations: `telegram:nearby:{lat}:{lng}:{radius}`
  - [ ] Set appropriate TTLs (5 minutes for prices, 15 minutes for averages)
  - [ ] Implement cache invalidation on price updates

- [ ] **Task 10: Write unit tests** (AC: All)
  - [ ] Test PreciosCommand with various fuel type parameters
  - [ ] Test PreciosCompetenciaCommand with different radius values
  - [ ] Test PrecioPromedioCommand calculations
  - [ ] Test station search with fuzzy matching
  - [ ] Test price change indicator logic
  - [ ] Test cache key generation and TTLs

- [ ] **Task 11: Write integration tests** (AC: All)
  - [ ] Test complete command flow from webhook to response
  - [ ] Test with registered and unregistered users
  - [ ] Test error scenarios (no station, API timeout)
  - [ ] Test concurrent command execution
  - [ ] Verify Redis session management

## Dev Notes

### Previous Story Context

[Source: Story 3.1]

Story 3.1 established the Telegram bot foundation with:

- BaseCommand abstract class for all commands
- TelegramController webhook handler
- SessionManager for maintaining conversation state
- TranslationService for multi-language support
- Command routing and registration system

### Data Models

[Source: architecture/data-models.md]

**Station Model:**

```typescript
interface Station {
  numero: string; // Primary key (government permit number)
  nombre: string; // Station name
  direccion: string; // Physical address
  lat: number; // Latitude coordinate
  lng: number; // Longitude coordinate
  entidad_id: number; // State/entity ID
  municipio_id: number; // Municipality ID
  brand?: string; // Station brand (Pemex, Shell, etc.)
  is_active: boolean; // Whether station is currently operating
}
```

**PriceChange Model:**

```typescript
type FuelType = "regular" | "premium" | "diesel";

interface PriceChange {
  id: number;
  station_numero: string;
  fuel_type: FuelType;
  subproducto: string; // Original government fuel description
  price: number; // Price in MXN
  changed_at: string; // When price changed at station
  detected_at: string; // When scraper detected the change
}
```

**User Model Extension:**

```typescript
interface User {
  telegram_chat_id?: string; // For bot integration
  api_rate_limit: number; // Based on subscription tier
}
```

### API Endpoints

[Source: architecture/api-specification.md]

The bot commands will internally use these existing API endpoints:

- `GET /prices/current` - Get current prices with filters
  - Parameters: `entidad_id`, `municipio_id`, `fuel_type`
  - Authentication: Bearer token required

- `GET /prices/nearby` - Get nearby station prices
  - Parameters: `lat`, `lng`, `radius_km` (default: 5)
  - Returns stations sorted by distance

- `GET /prices/history/{station_numero}` - Get price history
  - Parameters: `days` (default: 7), `fuel_type`
  - Used for calculating price change indicators

### File Structure

[Source: architecture/unified-project-structure.md]

New files should be created in:

```
apps/api/app/
â”œâ”€â”€ Telegram/
â”‚   â””â”€â”€ Commands/           # New price command classes
â”‚       â”œâ”€â”€ PreciosCommand.php
â”‚       â”œâ”€â”€ PreciosCompetenciaCommand.php
â”‚       â”œâ”€â”€ PrecioPromedioCommand.php
â”‚       â””â”€â”€ PrecioCommand.php
â”œâ”€â”€ Services/
â”‚   â””â”€â”€ Telegram/
â”‚       â”œâ”€â”€ PricingService.php    # Price query service
â”‚       â””â”€â”€ TableFormatter.php    # Response formatting
â””â”€â”€ tests/
    â”œâ”€â”€ Unit/
    â”‚   â””â”€â”€ Telegram/
    â”‚       â””â”€â”€ Commands/         # Command unit tests
    â””â”€â”€ Feature/
        â””â”€â”€ Telegram/
            â””â”€â”€ PriceCommandsTest.php
```

### Service Layer Implementation

[Source: architecture/backend-architecture.md]

Follow the repository pattern:

```php
// app/Services/Telegram/PricingService.php
class PricingService
{
    private PriceRepository $priceRepository;

    public function getCurrentStationPrices(string $stationNumero, ?string $fuelType = null)
    {
        $cacheKey = "telegram:prices:{$stationNumero}:{$fuelType}";
        return Cache::remember($cacheKey, 300, function () {
            // Implementation
        });
    }
}
```

### Redis Caching Strategy

[Source: architecture/backend-architecture.md#caching-strategy]

Cache key patterns:

- `telegram:prices:{station_numero}:{fuel_type}` - Current prices
- `telegram:avg:{municipio_id}:{fuel_type}` - Municipality averages
- `telegram:nearby:{lat}:{lng}:{radius}` - Nearby stations
- Use 300 second (5 minute) TTL for price data

### Command Configuration

[Source: Story 3.1 implementation]

Register commands in `config/telegram.php`:

```php
'commands' => [
    // Existing commands from Story 3.1
    Telegram\Bot\Commands\StartCommand::class,
    App\Telegram\Commands\HelpCommand::class,
    App\Telegram\Commands\ComandosCommand::class,
    // New price commands
    App\Telegram\Commands\PreciosCommand::class,
    App\Telegram\Commands\PreciosCompetenciaCommand::class,
    App\Telegram\Commands\PrecioPromedioCommand::class,
    App\Telegram\Commands\PrecioCommand::class,
],
```

### Response Format Example

[Source: AC 6 requirements]

```
ğŸ’° Precios Actuales - Pemex Centro
ğŸ“ Av. Insurgentes #123

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tipo    â”‚ Precio â”‚ Cambio â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Regular â”‚ $22.85 â”‚ ğŸ“ˆ +2% â”‚
â”‚ Premium â”‚ $24.92 â”‚ â¡ï¸ 0%  â”‚
â”‚ Diesel  â”‚ $23.44 â”‚ ğŸ“‰ -1% â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ãšltima actualizaciÃ³n: hace 5 min
```

### Critical Implementation Notes

[Source: architecture/coding-standards.md#critical-fullstack-rules]

- Never make direct HTTP calls - use the service layer
- Use repository pattern, never raw SQL in controllers
- Only store price changes, never daily snapshots
- Always normalize government SubProducto to our 3 fuel types
- All heavy operations must be queued, never block API responses
- Rate limiting based on subscription tier (api_rate_limit field)

### Environment Variables

[Source: Story 3.1]

Telegram bot configuration is already set up with:

```env
TELEGRAM_BOT_TOKEN=xxx
TELEGRAM_WEBHOOK_URL=https://api.fuelintel.mx/telegram/webhook
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
```

## Testing

### Testing Standards

[Source: architecture/testing-strategy.md]

- Test file location: `apps/api/tests/`
- Unit tests in `tests/Unit/Telegram/Commands/`
- Feature tests in `tests/Feature/Telegram/`
- Use PHPUnit for all backend tests
- Mock external services (Telegram API, Redis)
- Test coverage minimum: 80%

### Specific Test Cases

1. Test /precios with registered user and all fuel types
2. Test /precios_competencia with various radius values
3. Test /precio_promedio calculations accuracy
4. Test /precio with fuzzy station name matching
5. Test fuel type filtering (premium, diesel, regular)
6. Test price change indicator logic (ğŸ“ˆğŸ“‰â¡ï¸)
7. Test response formatting with markdown tables
8. Test cache hit/miss scenarios
9. Test error handling for unregistered users
10. Test concurrent command execution
11. Verify session persistence across commands
12. Test rate limiting based on user tier

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-14 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
