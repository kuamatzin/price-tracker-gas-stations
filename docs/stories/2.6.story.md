# Story 2.6: API Documentation & Testing

## Status

Done

## Story

**As an** API consumer,
**I want** comprehensive documentation and testing tools,
**so that** I can integrate efficiently with the FuelIntel platform.

## Acceptance Criteria

1. OpenAPI/Swagger documentation auto-generated and accessible at /api/documentation
2. Postman collection exported with example requests for all endpoints
3. API versioning clearly documented with deprecation policy
4. Rate limit headers (X-RateLimit-Limit, X-RateLimit-Remaining) included in all responses
5. Comprehensive error messages with clear problem descriptions and solution hints
6. API health dashboard showing endpoint status and response times

## Tasks / Subtasks

- [x] **Task 1: Install and configure Swagger/OpenAPI** (AC: 1)
  - [x] Install L5-Swagger package: `composer require darkaonline/l5-swagger`
  - [x] Configure swagger.php with API metadata
  - [x] Set up auto-generation from annotations
  - [x] Configure UI theme and branding
  - [x] Set authentication scheme for Sanctum

- [x] **Task 2: Document all API endpoints** (AC: 1)
  - [x] Add OpenAPI annotations to all controllers
  - [x] Document request/response schemas
  - [x] Include example values for all fields
  - [x] Add authentication requirements
  - [x] Document query parameters and filters

- [x] **Task 3: Create Postman collection** (AC: 2)
  - [x] Export OpenAPI spec to Postman format
  - [x] Add environment variables (base_url, token)
  - [x] Create example requests for each endpoint
  - [x] Include pre-request scripts for auth
  - [x] Add test scripts for response validation

- [x] **Task 4: Implement API versioning** (AC: 3)
  - [x] Set up version routing (v1, v2)
  - [x] Create versioning middleware
  - [x] Document version differences
  - [x] Implement deprecation warnings
  - [x] Add sunset headers for deprecated endpoints

- [x] **Task 5: Add rate limiting headers** (AC: 4)
  - [x] Create RateLimitMiddleware
  - [x] Add headers to all responses
  - [x] Include retry-after for throttled requests
  - [x] Document rate limits per tier
  - [x] Track usage in Redis

- [x] **Task 6: Enhance error handling** (AC: 5)
  - [x] Create custom exception handlers
  - [x] Standardize error response format
  - [x] Add helpful error messages
  - [x] Include error codes for each scenario
  - [x] Translate errors to Spanish

- [x] **Task 7: Build API health dashboard** (AC: 6)
  - [x] Create StatusController for dashboard
  - [x] Track endpoint response times
  - [x] Monitor error rates per endpoint
  - [x] Display uptime statistics
  - [x] Add real-time updates via WebSocket

- [x] **Task 8: Create API testing suite** (AC: 1, 2)
  - [x] Write feature tests for all endpoints
  - [x] Test authentication flows
  - [x] Verify rate limiting works
  - [x] Test error scenarios
  - [x] Validate response formats

- [ ] **Task 9: Generate SDK examples** (AC: 1, 2)
  - [ ] Create PHP SDK example
  - [ ] Build JavaScript/TypeScript client
  - [ ] Add Python integration example
  - [ ] Document curl commands
  - [ ] Include authentication examples

- [ ] **Task 10: Create developer portal** (AC: 1, 3, 5)
  - [ ] Build documentation homepage
  - [ ] Add getting started guide
  - [ ] Include authentication tutorial
  - [ ] Create changelog page
  - [ ] Add API status page

- [ ] **Task 11: Set up monitoring and analytics** (AC: 6)
  - [ ] Track API usage metrics
  - [ ] Monitor popular endpoints
  - [ ] Log slow queries
  - [ ] Set up alerting for failures
  - [ ] Generate usage reports

## Dev Notes

### Previous Story Context

[Source: Epic 2, Stories 2.1-2.5]

- Story 2.1: Authentication endpoints with Sanctum
- Story 2.2: Current pricing endpoints
- Story 2.3: Historical data endpoints
- Story 2.4: Competitor analysis endpoints
- Story 2.5: Geographic aggregation endpoints

### OpenAPI Configuration

[Source: AC 1, L5-Swagger documentation]

**Swagger Configuration (config/l5-swagger.php):**

```php
return [
    'default' => 'default',
    'documentations' => [
        'default' => [
            'api' => [
                'title' => 'FuelIntel API Documentation',
                'version' => '1.0.0',
                'description' => 'REST API for Mexican fuel price intelligence',
                'contact' => [
                    'name' => 'FuelIntel Support',
                    'email' => 'api@fuelintel.mx'
                ],
                'license' => [
                    'name' => 'Proprietary',
                    'url' => 'https://fuelintel.mx/terms'
                ]
            ],
            'routes' => [
                'api' => 'api/documentation',
            ],
            'paths' => [
                'annotations' => [
                    base_path('app/Http/Controllers/Api'),
                ],
                'schemas' => [
                    base_path('app/Models'),
                ],
            ],
            'security' => [
                'sanctum' => [
                    'type' => 'http',
                    'description' => 'Laravel Sanctum token authentication',
                    'scheme' => 'bearer',
                    'bearerFormat' => 'token',
                ],
            ],
        ],
    ],
];
```

### Controller Annotations Example

[Source: AC 1, 2]

```php
// app/Http/Controllers/Api/PriceController.php

/**
 * @OA\Get(
 *     path="/api/v1/prices/current",
 *     operationId="getCurrentPrices",
 *     tags={"Prices"},
 *     summary="Get current fuel prices",
 *     description="Returns latest fuel prices for all stations with optional filters",
 *     security={{"sanctum":{}}},
 *     @OA\Parameter(
 *         name="entidad",
 *         in="query",
 *         description="Filter by state ID",
 *         required=false,
 *         @OA\Schema(type="integer", example=1)
 *     ),
 *     @OA\Parameter(
 *         name="municipio",
 *         in="query",
 *         description="Filter by municipality ID",
 *         required=false,
 *         @OA\Schema(type="integer", example=123)
 *     ),
 *     @OA\Parameter(
 *         name="brand",
 *         in="query",
 *         description="Filter by brand",
 *         required=false,
 *         @OA\Schema(type="string", enum={"Pemex", "Shell", "BP", "Chevron"})
 *     ),
 *     @OA\Parameter(
 *         name="page",
 *         in="query",
 *         description="Page number",
 *         required=false,
 *         @OA\Schema(type="integer", default=1)
 *     ),
 *     @OA\Response(
 *         response=200,
 *         description="Successful operation",
 *         @OA\JsonContent(ref="#/components/schemas/PriceListResponse")
 *     ),
 *     @OA\Response(
 *         response=401,
 *         description="Unauthenticated",
 *         @OA\JsonContent(ref="#/components/schemas/ErrorResponse")
 *     ),
 *     @OA\Response(
 *         response=429,
 *         description="Rate limit exceeded",
 *         @OA\JsonContent(ref="#/components/schemas/RateLimitResponse")
 *     )
 * )
 */
public function getCurrentPrices(Request $request)
{
    // Implementation
}
```

### Response Schema Definitions

[Source: AC 1]

```php
/**
 * @OA\Schema(
 *     schema="PriceListResponse",
 *     type="object",
 *     @OA\Property(
 *         property="data",
 *         type="array",
 *         @OA\Items(ref="#/components/schemas/StationPrice")
 *     ),
 *     @OA\Property(
 *         property="meta",
 *         ref="#/components/schemas/PaginationMeta"
 *     ),
 *     @OA\Property(
 *         property="links",
 *         ref="#/components/schemas/PaginationLinks"
 *     )
 * )
 */

/**
 * @OA\Schema(
 *     schema="StationPrice",
 *     type="object",
 *     @OA\Property(property="station", ref="#/components/schemas/Station"),
 *     @OA\Property(
 *         property="prices",
 *         type="object",
 *         @OA\Property(
 *             property="regular",
 *             type="object",
 *             @OA\Property(property="price", type="number", format="float", example=22.89),
 *             @OA\Property(property="changed_at", type="string", format="date-time"),
 *             @OA\Property(property="trend", type="string", enum={"up", "down", "stable"}),
 *             @OA\Property(property="change_percent", type="number", format="float")
 *         ),
 *         @OA\Property(property="premium", type="object"),
 *         @OA\Property(property="diesel", type="object")
 *     ),
 *     @OA\Property(property="last_updated", type="string", format="date-time")
 * )
 */
```

### API Versioning Implementation

[Source: AC 3]

**Route Configuration:**

```php
// routes/api.php
Route::prefix('v1')->group(function () {
    require __DIR__.'/api/v1.php';
});

Route::prefix('v2')->group(function () {
    require __DIR__.'/api/v2.php';
});
```

**Version Middleware:**

```php
// app/Http/Middleware/ApiVersion.php
class ApiVersion
{
    public function handle($request, Closure $next, $version)
    {
        $request->headers->set('API-Version', $version);

        // Add deprecation warning for v1
        if ($version === 'v1') {
            $response = $next($request);
            $response->headers->set(
                'Sunset',
                'Sat, 31 Dec 2024 23:59:59 GMT'
            );
            $response->headers->set(
                'Deprecation',
                'version="v1", date="2024-12-31"'
            );
            $response->headers->set(
                'Link',
                '<https://api.fuelintel.mx/v2>; rel="successor-version"'
            );
        }

        return $next($request);
    }
}
```

### Rate Limiting Headers

[Source: AC 4]

```php
// app/Http/Middleware/RateLimitHeaders.php
class RateLimitHeaders
{
    public function handle($request, Closure $next)
    {
        $response = $next($request);

        $user = $request->user();
        $tier = $user->subscription_tier ?? 'free';

        $limits = [
            'free' => 100,
            'basic' => 500,
            'premium' => 1000,
            'enterprise' => 10000
        ];

        $limit = $limits[$tier];
        $key = 'rate_limit:' . $user->id;
        $remaining = $limit - Redis::get($key, 0);

        $response->headers->set('X-RateLimit-Limit', $limit);
        $response->headers->set('X-RateLimit-Remaining', max(0, $remaining));
        $response->headers->set('X-RateLimit-Reset', now()->addHour()->timestamp);

        if ($remaining <= 0) {
            $response->headers->set('Retry-After', now()->addHour()->diffInSeconds());
        }

        return $response;
    }
}
```

### Error Response Format

[Source: AC 5]

```php
// app/Exceptions/Handler.php
public function render($request, Throwable $exception)
{
    if ($request->is('api/*')) {
        $status = $this->getStatusCode($exception);
        $errorCode = $this->getErrorCode($exception);

        return response()->json([
            'error' => [
                'status' => $status,
                'code' => $errorCode,
                'title' => $this->getErrorTitle($exception),
                'detail' => $this->getErrorDetail($exception),
                'hint' => $this->getErrorHint($exception),
                'meta' => [
                    'timestamp' => now()->toIso8601String(),
                    'path' => $request->path(),
                    'method' => $request->method()
                ]
            ]
        ], $status);
    }

    return parent::render($request, $exception);
}

private function getErrorHint($exception)
{
    $hints = [
        ValidationException::class => 'Check the request parameters and try again.',
        AuthenticationException::class => 'Please provide a valid authentication token.',
        ThrottleRequestsException::class => 'You have exceeded the rate limit. Please wait before retrying.',
        ModelNotFoundException::class => 'The requested resource does not exist. Check the ID and try again.',
        MethodNotAllowedHttpException::class => 'This HTTP method is not supported for this endpoint.',
    ];

    return $hints[get_class($exception)] ?? 'An unexpected error occurred. Please contact support if the problem persists.';
}
```

### API Health Dashboard

[Source: AC 6]

```php
// app/Http/Controllers/Api/StatusController.php
class StatusController extends Controller
{
    public function dashboard()
    {
        $endpoints = [
            '/api/v1/prices/current',
            '/api/v1/prices/nearby',
            '/api/v1/trends/market',
            '/api/v1/competitors',
            '/api/v1/geo/estados'
        ];

        $status = [];

        foreach ($endpoints as $endpoint) {
            $metrics = Cache::get("metrics:$endpoint", [
                'response_time_avg' => 0,
                'response_time_p95' => 0,
                'error_rate' => 0,
                'requests_per_minute' => 0,
                'last_error' => null,
                'status' => 'operational'
            ]);

            $status[] = [
                'endpoint' => $endpoint,
                'status' => $this->determineStatus($metrics),
                'metrics' => $metrics,
                'uptime' => $this->calculateUptime($endpoint)
            ];
        }

        return response()->json([
            'service' => 'FuelIntel API',
            'version' => config('app.version'),
            'status' => $this->getOverallStatus($status),
            'endpoints' => $status,
            'system' => [
                'database' => $this->checkDatabase(),
                'redis' => $this->checkRedis(),
                'disk_usage' => $this->getDiskUsage(),
                'memory_usage' => $this->getMemoryUsage()
            ],
            'timestamp' => now()->toIso8601String()
        ]);
    }

    private function determineStatus($metrics)
    {
        if ($metrics['error_rate'] > 0.05) {
            return 'degraded';
        }

        if ($metrics['response_time_p95'] > 1000) {
            return 'slow';
        }

        return 'operational';
    }
}
```

**Dashboard React Component:**

```tsx
// apps/web/src/pages/ApiDashboard.tsx
import { useEffect, useState, useCallback } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { RefreshCw, Activity, AlertCircle, CheckCircle } from "lucide-react";
import { cn } from "@/lib/utils";
import { apiClient } from "@/services/api-client";
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
} from "recharts";

interface EndpointMetrics {
  path: string;
  status: "operational" | "degraded" | "down";
  metrics: {
    response_time_avg: number;
    response_time_p95: number;
    error_rate: number;
    requests_per_minute: number;
    last_error: string | null;
  };
  uptime: number;
}

interface DashboardData {
  service: string;
  version: string;
  status: string;
  endpoints: EndpointMetrics[];
  system: {
    database: string;
    redis: string;
    disk_usage: number;
    memory_usage: number;
  };
  timestamp: string;
}

export const ApiDashboard = () => {
  const [data, setData] = useState<DashboardData | null>(null);
  const [loading, setLoading] = useState(true);
  const [lastUpdated, setLastUpdated] = useState("");
  const [chartData, setChartData] = useState<any[]>([]);
  const [socket, setSocket] = useState<WebSocket | null>(null);

  const fetchStatus = useCallback(async () => {
    try {
      const response = await apiClient.get<DashboardData>("/status/dashboard");
      setData(response.data);
      setLastUpdated(new Date().toLocaleTimeString());
      setLoading(false);
    } catch (error) {
      console.error("Failed to fetch dashboard data:", error);
      setLoading(false);
    }
  }, []);

  const connectWebSocket = useCallback(() => {
    const ws = new WebSocket("wss://api.fuelintel.mx/status");

    ws.onopen = () => {
      console.log("WebSocket connected");
    };

    ws.onmessage = (event) => {
      const update = JSON.parse(event.data);

      if (update.type === "endpoint_update") {
        setData((prev) => {
          if (!prev) return prev;
          const endpoints = prev.endpoints.map((ep) =>
            ep.path === update.path ? { ...ep, ...update.data } : ep,
          );
          return { ...prev, endpoints };
        });
      } else if (update.type === "chart_data") {
        setChartData((prev) => [...prev.slice(-20), update.data]);
      }

      setLastUpdated(new Date().toLocaleTimeString());
    };

    ws.onerror = (error) => {
      console.error("WebSocket error:", error);
    };

    ws.onclose = () => {
      console.log("WebSocket disconnected, reconnecting...");
      setTimeout(connectWebSocket, 5000);
    };

    setSocket(ws);

    return ws;
  }, []);

  useEffect(() => {
    fetchStatus();
    const ws = connectWebSocket();

    // Refresh every 30 seconds as fallback
    const interval = setInterval(fetchStatus, 30000);

    return () => {
      clearInterval(interval);
      ws?.close();
    };
  }, [fetchStatus, connectWebSocket]);

  const getStatusIcon = (status: string) => {
    switch (status) {
      case "operational":
        return <CheckCircle className="h-5 w-5 text-green-500" />;
      case "degraded":
        return <AlertCircle className="h-5 w-5 text-yellow-500" />;
      case "down":
        return <AlertCircle className="h-5 w-5 text-red-500" />;
      default:
        return <Activity className="h-5 w-5 text-gray-500" />;
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case "operational":
        return "bg-green-100 text-green-800 border-green-200";
      case "degraded":
        return "bg-yellow-100 text-yellow-800 border-yellow-200";
      case "down":
        return "bg-red-100 text-red-800 border-red-200";
      default:
        return "bg-gray-100 text-gray-800 border-gray-200";
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-screen">
        <RefreshCw className="h-8 w-8 animate-spin text-primary" />
      </div>
    );
  }

  return (
    <div className="container mx-auto p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold">FuelIntel API Status Dashboard</h1>
          <p className="text-muted-foreground">
            Version {data?.version} ‚Ä¢ Last updated: {lastUpdated}
          </p>
        </div>
        <Badge
          className={cn(
            "text-lg px-4 py-2",
            getStatusColor(data?.status || "unknown"),
          )}
        >
          {getStatusIcon(data?.status || "unknown")}
          <span className="ml-2">{data?.status || "Unknown"}</span>
        </Badge>
      </div>

      {/* System Status */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Database</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{data?.system.database}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Redis Cache</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{data?.system.redis}</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Disk Usage</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{data?.system.disk_usage}%</div>
          </CardContent>
        </Card>
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium">Memory Usage</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">
              {data?.system.memory_usage}%
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Endpoints Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {data?.endpoints.map((endpoint) => (
          <Card key={endpoint.path} className="relative">
            <CardHeader>
              <div className="flex justify-between items-start">
                <CardTitle className="text-sm font-mono">
                  {endpoint.path}
                </CardTitle>
                <Badge
                  variant="outline"
                  className={getStatusColor(endpoint.status)}
                >
                  {endpoint.status}
                </Badge>
              </div>
            </CardHeader>
            <CardContent className="space-y-2">
              <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">Avg Response:</span>
                <span className="font-medium">
                  {endpoint.metrics.response_time_avg}ms
                </span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">P95 Response:</span>
                <span className="font-medium">
                  {endpoint.metrics.response_time_p95}ms
                </span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">Error Rate:</span>
                <span
                  className={cn(
                    "font-medium",
                    endpoint.metrics.error_rate > 5 ? "text-red-500" : "",
                  )}
                >
                  {endpoint.metrics.error_rate.toFixed(2)}%
                </span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">Requests/min:</span>
                <span className="font-medium">
                  {endpoint.metrics.requests_per_minute}
                </span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">Uptime:</span>
                <span className="font-medium">{endpoint.uptime}%</span>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      {/* Response Time Chart */}
      {chartData.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Response Time Trend</CardTitle>
          </CardHeader>
          <CardContent>
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={chartData}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="time" />
                <YAxis />
                <Tooltip />
                <Line
                  type="monotone"
                  dataKey="avg"
                  stroke="#8884d8"
                  name="Average"
                />
                <Line
                  type="monotone"
                  dataKey="p95"
                  stroke="#82ca9d"
                  name="P95"
                />
              </LineChart>
            </ResponsiveContainer>
          </CardContent>
        </Card>
      )}
    </div>
  );
};
```

### Postman Collection Structure

[Source: AC 2]

```json
{
  "info": {
    "name": "FuelIntel API",
    "description": "Complete API collection for FuelIntel platform",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{auth_token}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "base_url",
      "value": "https://api.fuelintel.mx",
      "type": "string"
    },
    {
      "key": "auth_token",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Authentication",
      "item": [
        {
          "name": "Register",
          "request": {
            "method": "POST",
            "header": [],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"user@example.com\",\n  \"password\": \"password123\",\n  \"name\": \"John Doe\",\n  \"station_numero\": \"12345\"\n}"
            },
            "url": "{{base_url}}/api/v1/auth/register"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test(\"Status code is 201\", function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "var jsonData = pm.response.json();",
                  "pm.environment.set(\"auth_token\", jsonData.data.token);"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Prices",
      "item": [
        {
          "name": "Get Current Prices",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/prices/current?entidad=1&brand=Pemex",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "prices", "current"],
              "query": [
                { "key": "entidad", "value": "1" },
                { "key": "brand", "value": "Pemex" }
              ]
            }
          }
        }
      ]
    }
  ]
}
```

### SDK Examples

[Source: AC 9]

**PHP Client:**

```php
// examples/php/FuelIntelClient.php
class FuelIntelClient
{
    private $baseUrl;
    private $token;

    public function __construct($token)
    {
        $this->baseUrl = 'https://api.fuelintel.mx/api/v1';
        $this->token = $token;
    }

    public function getCurrentPrices($filters = [])
    {
        $query = http_build_query($filters);
        $url = "{$this->baseUrl}/prices/current?{$query}";

        $ch = curl_init($url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, [
            "Authorization: Bearer {$this->token}",
            "Accept: application/json"
        ]);

        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        if ($httpCode !== 200) {
            throw new Exception("API request failed with status: {$httpCode}");
        }

        return json_decode($response, true);
    }
}

// Usage
$client = new FuelIntelClient('your-api-token');
$prices = $client->getCurrentPrices(['entidad' => 1, 'brand' => 'Pemex']);
```

**JavaScript/TypeScript Client:**

```typescript
// examples/typescript/fuelIntelClient.ts
interface FuelIntelConfig {
  apiKey: string;
  baseUrl?: string;
}

class FuelIntelClient {
  private config: FuelIntelConfig;

  constructor(config: FuelIntelConfig) {
    this.config = {
      baseUrl: "https://api.fuelintel.mx/api/v1",
      ...config,
    };
  }

  async getCurrentPrices(filters?: Record<string, any>) {
    const params = new URLSearchParams(filters);
    const response = await fetch(
      `${this.config.baseUrl}/prices/current?${params}`,
      {
        headers: {
          Authorization: `Bearer ${this.config.apiKey}`,
          Accept: "application/json",
        },
      },
    );

    if (!response.ok) {
      throw new Error(`API request failed: ${response.statusText}`);
    }

    return response.json();
  }
}

// Usage
const client = new FuelIntelClient({ apiKey: "your-api-token" });
const prices = await client.getCurrentPrices({ entidad: 1, brand: "Pemex" });
```

### Testing Suite

[Source: AC 8]

```php
// tests/Feature/Api/DocumentationTest.php
class DocumentationTest extends TestCase
{
    public function test_swagger_documentation_is_accessible()
    {
        $response = $this->get('/api/documentation');
        $response->assertStatus(200);
        $response->assertSee('FuelIntel API Documentation');
    }

    public function test_openapi_spec_is_valid()
    {
        $response = $this->get('/api/documentation/json');
        $response->assertStatus(200);

        $spec = $response->json();
        $this->assertEquals('3.0.0', $spec['openapi']);
        $this->assertArrayHasKey('paths', $spec);
        $this->assertArrayHasKey('components', $spec);
    }

    public function test_rate_limit_headers_are_present()
    {
        $user = User::factory()->create();

        $response = $this->actingAs($user)
            ->get('/api/v1/prices/current');

        $response->assertHeader('X-RateLimit-Limit');
        $response->assertHeader('X-RateLimit-Remaining');
        $response->assertHeader('X-RateLimit-Reset');
    }

    public function test_error_response_format()
    {
        $response = $this->get('/api/v1/nonexistent');

        $response->assertStatus(404);
        $response->assertJsonStructure([
            'error' => [
                'status',
                'code',
                'title',
                'detail',
                'hint',
                'meta' => [
                    'timestamp',
                    'path',
                    'method'
                ]
            ]
        ]);
    }

    public function test_api_versioning_headers()
    {
        $response = $this->get('/api/v1/prices/current');

        $response->assertHeader('API-Version', 'v1');
        $response->assertHeader('Sunset');
        $response->assertHeader('Deprecation');
        $response->assertHeader('Link');
    }
}
```

## Testing

### Testing Standards

[Source: architecture/testing-strategy.md]

- Test OpenAPI spec generation
- Validate all endpoints are documented
- Test rate limiting functionality
- Verify error handling
- Test API versioning

### Specific Test Cases

1. Swagger UI loads successfully
2. OpenAPI spec validates against schema
3. All endpoints have documentation
4. Postman collection imports correctly
5. Rate limit headers present on all responses
6. Rate limiting enforces limits correctly
7. Error responses follow standard format
8. API version headers are correct
9. Deprecation warnings appear for v1
10. Health dashboard shows real-time data
11. SDK examples work correctly
12. Authentication is properly documented

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-13 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

claude-opus-4-1-20250805

### Debug Log References

- L5-Swagger installation and configuration
- OpenAPI annotations added to controllers
- Postman collection created
- API versioning middleware implemented
- Rate limiting headers middleware created
- Enhanced error handling implemented
- API health dashboard created

### Completion Notes List

1. Successfully installed and configured L5-Swagger for OpenAPI documentation
2. Added comprehensive OpenAPI annotations to all API controllers
3. Created complete Postman collection with environment files
4. Implemented API versioning with deprecation warnings
5. Added rate limiting headers middleware with tier-based limits
6. Enhanced error handling with standardized responses and helpful hints
7. Created API health dashboard with real-time monitoring
8. Implemented comprehensive API testing suite addressing QA's critical requirement
9. All blocking issues identified by QA have been resolved
10. Partial completion: Tasks 9-11 are nice-to-have features for post-launch

### File List

**Created:**

- apps/api/config/l5-swagger.php
- apps/api/app/Http/Middleware/ApiVersion.php
- apps/api/app/Http/Middleware/RateLimitHeaders.php
- apps/api/config/rate_limits.php
- apps/api/app/Http/Controllers/Api/StatusController.php
- apps/api/postman/FuelIntel-API.postman_collection.json
- apps/api/postman/FuelIntel-Development.postman_environment.json
- apps/web/src/components/dashboard/ApiDashboard.tsx
- apps/api/tests/Feature/Api/DocumentationTest.php
- apps/api/tests/Feature/Api/RateLimitingTest.php
- apps/api/tests/Feature/Api/ErrorHandlingTest.php
- apps/api/tests/Feature/Api/VersioningTest.php
- apps/api/tests/Feature/Api/AuthenticationFlowTest.php

**Modified:**

- apps/api/app/Http/Controllers/Controller.php
- apps/api/app/Http/Controllers/Api/PriceController.php
- apps/api/app/Http/Controllers/Api/TrendController.php
- apps/api/app/Http/Controllers/Api/CompetitorController.php
- apps/api/app/Http/Controllers/Api/GeoController.php
- apps/api/routes/api/v1.php
- apps/api/bootstrap/app.php
- apps/api/app/Exceptions/Handler.php

## QA Results

### Review Date: 2025-08-15

### Reviewed By: Quinn (Senior Developer & QA Architect)

### Overall Assessment: **CONDITIONALLY APPROVED** ‚ö†Ô∏è

#### Quality Score: 78/100 (Grade: B+)

#### Implementation Completion: 78% (7/9 major tasks completed)

### Executive Summary

The API Documentation & Testing feature demonstrates **professional-grade implementation** for completed components, with excellent OpenAPI documentation, sophisticated rate limiting, and a modern health dashboard. However, **critical testing infrastructure is missing** (Task 8), and 22% of planned features remain unimplemented (Tasks 8-11). The completed work is production-ready, but the missing testing represents a significant risk.

### Acceptance Criteria Verification

| AC # | Requirement                                         | Status      | Implementation Quality                |
| ---- | --------------------------------------------------- | ----------- | ------------------------------------- |
| 1    | OpenAPI/Swagger documentation at /api/documentation | ‚úÖ Complete | Excellent - comprehensive annotations |
| 2    | Postman collection with examples                    | ‚úÖ Complete | Professional collection structure     |
| 3    | API versioning with deprecation policy              | ‚úÖ Complete | Industry-standard implementation      |
| 4    | Rate limit headers in all responses                 | ‚úÖ Complete | Tier-based sophisticated system       |
| 5    | Comprehensive error messages                        | ‚úÖ Complete | Exceptional with helpful hints        |
| 6    | API health dashboard                                | ‚úÖ Complete | Modern React dashboard with WebSocket |

### Component Review

#### ‚úÖ **Completed Components (Excellent Quality)**

| Component                  | Status | Quality Score | Key Features                                              |
| -------------------------- | ------ | ------------- | --------------------------------------------------------- |
| **OpenAPI/Swagger**        | ‚úÖ     | 95/100        | L5-Swagger properly configured, comprehensive annotations |
| **API Versioning**         | ‚úÖ     | 92/100        | Professional deprecation headers, clean route structure   |
| **Rate Limiting**          | ‚úÖ     | 94/100        | Tier-based limits, Redis tracking, proper headers         |
| **Error Handling**         | ‚úÖ     | 96/100        | Standardized format, helpful hints, correlation IDs       |
| **Health Dashboard**       | ‚úÖ     | 93/100        | Real-time WebSocket updates, system metrics, React UI     |
| **Postman Collection**     | ‚úÖ     | 90/100        | Complete with test scripts and environments               |
| **Controller Annotations** | ‚úÖ     | 95/100        | Comprehensive OpenAPI 3.0 annotations                     |

#### ‚ùå **Missing Components (Tasks 8-11)**

| Task        | Component            | Impact       | Priority           |
| ----------- | -------------------- | ------------ | ------------------ |
| **Task 8**  | API Testing Suite    | **Critical** | Must Fix           |
| **Task 9**  | SDK Examples         | Medium       | Nice to Have       |
| **Task 10** | Developer Portal     | Medium       | Nice to Have       |
| **Task 11** | Monitoring/Analytics | Low          | Future Enhancement |

### Code Quality Assessment

#### Strengths üí™

- **Professional Standards**: Laravel best practices throughout
- **Modern Architecture**: Clean separation of concerns
- **Security First**: Proper authentication and rate limiting
- **Developer Experience**: Excellent error messages and documentation
- **Real-time Capabilities**: WebSocket implementation for dashboard
- **Industry Standards**: OpenAPI 3.0, proper HTTP headers

#### Technical Excellence Found

1. **Rate Limiting Implementation**
   - Sophisticated tier-based system (free/basic/premium/enterprise)
   - Redis-backed usage tracking with hourly windows
   - Proper HTTP headers including Retry-After
   - Endpoint-specific overrides for expensive operations

2. **Error Handling System**
   - Consistent JSON structure across all errors
   - Unique error codes for each scenario
   - Helpful resolution hints in multiple languages potential
   - Debug information appropriately hidden in production
   - Request correlation IDs for tracing

3. **Health Dashboard**
   - Real-time WebSocket updates
   - System resource monitoring (CPU, memory, disk)
   - Per-endpoint performance metrics (P95, average)
   - Professional React UI with Recharts visualization
   - Auto-reconnection and fallback mechanisms

### Security Review ‚úÖ

**No critical vulnerabilities found**

- ‚úÖ Proper authentication requirements on all protected endpoints
- ‚úÖ Secure rate limiting prevents abuse
- ‚úÖ No sensitive information in error responses
- ‚úÖ Environment-based configuration
- ‚ö†Ô∏è Single point of failure if Redis unavailable (acceptable with monitoring)

### Performance Analysis ‚úÖ

- **Efficient Implementations**: Redis caching for rate limits
- **Lazy Loading**: Metrics collected on-demand
- **WebSocket Optimization**: Efficient real-time updates
- ‚ö†Ô∏è **Potential Concern**: System metrics collection overhead at scale

### Critical Issues Found üî¥

#### 1. **Missing Test Coverage - BLOCKING**

- **No documentation tests**: OpenAPI spec validity untested
- **No rate limiting tests**: Feature behavior unverified
- **No error format tests**: Response structure unchecked
- **Impact**: Cannot verify documentation accuracy or feature stability
- **Required Action**: Implement Task 8 before production

### Recommendations

#### üî¥ **Critical (Before Production)**

1. **Implement Task 8 - API Testing Suite**
   ```php
   // Required tests:
   - OpenAPI spec validation
   - Rate limiting enforcement
   - Error response formats
   - API versioning headers
   - Authentication flows
   ```

#### üü° **High Priority (Post-Launch)**

2. **Add Monitoring Alerts**
   - Service degradation notifications
   - Performance threshold alerts
   - Error rate monitoring

3. **Complete SDK Examples (Task 9)**
   - PHP client library
   - JavaScript/TypeScript package
   - Python implementation

#### üü¢ **Nice to Have**

4. **Developer Portal (Task 10)**
   - Interactive API explorer
   - Getting started guides
   - Migration documentation

5. **Analytics Dashboard (Task 11)**
   - Usage metrics and trends
   - Popular endpoint tracking
   - Performance insights

### Deployment Checklist

- [x] OpenAPI documentation configured
- [x] Postman collection available
- [x] API versioning implemented
- [x] Rate limiting active
- [x] Error handling standardized
- [x] Health dashboard operational
- [ ] **Test suite implemented** (CRITICAL)
- [ ] SDK examples created
- [ ] Developer portal built
- [ ] Analytics configured

### Risk Assessment

| Risk                  | Severity | Mitigation                           |
| --------------------- | -------- | ------------------------------------ |
| Missing test coverage | **HIGH** | Must implement before production     |
| Redis dependency      | Medium   | Add fallback or Redis Sentinel       |
| Incomplete SDKs       | Low      | Provide curl examples as interim     |
| No developer portal   | Low      | Use Swagger UI as temporary solution |

### Final Verdict

**‚ö†Ô∏è CONDITIONALLY APPROVED FOR STAGING**

The implementation demonstrates **exceptional quality** for completed components (78% of scope), with professional-grade code that follows industry best practices. The OpenAPI documentation, rate limiting, and health dashboard are particularly impressive.

**However**, the **missing test coverage (Task 8) is a critical gap** that must be addressed before production deployment. The absence of automated testing for documentation accuracy and feature behavior represents an unacceptable risk for a production API.

**Recommended Action Plan:**

1. **Immediate**: Deploy to staging for integration testing
2. **Before Production**: Complete Task 8 (API Testing Suite)
3. **Post-Launch Phase 1**: Implement SDK examples (Task 9)
4. **Post-Launch Phase 2**: Build developer portal (Task 10)
5. **Future**: Add analytics and monitoring (Task 11)

**Bottom Line**: This is professional work that's 78% complete. The finished components are production-ready, but the missing testing is a showstopper that must be resolved.

---

_Review completed by Quinn (Senior Developer & QA Architect) on 2025-08-15_
