# Story 4.6: Mobile Optimization & PWA

## Status

Draft

## Story

**As a** mobile user,
**I want** a native app-like experience on my phone,
**so that** I can access the dashboard conveniently.

## Acceptance Criteria

1. Progressive Web App configuration with service worker for offline capability
2. Add to Home Screen prompt with custom icon and splash screen
3. Touch-optimized interactions with swipe gestures for navigation
4. Responsive charts that remain readable on 320px screens
5. Lighthouse score of 90+ for Performance, Accessibility, and Best Practices
6. Offline mode shows cached data with clear "last updated" timestamps

## Tasks / Subtasks

- [ ] **Task 1: Configure PWA Manifest** (AC: 2)
  - [ ] Create public/manifest.json with app metadata
  - [ ] Add app icons in multiple sizes (192x192, 512x512)
  - [ ] Configure theme color and background color
  - [ ] Set display mode to "standalone"
  - [ ] Add shortcuts for quick actions
  - [ ] Create splash screen images for iOS
  - [ ] Add apple-touch-icon meta tags

- [ ] **Task 2: Implement Service Worker** (AC: 1, 6)
  - [ ] Create src/service-worker.ts
  - [ ] Implement cache-first strategy for static assets
  - [ ] Network-first strategy for API calls with fallback
  - [ ] Cache price data with TTL of 1 hour
  - [ ] Handle offline detection and notification
  - [ ] Implement background sync for data updates
  - [ ] Add skipWaiting and clientsClaim

- [ ] **Task 3: Build Install Prompt Component** (AC: 2)
  - [ ] Create src/components/pwa/InstallPrompt.tsx
  - [ ] Detect beforeinstallprompt event
  - [ ] Show custom install UI for mobile
  - [ ] Handle iOS Safari install instructions
  - [ ] Track install success/dismissal
  - [ ] Store user preference in localStorage
  - [ ] Add "Install App" option to settings

- [ ] **Task 4: Optimize Touch Interactions** (AC: 3)
  - [ ] Implement swipe gestures for navigation
  - [ ] Add pull-to-refresh functionality
  - [ ] Increase touch target sizes to 44x44px
  - [ ] Remove hover-only interactions
  - [ ] Add haptic feedback for actions
  - [ ] Implement long-press context menus
  - [ ] Add momentum scrolling

- [ ] **Task 5: Create Mobile-First Components** (AC: 4)
  - [ ] Create src/components/mobile/MobileChart.tsx
  - [ ] Simplify chart axes for small screens
  - [ ] Add pan and zoom for charts
  - [ ] Create collapsible data tables
  - [ ] Implement horizontal scroll for wide content
  - [ ] Add "View More" progressive disclosure
  - [ ] Create bottom sheet components

- [ ] **Task 6: Implement Offline Mode** (AC: 6)
  - [ ] Create src/components/offline/OfflineBanner.tsx
  - [ ] Show offline indicator when disconnected
  - [ ] Display last sync timestamp
  - [ ] Queue actions for when online
  - [ ] Show cached data with visual indicator
  - [ ] Implement retry mechanism
  - [ ] Add manual refresh button

- [ ] **Task 7: Optimize Performance** (AC: 5)
  - [ ] Implement code splitting per route
  - [ ] Lazy load below-fold components
  - [ ] Optimize images with WebP format
  - [ ] Minify and compress assets
  - [ ] Remove unused CSS with PurgeCSS
  - [ ] Implement virtual scrolling for lists
  - [ ] Add resource hints (preconnect, prefetch)

- [ ] **Task 8: Create App Shell** (AC: 1, 5)
  - [ ] Build minimal HTML/CSS/JS shell
  - [ ] Cache shell in service worker
  - [ ] Implement skeleton screens
  - [ ] Add inline critical CSS
  - [ ] Defer non-critical resources
  - [ ] Preload essential fonts
  - [ ] Cache navigation components

- [ ] **Task 9: Configure Vite PWA Plugin** (AC: 1, 2)
  - [ ] Install vite-plugin-pwa
  - [ ] Configure workbox options
  - [ ] Set up auto-update strategy
  - [ ] Generate service worker
  - [ ] Configure runtime caching
  - [ ] Add version management
  - [ ] Set up development mode

- [ ] **Task 10: Implement Background Sync** (AC: 1)
  - [ ] Register sync event in service worker
  - [ ] Queue failed API requests
  - [ ] Retry requests when online
  - [ ] Update local state on sync
  - [ ] Show sync status to user
  - [ ] Handle sync conflicts
  - [ ] Add periodic background sync

- [ ] **Task 11: Add Mobile-Specific Features** (AC: 3)
  - [ ] Implement bottom navigation bar
  - [ ] Add floating action button
  - [ ] Create gesture tutorial
  - [ ] Add shake-to-refresh feature
  - [ ] Implement smart app banners
  - [ ] Add share functionality
  - [ ] Enable fullscreen mode

- [ ] **Task 12: Optimize Network Usage** (AC: 5, 6)
  - [ ] Implement request batching
  - [ ] Add data saver mode
  - [ ] Compress API payloads
  - [ ] Use GraphQL for selective fields
  - [ ] Implement infinite scroll
  - [ ] Add network quality detection
  - [ ] Throttle updates on slow connections

- [ ] **Task 13: Write Unit Tests** (AC: All)
  - [ ] Test service worker registration
  - [ ] Test offline detection
  - [ ] Test cache strategies
  - [ ] Test install prompt logic
  - [ ] Test touch gesture handlers
  - [ ] Test responsive breakpoints

- [ ] **Task 14: Perform Lighthouse Audit** (AC: 5)
  - [ ] Run Lighthouse CI in pipeline
  - [ ] Fix performance issues
  - [ ] Improve accessibility score
  - [ ] Optimize SEO metadata
  - [ ] Fix best practices warnings
  - [ ] Generate performance budget
  - [ ] Set up monitoring

## Dev Notes

### Previous Story Context

[Source: Stories 4.1-4.5]

Stories 4.1-4.5 established:

- React app with Vite and TypeScript
- Authentication with JWT tokens
- Dashboard with current prices and trends
- Analytics dashboard with real-time updates
- Zustand stores and API services
- Shadcn/ui components and Tailwind CSS

### PWA Configuration

[Source: docs/front-end-spec.md]

```json
// manifest.json
{
  "name": "FuelIntel - Inteligencia de Precios",
  "short_name": "FuelIntel",
  "description": "Dashboard de anÃ¡lisis de precios de combustible",
  "theme_color": "#0EA5E9",
  "background_color": "#FFFFFF",
  "display": "standalone",
  "orientation": "portrait",
  "scope": "/",
  "start_url": "/?source=pwa",
  "icons": [
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ],
  "shortcuts": [
    {
      "name": "Precios Actuales",
      "url": "/dashboard",
      "icons": [{ "src": "/icons/prices.png", "sizes": "96x96" }]
    },
    {
      "name": "Alertas",
      "url": "/alerts",
      "icons": [{ "src": "/icons/alerts.png", "sizes": "96x96" }]
    }
  ]
}
```

### Service Worker Strategy

```typescript
// Cache strategies
const CACHE_STRATEGIES = {
  // Static assets - cache first
  static: {
    cacheName: "static-v1",
    pattern: /\.(js|css|woff2?|png|jpg|svg)$/,
    maxAge: 30 * 24 * 60 * 60, // 30 days
  },

  // API calls - network first with cache fallback
  api: {
    cacheName: "api-v1",
    pattern: /\/api\//,
    maxAge: 5 * 60, // 5 minutes
    fallback: true,
  },

  // HTML - network first
  pages: {
    cacheName: "pages-v1",
    pattern: /\.html$/,
    maxAge: 24 * 60 * 60, // 1 day
  },
};
```

### Touch Optimization

[Source: docs/front-end-spec.md]

Touch targets:

- Minimum size: 44x44px (iOS guideline)
- Spacing: 8px between targets
- Active state: Visual feedback within 100ms
- Gestures: Swipe, pinch-zoom, pull-refresh

```css
/* Touch-optimized buttons */
.touch-target {
  min-height: 44px;
  min-width: 44px;
  padding: 12px;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

/* Momentum scrolling */
.scrollable {
  -webkit-overflow-scrolling: touch;
  overflow-y: auto;
  overscroll-behavior-y: contain;
}
```

### Mobile Breakpoints

[Source: Story 4.1]

```typescript
const BREAKPOINTS = {
  mobile: 320, // iPhone SE
  tablet: 768, // iPad Mini
  desktop: 1024, // Desktop
  wide: 1920, // Wide screens
};

// Responsive utilities
const isMobile = () => window.innerWidth < 768;
const isTablet = () => window.innerWidth >= 768 && window.innerWidth < 1024;
const isDesktop = () => window.innerWidth >= 1024;
```

### Offline State Management

```typescript
interface OfflineState {
  isOnline: boolean;
  lastSync: string | null;
  pendingActions: Action[];
  cachedData: Map<string, CachedItem>;
}

interface CachedItem {
  data: any;
  timestamp: string;
  ttl: number;
}

interface Action {
  id: string;
  type: "CREATE" | "UPDATE" | "DELETE";
  resource: string;
  payload: any;
  timestamp: string;
}
```

### Install Prompt Pattern

```typescript
interface InstallPromptState {
  deferredPrompt: BeforeInstallPromptEvent | null;
  isInstallable: boolean;
  isInstalled: boolean;
  platform: "ios" | "android" | "desktop" | null;
}

const useInstallPrompt = () => {
  const [state, setState] = useState<InstallPromptState>({
    deferredPrompt: null,
    isInstallable: false,
    isInstalled: false,
    platform: detectPlatform(),
  });

  useEffect(() => {
    // Listen for install prompt
    const handler = (e: BeforeInstallPromptEvent) => {
      e.preventDefault();
      setState((prev) => ({
        ...prev,
        deferredPrompt: e,
        isInstallable: true,
      }));
    };

    window.addEventListener("beforeinstallprompt", handler);

    // Check if already installed
    if (window.matchMedia("(display-mode: standalone)").matches) {
      setState((prev) => ({ ...prev, isInstalled: true }));
    }

    return () => window.removeEventListener("beforeinstallprompt", handler);
  }, []);

  return state;
};
```

### Performance Optimization

[Source: AC 5]

Lighthouse targets:

- Performance: 90+
- Accessibility: 90+
- Best Practices: 90+
- SEO: 90+

Key metrics:

- First Contentful Paint: < 1.8s
- Speed Index: < 3.4s
- Time to Interactive: < 3.8s
- Total Blocking Time: < 200ms
- Cumulative Layout Shift: < 0.1

### Vite PWA Plugin Config

```typescript
// vite.config.ts
import { VitePWA } from "vite-plugin-pwa";

export default {
  plugins: [
    VitePWA({
      registerType: "autoUpdate",
      includeAssets: ["favicon.ico", "apple-touch-icon.png"],
      manifest: {
        // manifest.json content
      },
      workbox: {
        globPatterns: ["**/*.{js,css,html,ico,png,svg,woff2}"],
        runtimeCaching: [
          {
            urlPattern: /^https:\/\/api\.fuelintel\.mx\//,
            handler: "NetworkFirst",
            options: {
              cacheName: "api-cache",
              expiration: {
                maxEntries: 50,
                maxAgeSeconds: 5 * 60, // 5 minutes
              },
              cacheableResponse: {
                statuses: [0, 200],
              },
            },
          },
        ],
      },
    }),
  ],
};
```

### Background Sync

```typescript
// service-worker.ts
self.addEventListener("sync", (event: SyncEvent) => {
  if (event.tag === "sync-prices") {
    event.waitUntil(syncPrices());
  }
});

async function syncPrices() {
  const cache = await caches.open("api-cache");
  const requests = await getQueuedRequests();

  for (const request of requests) {
    try {
      const response = await fetch(request);
      await cache.put(request, response.clone());
      await removeFromQueue(request);
    } catch (error) {
      console.error("Sync failed:", error);
    }
  }
}
```

### Mobile Components

```typescript
// Bottom Navigation
interface BottomNavProps {
  items: NavItem[];
  activeRoute: string;
}

const BottomNav: React.FC<BottomNavProps> = ({ items, activeRoute }) => {
  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t md:hidden">
      <div className="flex justify-around">
        {items.map(item => (
          <NavLink
            key={item.path}
            to={item.path}
            className={cn(
              "flex flex-col items-center py-2 px-3 text-xs",
              activeRoute === item.path && "text-primary"
            )}
          >
            <item.icon className="h-6 w-6 mb-1" />
            <span>{item.label}</span>
          </NavLink>
        ))}
      </div>
    </nav>
  );
};
```

### Network Detection

```typescript
const useNetworkQuality = () => {
  const [quality, setQuality] = useState<"fast" | "slow" | "offline">("fast");

  useEffect(() => {
    const connection = (navigator as any).connection;

    if (!connection) return;

    const updateQuality = () => {
      if (!navigator.onLine) {
        setQuality("offline");
      } else if (connection.effectiveType === "4g") {
        setQuality("fast");
      } else {
        setQuality("slow");
      }
    };

    updateQuality();
    connection.addEventListener("change", updateQuality);

    return () => connection.removeEventListener("change", updateQuality);
  }, []);

  return quality;
};
```

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

- **Framework**: Vitest with React Testing Library
- **Coverage Target**: 80% for PWA features
- **Service Worker Testing**: MSW for mocking
- **Device Testing**: BrowserStack for real devices

### Specific Test Cases

1. Test service worker registration and update
2. Test offline detection and banner display
3. Test cache strategies for different resources
4. Test install prompt on different platforms
5. Test touch gestures and interactions
6. Test responsive breakpoints
7. Test background sync queue
8. Test network quality detection
9. Test app shell loading
10. Test Lighthouse scores in CI
11. Test iOS specific features
12. Test data persistence in offline mode

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-31 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
