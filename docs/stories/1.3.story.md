# Story 1.3: External Services Setup

## Status

Approved

## Story

**As a** platform operator,
**I want** to configure all external service accounts and integrations,
**so that** the application can connect to required third-party services.

## Acceptance Criteria

1. Telegram bot created via @BotFather with webhook URL configured and token stored securely
2. DeepSeek API account created with API key obtained and credit balance verified for Spanish NLP
3. Vercel account connected to repository with project created for frontend deployment
4. Laravel Forge account configured with server provisioned on Vultr (or alternative)
5. Vultr Object Storage bucket created for report storage with S3-compatible credentials
6. CloudFlare account setup with CDN configuration for static assets (optional but recommended)
7. Sentry project created for error tracking with DSN keys for all three applications
8. GitHub repository created with proper branch protection rules and team access configured
9. Documentation created listing all external services, their purpose, and setup steps
10. Secrets management strategy documented (GitHub Secrets for CI/CD, .env for local)

## Tasks / Subtasks

- [ ] **Task 1: Set up GitHub repository** (AC: 8)
  - [ ] Create new GitHub repository (public or private based on preference)
  - [ ] Configure branch protection for main branch (require PR reviews)
  - [ ] Set up GitHub Secrets for CI/CD variables
  - [ ] Configure repository settings (disable wiki, enable issues)
  - [ ] Add .github/CODEOWNERS file if team collaboration

- [ ] **Task 2: Create Telegram bot** (AC: 1)
  - [ ] Message @BotFather on Telegram to create new bot
  - [ ] Choose bot name and username (e.g., @FuelIntelBot)
  - [ ] Receive and save bot token securely
  - [ ] Configure webhook URL (will be updated after backend deployment)
  - [ ] Add bot token to .env.example as TELEGRAM_BOT_TOKEN

- [ ] **Task 3: Set up DeepSeek API account** (AC: 2)
  - [ ] Create account at platform.deepseek.com
  - [ ] Generate API key for Spanish language processing
  - [ ] Verify credit balance or add initial credits
  - [ ] Test API key with simple Spanish text request
  - [ ] Add to .env.example as DEEPSEEK_API_KEY

- [ ] **Task 4: Configure Vercel deployment** (AC: 3)
  - [ ] Create Vercel account (or login if existing)
  - [ ] Import GitHub repository to Vercel
  - [ ] Configure build settings: Framework Preset: Vite, Root Directory: apps/web
  - [ ] Set environment variables in Vercel dashboard (VITE_API_URL)
  - [ ] Configure custom domain if available

- [ ] **Task 5: Set up Laravel Forge and Vultr** (AC: 4)
  - [ ] Create Laravel Forge account
  - [ ] Connect Forge to Vultr account (or create Vultr account)
  - [ ] Provision server: Ubuntu 22.04 LTS, PHP 8.3, PostgreSQL 15
  - [ ] Configure server with appropriate size (2GB RAM minimum for MVP)
  - [ ] Set up SSH keys for deployment access

- [ ] **Task 6: Create Vultr Object Storage** (AC: 5)
  - [ ] Create Object Storage bucket in Vultr dashboard
  - [ ] Generate S3-compatible access keys
  - [ ] Configure CORS policy for web access
  - [ ] Test connection with S3 client
  - [ ] Add credentials to .env.example (S3_KEY, S3_SECRET, S3_BUCKET, S3_ENDPOINT)

- [ ] **Task 7: Set up CloudFlare CDN** (AC: 6)
  - [ ] Create CloudFlare account (free tier acceptable)
  - [ ] Add domain if owned, or skip for MVP
  - [ ] Configure CDN rules for static assets
  - [ ] Set up page rules for caching
  - [ ] Document CloudFlare configuration

- [ ] **Task 8: Configure Sentry error tracking** (AC: 7)
  - [ ] Create Sentry account and organization
  - [ ] Create three projects: fuelintel-web, fuelintel-api, fuelintel-scraper
  - [ ] Obtain DSN keys for each project
  - [ ] Configure source map upload for React project
  - [ ] Add DSN keys to respective .env.example files

- [ ] **Task 9: Document secrets management** (AC: 10)
  - [ ] Create docs/SECRETS.md file
  - [ ] Document local development: .env files (never commit)
  - [ ] Document CI/CD: GitHub Secrets configuration
  - [ ] Document production: Forge environment variables
  - [ ] Create .env.vault strategy for team sharing (optional)

- [ ] **Task 10: Create services documentation** (AC: 9)
  - [ ] Create docs/EXTERNAL_SERVICES.md
  - [ ] Document each service with purpose, setup steps, and costs
  - [ ] Include troubleshooting steps for common issues
  - [ ] Add backup/alternative service options
  - [ ] Create service dependency diagram

- [ ] **Task 11: Configure GitHub Actions secrets** (AC: 8, 10)
  - [ ] Add VERCEL_TOKEN for frontend deployment
  - [ ] Add FORGE_WEBHOOK_URL for backend deployment
  - [ ] Add SENTRY_AUTH_TOKEN for source map uploads
  - [ ] Add test database credentials for CI
  - [ ] Document all secrets in SECRETS.md

- [ ] **Task 12: Verify all services** (AC: 1-8)
  - [ ] Test Telegram bot responds to /start command
  - [ ] Verify DeepSeek API processes Spanish text
  - [ ] Confirm Vercel builds and deploys successfully
  - [ ] Check Laravel Forge server is accessible
  - [ ] Test Vultr Object Storage upload/download
  - [ ] Verify Sentry receives test errors from all services

## Dev Notes

### Previous Story Context

[Source: Story 1.1, Story 1.2]

- Story 1.1 established the monorepo structure with environment variable templates
- Story 1.2 created the database schema requiring PostgreSQL 15+
- Environment variables structure already defined in .env.example files

### Service Integration Points

[Source: architecture/tech-stack.md]

**Required External Services:**

- **Telegram Bot**: BotMan 2.8+ integration in Laravel
- **DeepSeek API**: For Spanish NLP processing
- **Vercel**: Frontend hosting with Edge Network CDN
- **Laravel Forge**: Server management and deployment
- **Vultr**: VPS hosting and S3-compatible object storage
- **Sentry**: Error tracking for all three applications
- **CloudFlare**: Optional CDN for static assets

### Deployment Configuration

[Source: architecture/deployment-architecture.md]

**Frontend (Vercel):**

- Build Command: `cd apps/web && npm run build`
- Output Directory: `apps/web/dist`
- Framework Preset: Vite
- Environment Variables: VITE_API_URL pointing to Laravel backend

**Backend (Laravel Forge):**

- Server: Ubuntu 22.04 LTS with PHP 8.3
- Build Command: `cd apps/api && composer install --no-dev && php artisan optimize`
- Auto-deploy from GitHub main branch
- Environment variables managed in Forge dashboard

### Security Configuration

[Source: architecture/security-and-performance.md]

**API Keys Storage:**

- Development: .env files (gitignored)
- CI/CD: GitHub Secrets
- Production: Laravel Forge environment variables
- Never commit secrets to repository

**Service Authentication:**

- Telegram: Bot token for webhook authentication
- DeepSeek: API key in Authorization header
- Vultr S3: Access key and secret key
- Sentry: DSN for each project

### Monitoring Setup

[Source: architecture/monitoring-and-observability.md]

**Sentry Projects Configuration:**

1. **fuelintel-web** (React):
   - Enable source maps
   - Set up release tracking
   - Configure user context

2. **fuelintel-api** (Laravel):
   - Enable performance monitoring
   - Configure database query tracking
   - Set up user identification

3. **fuelintel-scraper** (Node.js):
   - Track scraping errors
   - Monitor API call failures
   - Log performance metrics

### GitHub Repository Configuration

[Source: architecture/deployment-architecture.md]

**Branch Protection Rules:**

- Require pull request reviews before merging
- Dismiss stale PR approvals when new commits pushed
- Require status checks to pass (tests, linting)
- Include administrators in restrictions

**GitHub Actions Secrets Required:**

- VERCEL_TOKEN: For automatic frontend deployment
- FORGE_WEBHOOK_URL: Trigger backend deployment
- SENTRY_AUTH_TOKEN: Upload source maps
- Database credentials for CI testing

### Cost Considerations

**Free/Low-Cost Services:**

- GitHub: Free for public repos, minimal for private
- Telegram Bot: Free
- CloudFlare: Free tier sufficient for CDN
- Sentry: Free tier includes 5K errors/month

**Paid Services (Monthly Estimates):**

- DeepSeek API: ~$10-50 depending on usage
- Vercel: Free tier likely sufficient, Pro $20/month if needed
- Laravel Forge: $12/month
- Vultr VPS: ~$12-24/month (2-4GB RAM)
- Vultr Object Storage: ~$5/month

### Service Setup Order

The services should be set up in this sequence:

1. GitHub (foundation for everything)
2. Laravel Forge + Vultr (backend infrastructure)
3. Vercel (frontend deployment)
4. Telegram + DeepSeek (application features)
5. Sentry (monitoring)
6. CloudFlare (optimization - optional)

### Critical Environment Variables

**Laravel Backend (.env):**

```
TELEGRAM_BOT_TOKEN=
TELEGRAM_WEBHOOK_URL=
DEEPSEEK_API_KEY=
SENTRY_LARAVEL_DSN=
AWS_ACCESS_KEY_ID= (Vultr S3)
AWS_SECRET_ACCESS_KEY= (Vultr S3)
AWS_DEFAULT_REGION=
AWS_BUCKET=
AWS_ENDPOINT=
```

**React Frontend (.env):**

```
VITE_API_URL=
VITE_SENTRY_DSN=
```

**Node.js Scraper (.env):**

```
SENTRY_DSN=
DATABASE_URL=
WEBHOOK_URL= (Laravel webhook)
WEBHOOK_SECRET=
```

## Testing

### Testing Standards

[Source: architecture/testing-strategy.md]

- Create integration tests for each external service
- Mock external services in unit tests
- Test service failover/fallback mechanisms
- Verify error tracking works in Sentry
- Test deployment pipelines work correctly

### Specific Test Cases

1. Telegram bot responds to test message
2. DeepSeek API returns Spanish language response
3. Vercel deployment triggered by git push
4. Laravel Forge deployment webhook works
5. File upload to Vultr S3 succeeds
6. Sentry receives and displays test error
7. CloudFlare caches static assets (if configured)

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-13 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
