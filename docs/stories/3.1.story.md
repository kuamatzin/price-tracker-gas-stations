# Story 3.1: Telegram Bot Setup & Command Structure

## Status

Approved

## Story

**As a** gas station owner,
**I want** to interact with FuelIntel through Telegram commands,
**so that** I can quickly access pricing data from my phone.

## Acceptance Criteria

1. Bot successfully registers with Telegram and responds to messages in production environment
2. /start command initiates registration flow linking Telegram account to FuelIntel user
3. /help command displays comprehensive command list with usage examples in Spanish
4. /comandos shows categorized command menu (Precios, AnÃ¡lisis, ConfiguraciÃ³n, Ayuda)
5. Bot handles unknown commands gracefully with helpful suggestions
6. Multi-language support structure in place (Spanish default, English future)

## Tasks / Subtasks

- [ ] **Task 1: Create Telegram bot with BotFather** (AC: 1)
  - [ ] Register bot with BotFather on Telegram
  - [ ] Obtain bot token and save in .env
  - [ ] Set bot name, description, and profile picture
  - [ ] Configure bot commands in BotFather
  - [ ] Set webhook URL for production

- [ ] **Task 2: Set up Laravel Telegram SDK** (AC: 1)
  - [ ] Install telegram-bot-sdk: `composer require irazasyed/telegram-bot-sdk`
  - [ ] Configure telegram.php with bot token
  - [ ] Create TelegramController for webhook handling
  - [ ] Set up webhook route in api routes
  - [ ] Implement webhook verification

- [ ] **Task 3: Create command handler structure** (AC: 3, 4, 5)
  - [ ] Create BaseCommand abstract class
  - [ ] Implement CommandRegistry for command routing
  - [ ] Build CommandParser for message interpretation
  - [ ] Set up command aliases mapping
  - [ ] Create UnknownCommand handler

- [ ] **Task 4: Implement /start command** (AC: 2)
  - [ ] Create StartCommand class
  - [ ] Build registration flow state machine
  - [ ] Link Telegram user ID to FuelIntel account
  - [ ] Generate registration token for security
  - [ ] Send welcome message with next steps

- [ ] **Task 5: Build /help command** (AC: 3)
  - [ ] Create HelpCommand class
  - [ ] Generate comprehensive command list
  - [ ] Include usage examples in Spanish
  - [ ] Format with Markdown for readability
  - [ ] Add quick action buttons

- [ ] **Task 6: Create /comandos menu** (AC: 4)
  - [ ] Build ComandosCommand class
  - [ ] Implement inline keyboard with categories
  - [ ] Create callback handlers for each category
  - [ ] Design category structure (Precios, AnÃ¡lisis, etc.)
  - [ ] Add navigation between categories

- [ ] **Task 7: Implement session management** (AC: 2, 5)
  - [ ] Set up Redis session store
  - [ ] Create TelegramSession class
  - [ ] Track conversation state
  - [ ] Implement session timeout (30 minutes)
  - [ ] Store user preferences in session

- [ ] **Task 8: Build message router** (AC: 5)
  - [ ] Create MessageRouter class
  - [ ] Parse incoming updates (messages, callbacks)
  - [ ] Route to appropriate command handler
  - [ ] Handle inline queries
  - [ ] Process callback queries

- [ ] **Task 9: Add language support structure** (AC: 6)
  - [ ] Create language files (es.json, en.json)
  - [ ] Build TranslationService for bot
  - [ ] Implement user language preference
  - [ ] Default to Spanish locale
  - [ ] Add language switching command (/idioma)

- [ ] **Task 10: Implement error handling** (AC: 5)
  - [ ] Create BotExceptionHandler
  - [ ] Handle unknown commands gracefully
  - [ ] Suggest similar commands using Levenshtein
  - [ ] Log errors to monitoring system
  - [ ] Send user-friendly error messages

- [ ] **Task 11: Set up bot testing framework** (AC: All)
  - [ ] Create mock Telegram API client
  - [ ] Build command testing utilities
  - [ ] Write tests for all commands
  - [ ] Test conversation flows
  - [ ] Verify webhook handling

## Dev Notes

### Previous Story Context

[Source: Epic 2]

- Story 2.1: User authentication system ready
- Story 2.2-2.5: All API endpoints available
- Story 2.6: API documentation complete

### Telegram Bot Configuration

[Source: Telegram Bot API documentation]

**Bot Registration with BotFather:**

```
1. Message @BotFather on Telegram
2. Send /newbot
3. Choose name: FuelIntel Bot
4. Choose username: fuelintel_bot
5. Receive token: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
6. Set commands with /setcommands
```

**Command List for BotFather:**

```
start - Iniciar el bot y registrarse
help - Ver lista de comandos disponibles
comandos - MenÃº de comandos por categorÃ­a
precios - Ver precios actuales de tu estaciÃ³n
precios_competencia - Precios de competidores cercanos
precio_promedio - Promedio de precios en tu municipio
tendencia - Tendencia de precios (7 dÃ­as)
ranking - Tu posiciÃ³n entre competidores
configurar - Configurar preferencias
mi_estacion - Actualizar datos de tu estaciÃ³n
notificaciones - Configurar alertas
silencio - Pausar notificaciones temporalmente
```

### Laravel Telegram SDK Setup

[Source: AC 1, 2]

**Configuration (config/telegram.php):**

```php
return [
    'bots' => [
        'fuelintel' => [
            'username' => 'fuelintel_bot',
            'token' => env('TELEGRAM_BOT_TOKEN'),
            'certificate_path' => env('TELEGRAM_CERTIFICATE_PATH'),
            'webhook_url' => env('TELEGRAM_WEBHOOK_URL'),
            'commands' => [
                Telegram\Bot\Commands\StartCommand::class,
                App\Telegram\Commands\HelpCommand::class,
                App\Telegram\Commands\ComandosCommand::class,
                App\Telegram\Commands\PreciosCommand::class,
                // ... more commands
            ],
        ],
    ],
    'default' => 'fuelintel',
    'async_requests' => env('TELEGRAM_ASYNC_REQUESTS', false),
    'http_client_handler' => null,
    'resolve_command_dependencies' => true,
];
```

**Webhook Controller:**

```php
// app/Http/Controllers/TelegramController.php
namespace App\Http\Controllers;

use Telegram\Bot\Laravel\Facades\Telegram;
use App\Services\Telegram\MessageRouter;
use App\Services\Telegram\SessionManager;

class TelegramController extends Controller
{
    protected $router;
    protected $sessionManager;

    public function __construct(MessageRouter $router, SessionManager $sessionManager)
    {
        $this->router = $router;
        $this->sessionManager = $sessionManager;
    }

    public function webhook()
    {
        $update = Telegram::commandsHandler(true);

        // Get chat ID and user info
        $chatId = $update->getMessage()?->getChat()->getId();
        $userId = $update->getMessage()?->getFrom()->getId();

        if (!$chatId) {
            return response()->json(['ok' => true]);
        }

        // Load or create session
        $session = $this->sessionManager->getSession($userId);

        // Route the update
        $this->router->route($update, $session);

        // Save session state
        $this->sessionManager->saveSession($session);

        return response()->json(['ok' => true]);
    }
}
```

### Command Structure

[Source: AC 3, 4, 5]

**Base Command Class:**

```php
// app/Telegram/Commands/BaseCommand.php
namespace App\Telegram\Commands;

use Telegram\Bot\Commands\Command;
use App\Services\Telegram\SessionManager;
use App\Services\TranslationService;

abstract class BaseCommand extends Command
{
    protected $session;
    protected $translator;

    public function __construct()
    {
        $this->translator = app(TranslationService::class);
    }

    protected function getUserLanguage($userId)
    {
        $session = app(SessionManager::class)->getSession($userId);
        return $session->get('language', 'es');
    }

    protected function trans($key, $params = [], $userId = null)
    {
        $lang = $userId ? $this->getUserLanguage($userId) : 'es';
        return $this->translator->get($key, $params, $lang);
    }

    protected function sendTypingAction($chatId)
    {
        $this->telegram->sendChatAction([
            'chat_id' => $chatId,
            'action' => 'typing'
        ]);
    }
}
```

**Start Command Implementation:**

```php
// app/Telegram/Commands/StartCommand.php
namespace App\Telegram\Commands;

use Telegram\Bot\Keyboard\Keyboard;
use App\Models\User;
use App\Models\TelegramUser;

class StartCommand extends BaseCommand
{
    protected $name = 'start';
    protected $description = 'Iniciar el bot y registrarse';

    public function handle()
    {
        $message = $this->getUpdate()->getMessage();
        $telegramUserId = $message->getFrom()->getId();
        $chatId = $message->getChat()->getId();

        $this->sendTypingAction($chatId);

        // Check if user is already registered
        $telegramUser = TelegramUser::where('telegram_id', $telegramUserId)->first();

        if ($telegramUser) {
            $this->sendWelcomeBack($chatId, $telegramUser);
        } else {
            $this->startRegistration($chatId, $telegramUserId);
        }
    }

    protected function startRegistration($chatId, $telegramUserId)
    {
        // Generate registration token
        $token = bin2hex(random_bytes(16));

        // Store in session
        $session = app(SessionManager::class)->getSession($telegramUserId);
        $session->put('registration_token', $token);
        $session->put('registration_step', 'email');

        $keyboard = Keyboard::make()
            ->inline()
            ->row([
                Keyboard::inlineButton([
                    'text' => 'ðŸ”— Conectar cuenta existente',
                    'callback_data' => 'register_existing'
                ])
            ])
            ->row([
                Keyboard::inlineButton([
                    'text' => 'ðŸ“ Crear cuenta nueva',
                    'callback_data' => 'register_new'
                ])
            ]);

        $this->replyWithMessage([
            'text' => $this->trans('welcome.new_user'),
            'reply_markup' => $keyboard
        ]);
    }

    protected function sendWelcomeBack($chatId, $telegramUser)
    {
        $user = $telegramUser->user;
        $text = $this->trans('welcome.back', ['name' => $user->name]);

        $keyboard = Keyboard::make()
            ->inline()
            ->row([
                Keyboard::inlineButton([
                    'text' => 'ðŸ’° Ver precios',
                    'callback_data' => 'cmd_precios'
                ]),
                Keyboard::inlineButton([
                    'text' => 'ðŸ“Š AnÃ¡lisis',
                    'callback_data' => 'cmd_analisis'
                ])
            ])
            ->row([
                Keyboard::inlineButton([
                    'text' => 'âš™ï¸ ConfiguraciÃ³n',
                    'callback_data' => 'cmd_configurar'
                ]),
                Keyboard::inlineButton([
                    'text' => 'â“ Ayuda',
                    'callback_data' => 'cmd_help'
                ])
            ]);

        $this->replyWithMessage([
            'text' => $text,
            'reply_markup' => $keyboard
        ]);
    }
}
```

### Help Command with Examples

[Source: AC 3]

```php
// app/Telegram/Commands/HelpCommand.php
class HelpCommand extends BaseCommand
{
    protected $name = 'help';
    protected $description = 'Ver lista de comandos disponibles';

    public function handle()
    {
        $chatId = $this->getUpdate()->getMessage()->getChat()->getId();
        $this->sendTypingAction($chatId);

        $helpText = "*ðŸ¤– Comandos Disponibles de FuelIntel*\n\n";

        $helpText .= "*ðŸ’° Comandos de Precios:*\n";
        $helpText .= "`/precios` - Precios actuales de tu estaciÃ³n\n";
        $helpText .= "`/precios_competencia` - Precios de competidores\n";
        $helpText .= "`/precio_promedio` - Promedio en tu municipio\n";
        $helpText .= "`/precio Pemex Centro` - Buscar estaciÃ³n especÃ­fica\n\n";

        $helpText .= "*ðŸ“Š Comandos de AnÃ¡lisis:*\n";
        $helpText .= "`/tendencia` - Tendencia de 7 dÃ­as\n";
        $helpText .= "`/ranking` - Tu posiciÃ³n de precios\n";
        $helpText .= "`/historial 30` - Historial de X dÃ­as\n\n";

        $helpText .= "*âš™ï¸ Comandos de ConfiguraciÃ³n:*\n";
        $helpText .= "`/configurar` - Configurar preferencias\n";
        $helpText .= "`/mi_estacion` - Actualizar datos de estaciÃ³n\n";
        $helpText .= "`/notificaciones` - Configurar alertas\n";
        $helpText .= "`/silencio 2h` - Pausar notificaciones\n\n";

        $helpText .= "*ðŸ’¡ Ejemplos de uso:*\n";
        $helpText .= "â€¢ `/precios premium` - Solo precios de premium\n";
        $helpText .= "â€¢ `/precios diesel` - Solo precios de diesel\n";
        $helpText .= "â€¢ TambiÃ©n puedes escribir naturalmente:\n";
        $helpText .= "  _\"Â¿CuÃ¡nto estÃ¡ la gasolina?\"_\n";
        $helpText .= "  _\"Precio de diesel en mi zona\"_\n";

        $this->replyWithMessage([
            'text' => $helpText,
            'parse_mode' => 'Markdown'
        ]);
    }
}
```

### Comandos Menu with Categories

[Source: AC 4]

```php
// app/Telegram/Commands/ComandosCommand.php
class ComandosCommand extends BaseCommand
{
    protected $name = 'comandos';
    protected $description = 'MenÃº de comandos por categorÃ­a';

    public function handle()
    {
        $chatId = $this->getUpdate()->getMessage()->getChat()->getId();

        $keyboard = Keyboard::make()
            ->inline()
            ->row([
                Keyboard::inlineButton([
                    'text' => 'ðŸ’° Precios',
                    'callback_data' => 'menu_precios'
                ]),
                Keyboard::inlineButton([
                    'text' => 'ðŸ“Š AnÃ¡lisis',
                    'callback_data' => 'menu_analisis'
                ])
            ])
            ->row([
                Keyboard::inlineButton([
                    'text' => 'âš™ï¸ ConfiguraciÃ³n',
                    'callback_data' => 'menu_configuracion'
                ]),
                Keyboard::inlineButton([
                    'text' => 'â“ Ayuda',
                    'callback_data' => 'menu_ayuda'
                ])
            ]);

        $this->replyWithMessage([
            'text' => "*ðŸ“‹ MenÃº de Comandos*\n\nSelecciona una categorÃ­a:",
            'parse_mode' => 'Markdown',
            'reply_markup' => $keyboard
        ]);
    }
}
```

### Session Management

[Source: AC 2, 5]

```php
// app/Services/Telegram/SessionManager.php
namespace App\Services\Telegram;

use Illuminate\Support\Facades\Redis;

class SessionManager
{
    const TTL = 1800; // 30 minutes

    public function getSession($userId)
    {
        $key = "telegram:session:{$userId}";
        $data = Redis::get($key);

        if ($data) {
            return new TelegramSession(json_decode($data, true));
        }

        return new TelegramSession(['user_id' => $userId]);
    }

    public function saveSession(TelegramSession $session)
    {
        $key = "telegram:session:{$session->getUserId()}";
        Redis::setex($key, self::TTL, json_encode($session->toArray()));
    }

    public function destroySession($userId)
    {
        $key = "telegram:session:{$userId}";
        Redis::del($key);
    }
}

// app/Services/Telegram/TelegramSession.php
class TelegramSession
{
    protected $data;

    public function __construct(array $data = [])
    {
        $this->data = $data;
    }

    public function get($key, $default = null)
    {
        return $this->data[$key] ?? $default;
    }

    public function put($key, $value)
    {
        $this->data[$key] = $value;
    }

    public function forget($key)
    {
        unset($this->data[$key]);
    }

    public function getUserId()
    {
        return $this->data['user_id'] ?? null;
    }

    public function toArray()
    {
        return $this->data;
    }
}
```

### Unknown Command Handler

[Source: AC 5]

```php
// app/Telegram/Commands/UnknownCommand.php
class UnknownCommand extends BaseCommand
{
    public function handle($command)
    {
        $chatId = $this->getUpdate()->getMessage()->getChat()->getId();

        // Find similar commands
        $suggestions = $this->findSimilarCommands($command);

        $text = "âŒ No reconozco el comando `{$command}`\n\n";

        if (!empty($suggestions)) {
            $text .= "*QuizÃ¡s quisiste decir:*\n";
            foreach ($suggestions as $suggestion) {
                $text .= "â€¢ `/{$suggestion}`\n";
            }
            $text .= "\n";
        }

        $text .= "Usa /help para ver todos los comandos disponibles.";

        $this->replyWithMessage([
            'text' => $text,
            'parse_mode' => 'Markdown'
        ]);
    }

    protected function findSimilarCommands($input)
    {
        $commands = [
            'precios', 'precios_competencia', 'precio_promedio',
            'tendencia', 'ranking', 'historial',
            'configurar', 'mi_estacion', 'notificaciones',
            'help', 'comandos', 'start'
        ];

        $similar = [];

        foreach ($commands as $command) {
            $distance = levenshtein($input, $command);
            if ($distance <= 3) { // Tolerance of 3 characters
                $similar[$command] = $distance;
            }
        }

        asort($similar);
        return array_slice(array_keys($similar), 0, 3);
    }
}
```

### Language Support Structure

[Source: AC 6]

```json
// resources/lang/telegram/es.json
{
  "welcome": {
    "new_user": "Â¡Bienvenido a FuelIntel! ðŸš€\n\nTe ayudarÃ© a monitorear precios de combustible y tomar decisiones inteligentes.\n\nÂ¿CÃ³mo deseas continuar?",
    "back": "Â¡Hola de nuevo, :name! ðŸ‘‹\n\nÂ¿QuÃ© deseas hacer hoy?"
  },
  "errors": {
    "unknown_command": "No reconozco ese comando",
    "api_timeout": "El servicio estÃ¡ tardando mÃ¡s de lo normal. Por favor intenta de nuevo.",
    "general": "Algo saliÃ³ mal. Por favor intenta de nuevo mÃ¡s tarde."
  },
  "commands": {
    "precios": {
      "description": "Ver precios actuales",
      "no_station": "No tienes una estaciÃ³n registrada. Usa /configurar para establecerla."
    }
  }
}
```

### Environment Variables

[Source: Bot configuration]

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_WEBHOOK_URL=https://api.fuelintel.mx/telegram/webhook
TELEGRAM_CERTIFICATE_PATH=/path/to/certificate.pem

# Redis for sessions
REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379
```

### Database Schema for Telegram Users

[Source: Story 1.2 extension]

```sql
-- Telegram users table
CREATE TABLE telegram_users (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    telegram_id BIGINT NOT NULL UNIQUE,
    telegram_username VARCHAR(255),
    first_name VARCHAR(255),
    last_name VARCHAR(255),
    language_code VARCHAR(10) DEFAULT 'es',
    is_bot BOOLEAN DEFAULT false,
    registration_token VARCHAR(64),
    registered_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_interaction TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_telegram_users_telegram_id ON telegram_users(telegram_id);
CREATE INDEX idx_telegram_users_user_id ON telegram_users(user_id);
```

## Testing

### Testing Standards

[Source: architecture/testing-strategy.md]

- Unit tests for all commands
- Integration tests for webhook handling
- Mock Telegram API responses
- Test conversation flows
- Verify session management

### Specific Test Cases

1. Bot responds to webhook requests
2. /start command initiates registration
3. /help displays all commands
4. /comandos shows category menu
5. Unknown commands trigger suggestions
6. Session persists across messages
7. Language switching works
8. Registration flow completes successfully
9. Callback queries are handled
10. Error messages are user-friendly
11. Commands work in both Spanish and English
12. Rate limiting prevents spam

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-13 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
