# Story 4.4: Historical Trends Visualization

## Status

Draft

## Story

**As a** data analyst,
**I want** to see price trends in interactive charts,
**so that** I can identify patterns and opportunities.

## Acceptance Criteria

1. Line chart displays price history with selectable date ranges (7, 15, 30 days)
2. Multi-series chart compares user's prices against market average
3. Chart.js or Recharts implementation with zoom and pan capabilities
4. Toggle between fuel types with animated transitions
5. Tooltip shows exact values and percentage changes on hover
6. Trend summary statistics (avg, min, max, volatility) displayed below chart

## Tasks / Subtasks

- [x] **Task 1: Install and Configure Charting Library** (AC: 3)
  - [x] Install Recharts and dependencies
  - [x] Create chart configuration constants
  - [x] Set up responsive container wrapper
  - [x] Configure TypeScript types for charts
  - [x] Add chart animation utilities
  - [x] Create chart theme configuration

- [x] **Task 2: Create Trend Chart Component** (AC: 1, 3, 4, 5)
  - [x] Create src/components/charts/TrendChart.tsx
  - [x] Implement line chart with multiple series
  - [x] Add zoom and pan functionality
  - [x] Create custom tooltip component
  - [x] Add animated transitions between datasets
  - [x] Implement responsive sizing
  - [x] Add loading skeleton state

- [x] **Task 3: Build Date Range Selector** (AC: 1)
  - [x] Create src/components/features/analytics/DateRangeSelector.tsx
  - [x] Add preset buttons (7, 15, 30 days)
  - [x] Implement custom date picker
  - [x] Add quick navigation (previous/next period)
  - [x] Store selected range in URL params
  - [x] Add date validation logic

- [ ] **Task 4: Implement Fuel Type Toggle** (AC: 4)
  - [ ] Create src/components/features/analytics/FuelTypeToggle.tsx
  - [ ] Build tab navigation for fuel types
  - [ ] Add "All fuels" comparison option
  - [ ] Implement smooth transitions between views
  - [ ] Sync with chart data updates
  - [ ] Add active state indicators

- [ ] **Task 5: Create Comparison Chart** (AC: 2)
  - [ ] Create src/components/charts/ComparisonChart.tsx
  - [ ] Display user prices vs market average
  - [ ] Add difference visualization (area between lines)
  - [ ] Implement percentage difference overlay
  - [ ] Color code advantageous periods
  - [ ] Add market position indicators

- [ ] **Task 6: Build Statistics Panel** (AC: 6)
  - [ ] Create src/components/features/analytics/StatisticsPanel.tsx
  - [ ] Calculate and display average price
  - [ ] Show minimum price with date
  - [ ] Show maximum price with date
  - [ ] Calculate and display volatility
  - [ ] Add trend direction indicator
  - [ ] Include price change summary

- [ ] **Task 7: Create Analytics Store** (AC: All)
  - [ ] Create src/stores/analyticsStore.ts
  - [ ] Store historical price data
  - [ ] Manage selected date range
  - [ ] Handle fuel type selection
  - [ ] Cache fetched data by range
  - [ ] Implement data aggregation logic
  - [ ] Add loading and error states

- [ ] **Task 8: Build Analytics Service** (AC: 1, 2, 6)
  - [ ] Create src/services/analytics.service.ts
  - [ ] Implement getStationHistory() method
  - [ ] Implement getMarketTrends() method
  - [ ] Add getTrendAnalysis() method
  - [ ] Create data transformation utilities
  - [ ] Handle gap filling in time series
  - [ ] Implement request caching

- [ ] **Task 9: Create Historical Trends Page** (AC: All)
  - [ ] Create src/pages/analytics/HistoricalTrends.tsx
  - [ ] Layout with chart as main focus
  - [ ] Add controls above chart
  - [ ] Place statistics below chart
  - [ ] Implement responsive layout
  - [ ] Add export functionality
  - [ ] Include refresh button

- [ ] **Task 10: Implement Data Processing** (AC: 2, 6)
  - [ ] Create src/utils/trendCalculations.ts
  - [ ] Calculate moving averages
  - [ ] Implement volatility calculation
  - [ ] Add trend detection algorithm
  - [ ] Create market comparison logic
  - [ ] Handle missing data points
  - [ ] Add seasonal pattern detection

- [ ] **Task 11: Add Chart Interactions** (AC: 3, 5)
  - [ ] Implement zoom controls (+/- buttons)
  - [ ] Add pan gesture support
  - [ ] Create crosshair cursor on hover
  - [ ] Build detailed tooltip with formatting
  - [ ] Add click to focus functionality
  - [ ] Implement reset zoom button
  - [ ] Add keyboard navigation

- [ ] **Task 12: Optimize Performance** (AC: 3, 4)
  - [ ] Implement data decimation for large datasets
  - [ ] Add virtualization for long time periods
  - [ ] Use React.memo for chart components
  - [ ] Implement lazy loading for charts
  - [ ] Add request debouncing
  - [ ] Cache rendered chart states

- [ ] **Task 13: Write Unit Tests** (AC: All)
  - [ ] Test statistical calculations
  - [ ] Test date range logic
  - [ ] Test data transformation
  - [ ] Test chart configuration
  - [ ] Test tooltip formatting
  - [ ] Test responsive behavior

- [ ] **Task 14: Write Integration Tests** (AC: 1, 2, 6)
  - [ ] Test API data fetching
  - [ ] Test chart rendering with data
  - [ ] Test date range changes
  - [ ] Test fuel type switching
  - [ ] Test zoom/pan functionality
  - [ ] Test statistics updates

## Dev Notes

### Previous Story Context

[Source: Stories 4.1-4.3]

Stories 4.1-4.3 established:

- React app with TypeScript and Vite
- Authentication and dashboard layout
- Current prices and competitor views
- Zustand state management
- API client with interceptors
- Responsive design patterns

### API Endpoints

[Source: apps/api/routes/api/v1.php]
[Source: apps/api/app/Http/Controllers/Api/AnalyticsController.php]

#### Price History

```
GET /api/v1/prices/history/{station_id}
Query params: days (7|15|30), fuel_type
Response: Time series data with gap filling
Cache: 5 minutes
```

#### Station Trends

```
GET /api/v1/trends/station/{id}
Query params: start_date, end_date, period
Response: Trend analysis with volatility, confidence
Cache: 1 hour
```

#### Market Trends

```
GET /api/v1/trends/market
Query params: entidad_id, municipio_id, start_date, end_date, grouping
Response: Regional market aggregation
Cache: 1 hour
```

### Data Structures

[Source: apps/api/app/Services/ChartFormatterService.php]

#### Chart Data Format

```typescript
interface ChartDataPoint {
  date: string; // ISO date
  regular?: number; // Price for regular
  premium?: number; // Price for premium
  diesel?: number; // Price for diesel
  events?: PriceEvent[]; // Price change events
}

interface PriceEvent {
  type: "price_change";
  fuel: FuelType;
  change: number; // Price difference
  changePercent: number; // Percentage change
}
```

#### Statistics Response

```typescript
interface TrendStatistics {
  average: number;
  min: { value: number; date: string };
  max: { value: number; date: string };
  volatility: number; // Standard deviation
  trend: {
    direction: "rising" | "falling" | "stable";
    slope: number;
    confidence: number; // R² value
  };
  changeCount: number; // Number of price changes
}
```

### Charting Library Choice

[Source: Architecture analysis]

**Recommendation: Recharts**

- React-native, no wrapper needed
- TypeScript support out of the box
- Composable chart components
- Built-in animations
- Responsive by default
- Lighter than Chart.js

Installation:

```bash
npm install recharts
```

### Chart Configuration

```typescript
const CHART_CONFIG = {
  colors: {
    regular: "#10B981", // Green
    premium: "#F59E0B", // Amber
    diesel: "#3B82F6", // Blue
    market: "#6B7280", // Gray
    positive: "#10B981", // Green for positive
    negative: "#EF4444", // Red for negative
  },
  animations: {
    duration: 300,
    easing: "ease-in-out",
  },
  margins: {
    top: 20,
    right: 30,
    bottom: 40,
    left: 60,
  },
  responsive: {
    mobile: { height: 300 },
    tablet: { height: 400 },
    desktop: { height: 500 },
  },
};
```

### Statistical Calculations

[Source: apps/api/app/Services/TrendAnalysisService.php]

```typescript
// Volatility calculation (standard deviation)
const calculateVolatility = (prices: number[]): number => {
  if (prices.length < 2) return 0;

  const mean = prices.reduce((a, b) => a + b, 0) / prices.length;
  const squaredDiffs = prices.map((price) => Math.pow(price - mean, 2));
  const variance = squaredDiffs.reduce((a, b) => a + b, 0) / prices.length;

  return Math.sqrt(variance);
};

// Moving average
const calculateMovingAverage = (prices: number[], window: number): number[] => {
  return prices.map((_, index, array) => {
    const start = Math.max(0, index - window + 1);
    const subset = array.slice(start, index + 1);
    return subset.reduce((a, b) => a + b, 0) / subset.length;
  });
};

// Trend detection
const detectTrend = (prices: number[]): "rising" | "falling" | "stable" => {
  // Linear regression to determine trend
  // Returns direction based on slope
};
```

### Date Range Management

```typescript
interface DateRange {
  preset?: "7d" | "15d" | "30d" | "custom";
  startDate: Date;
  endDate: Date;
}

const DATE_PRESETS = {
  "7d": {
    label: "7 días",
    getDates: () => ({
      startDate: subDays(new Date(), 7),
      endDate: new Date(),
    }),
  },
  "15d": {
    label: "15 días",
    getDates: () => ({
      startDate: subDays(new Date(), 15),
      endDate: new Date(),
    }),
  },
  "30d": {
    label: "30 días",
    getDates: () => ({
      startDate: subDays(new Date(), 30),
      endDate: new Date(),
    }),
  },
};
```

### Tooltip Configuration

```typescript
interface TooltipProps {
  active?: boolean;
  payload?: Array<{
    value: number;
    name: string;
    color: string;
  }>;
  label?: string;
}

const CustomTooltip = ({ active, payload, label }: TooltipProps) => {
  if (!active || !payload) return null;

  return (
    <div className="bg-white p-3 rounded-lg shadow-lg border">
      <p className="font-semibold">{formatDate(label)}</p>
      {payload.map((entry) => (
        <div key={entry.name} className="flex items-center gap-2">
          <span
            className="w-3 h-3 rounded-full"
            style={{ backgroundColor: entry.color }}
          />
          <span className="text-sm">
            {entry.name}: ${entry.value.toFixed(2)}
          </span>
        </div>
      ))}
    </div>
  );
};
```

### Performance Optimizations

[Source: Backend caching strategies]

- **Data Caching**: 5-minute TTL for history, 1-hour for trends
- **Request Debouncing**: 300ms delay on date range changes
- **Data Decimation**: Reduce points for periods > 30 days
- **Memoization**: Use React.memo for chart components
- **Lazy Loading**: Load charts only when visible
- **Virtual Scrolling**: For statistics tables with many rows

### Responsive Design

[Source: Story 4.1 breakpoints]

```css
/* Chart height adjustments */
@media (max-width: 768px) {
  .chart-container {
    height: 300px;
  }
}

@media (min-width: 768px) and (max-width: 1024px) {
  .chart-container {
    height: 400px;
  }
}

@media (min-width: 1024px) {
  .chart-container {
    height: 500px;
  }
}
```

### Component File Structure

```
src/
├── pages/
│   └── analytics/
│       └── HistoricalTrends.tsx
├── components/
│   ├── charts/
│   │   ├── TrendChart.tsx
│   │   ├── ComparisonChart.tsx
│   │   └── ChartTooltip.tsx
│   └── features/
│       └── analytics/
│           ├── DateRangeSelector.tsx
│           ├── FuelTypeToggle.tsx
│           └── StatisticsPanel.tsx
├── stores/
│   └── analyticsStore.ts
├── services/
│   └── analytics.service.ts
└── utils/
    └── trendCalculations.ts
```

### Gap Filling Strategy

[Source: apps/api/app/Repositories/HistoricalDataRepository.php]

When data points are missing:

1. Fill with last known price
2. Mark as interpolated in metadata
3. Show visual indicator in chart
4. Include in statistics with notation

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

- **Framework**: Vitest with React Testing Library
- **Coverage Target**: 80% for analytics components
- **Mock Strategy**: Mock chart library for unit tests
- **Data Mocking**: Use factory functions for time series

### Specific Test Cases

1. Test chart renders with valid data
2. Test date range selector updates chart
3. Test fuel type toggle switches data
4. Test zoom and pan functionality
5. Test tooltip displays correct values
6. Test statistics calculations accuracy
7. Test handling of missing data points
8. Test responsive chart resizing
9. Test animation transitions
10. Test performance with large datasets
11. Test API error handling
12. Test cache invalidation on range change

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-30 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

- Task 1 completed: Installed Recharts 3.1.2 and date-fns 4.1.0 dependencies
- Created comprehensive chart configuration with colors, animations, margins, and responsive breakpoints
- Built responsive ChartContainer component with automatic height adjustment based on viewport
- Defined TypeScript interfaces for ChartDataPoint, TrendStatistics, DateRange, and comparison data
- Added chart animation utilities with preset configurations for lines, areas, and transitions
- Created theme configuration with light/dark mode support and consistent styling

- Task 2 completed: Built comprehensive TrendChart component with full interactivity
- Implemented multi-series line chart supporting regular, premium, and diesel fuel types
- Added zoom and pan functionality with mouse interaction and reset controls
- Created custom tooltip component showing formatted date and price values
- Integrated animated transitions between datasets using Recharts animation props
- Built responsive sizing using ChartContainer wrapper with automatic height adjustment
- Added loading skeleton and error states with proper fallback UI

- Task 3 completed: Created comprehensive DateRangeSelector integrated with existing UI store
- Built preset buttons for 7, 15, and 30-day periods with active state indication
- Implemented custom date picker modal with validation and error handling
- Added quick navigation controls (previous/next period) with boundary checking
- Integrated with existing UI store activeFilters.dateRange for consistent state management
- Used shared date utilities from packages/shared instead of external dependencies
- Created robust date validation logic preventing invalid ranges and future dates

### File List

**Created:**
- `src/config/charts.ts` - Chart configuration constants, date presets, and fuel type definitions
- `src/components/charts/ChartContainer.tsx` - Responsive container wrapper component for charts
- `src/components/charts/TrendChart.tsx` - Interactive line chart component with zoom, pan, and multi-series support
- `src/components/features/analytics/DateRangeSelector.tsx` - Date range selector with presets, custom picker, and UI store integration
- `src/types/charts.ts` - TypeScript interfaces for chart data structures and props
- `src/utils/chartAnimations.ts` - Animation utilities and preset configurations
- `src/config/chartTheme.ts` - Chart theme configuration with light/dark mode support

**Modified:**
- `apps/web/package.json` - Added recharts@3.1.2 and date-fns@4.1.0 dependencies

## QA Results

(To be filled by QA agent)
