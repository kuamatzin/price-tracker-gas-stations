# Story 4.4: Historical Trends Visualization

## Status

Draft

## Story

**As a** multi-station owner,
**I want** to see price trends for my selected station and compare across stations,
**so that** I can identify patterns and opportunities for each location.

## Acceptance Criteria

1. Line chart displays price history for selected station with date ranges (7, 15, 30 days)
2. Station name/numero displayed prominently in chart title
3. Multi-series chart compares station's prices against its local market average
4. Multi-station comparison mode to view trends across all user's stations
5. Chart.js or Recharts implementation with zoom and pan capabilities
6. Toggle between fuel types with animated transitions
7. Tooltip shows exact values and percentage changes on hover
8. Trend summary statistics (avg, min, max, volatility) per station
9. Data refreshes when user switches between stations

## Tasks / Subtasks

- [ ] **Task 1: Install and Configure Charting Library** (AC: 3)
  - [ ] Install Recharts and dependencies
  - [ ] Create chart configuration constants
  - [ ] Set up responsive container wrapper
  - [ ] Configure TypeScript types for charts
  - [ ] Add chart animation utilities
  - [ ] Create chart theme configuration

- [ ] **Task 2: Create Station Trend Chart Component** (AC: 1, 2, 3, 5, 6, 7)
  - [ ] Create src/components/charts/TrendChart.tsx
  - [ ] Accept station_numero as prop
  - [ ] Display station name in chart title
  - [ ] Implement line chart with multiple series
  - [ ] Add zoom and pan functionality
  - [ ] Create custom tooltip component
  - [ ] Add animated transitions between datasets
  - [ ] Implement responsive sizing
  - [ ] Add loading skeleton state
  - [ ] Clear and reload data on station change

- [ ] **Task 3: Build Date Range Selector** (AC: 1)
  - [ ] Create src/components/features/analytics/DateRangeSelector.tsx
  - [ ] Add preset buttons (7, 15, 30 days)
  - [ ] Implement custom date picker
  - [ ] Add quick navigation (previous/next period)
  - [ ] Store selected range in URL params
  - [ ] Add date validation logic

- [ ] **Task 4: Create Multi-Station Comparison** (AC: 4)
  - [ ] Create src/components/charts/MultiStationComparison.tsx
  - [ ] Allow selection of multiple user stations
  - [ ] Display each station as separate line series
  - [ ] Use different colors per station
  - [ ] Add station legend with toggle capability
  - [ ] Sync date ranges across all stations
  - [ ] Show comparative statistics panel

- [ ] **Task 5: Implement Fuel Type Toggle** (AC: 6)
  - [ ] Create src/components/features/analytics/FuelTypeToggle.tsx
  - [ ] Build tab navigation for fuel types
  - [ ] Add "All fuels" comparison option
  - [ ] Implement smooth transitions between views
  - [ ] Sync with chart data updates
  - [ ] Add active state indicators

- [ ] **Task 6: Create Market Comparison Chart** (AC: 3)
  - [ ] Create src/components/charts/MarketComparisonChart.tsx
  - [ ] Display selected station prices vs local market average
  - [ ] Calculate market average for station's area
  - [ ] Add difference visualization (area between lines)
  - [ ] Implement percentage difference overlay
  - [ ] Color code advantageous periods
  - [ ] Add market position indicators

- [ ] **Task 7: Build Statistics Panel** (AC: 8)
  - [ ] Create src/components/features/analytics/StatisticsPanel.tsx
  - [ ] Accept station_numero as prop
  - [ ] Calculate and display average price per station
  - [ ] Show minimum price with date
  - [ ] Show maximum price with date
  - [ ] Calculate and display volatility
  - [ ] Add trend direction indicator
  - [ ] Include price change summary
  - [ ] Update calculations on station change

- [ ] **Task 8: Create Station-Aware Analytics Store** (AC: All)
  - [ ] Create src/stores/analyticsStore.ts
  - [ ] Store historical price data per station
  - [ ] Manage selected date range
  - [ ] Handle fuel type selection
  - [ ] Cache fetched data by station and range
  - [ ] Implement data aggregation logic
  - [ ] Add loading and error states
  - [ ] Clear cache on station switch

- [ ] **Task 9: Build Station-Aware Analytics Service** (AC: 1, 3, 8, 9)
  - [ ] Create src/services/analytics.service.ts
  - [ ] Implement getStationHistory(station_numero) method
  - [ ] Implement getMarketTrends(station_numero) method
  - [ ] Implement getMultiStationComparison() method
  - [ ] Add getTrendAnalysis(station_numero) method
  - [ ] Create data transformation utilities
  - [ ] Handle gap filling in time series
  - [ ] Implement request caching per station

- [ ] **Task 10: Create Historical Trends Page** (AC: All)
  - [ ] Create src/pages/analytics/HistoricalTrends.tsx
  - [ ] Display selected station name prominently
  - [ ] Layout with chart as main focus
  - [ ] Add station switcher in header
  - [ ] Add controls above chart
  - [ ] Place statistics below chart
  - [ ] Implement responsive layout
  - [ ] Add export functionality
  - [ ] Include refresh button

- [ ] **Task 11: Add Chart Interactions** (AC: 3, 5)
  - [ ] Implement zoom controls (+/- buttons)
  - [ ] Add pan gesture support
  - [ ] Create crosshair cursor on hover
  - [ ] Build detailed tooltip with formatting
  - [ ] Add click to focus functionality
  - [ ] Implement reset zoom button
  - [ ] Add keyboard navigation

- [ ] **Task 12: Optimize Performance** (AC: 3, 4)
  - [ ] Implement data decimation for large datasets
  - [ ] Add virtualization for long time periods
  - [ ] Use React.memo for chart components
  - [ ] Implement lazy loading for charts
  - [ ] Add request debouncing
  - [ ] Cache rendered chart states

- [ ] **Task 13: Write Unit Tests** (AC: All)
  - [ ] Test statistical calculations
  - [ ] Test date range logic
  - [ ] Test data transformation
  - [ ] Test chart configuration
  - [ ] Test tooltip formatting
  - [ ] Test responsive behavior

- [ ] **Task 14: Write Integration Tests** (AC: 1, 2, 6)
  - [ ] Test API data fetching
  - [ ] Test chart rendering with data
  - [ ] Test date range changes
  - [ ] Test fuel type switching
  - [ ] Test zoom/pan functionality
  - [ ] Test statistics updates

## Dev Notes

### Previous Story Context

[Source: Stories 4.1-4.3]

Stories 4.1-4.3 established:

- React app with TypeScript and Vite
- Authentication and dashboard layout
- Current prices and competitor views
- Zustand state management
- API client with interceptors
- Responsive design patterns

### API Endpoints

[Source: apps/api/routes/api/v1.php]
[Source: apps/api/app/Http/Controllers/Api/AnalyticsController.php]

#### Price History

```
GET /api/v1/prices/history/{station_id}
Query params: days (7|15|30), fuel_type
Response: Time series data with gap filling
Cache: 5 minutes
```

#### Station Trends

```
GET /api/v1/trends/station/{id}
Query params: start_date, end_date, period
Response: Trend analysis with volatility, confidence
Cache: 1 hour
```

#### Market Trends

```
GET /api/v1/trends/market
Query params: entidad_id, municipio_id, start_date, end_date, grouping
Response: Regional market aggregation
Cache: 1 hour
```

### Data Structures

[Source: apps/api/app/Services/ChartFormatterService.php]

#### Chart Data Format

```typescript
interface ChartDataPoint {
  date: string; // ISO date
  regular?: number; // Price for regular
  premium?: number; // Price for premium
  diesel?: number; // Price for diesel
  events?: PriceEvent[]; // Price change events
}

interface PriceEvent {
  type: "price_change";
  fuel: FuelType;
  change: number; // Price difference
  changePercent: number; // Percentage change
}
```

#### Statistics Response

```typescript
interface TrendStatistics {
  average: number;
  min: { value: number; date: string };
  max: { value: number; date: string };
  volatility: number; // Standard deviation
  trend: {
    direction: "rising" | "falling" | "stable";
    slope: number;
    confidence: number; // RÂ² value
  };
  changeCount: number; // Number of price changes
}
```

### Charting Library Choice

[Source: Architecture analysis]

**Recommendation: Recharts**

- React-native, no wrapper needed
- TypeScript support out of the box
- Composable chart components
- Built-in animations
- Responsive by default
- Lighter than Chart.js

Installation:

```bash
npm install recharts
```

### Chart Configuration

```typescript
const CHART_CONFIG = {
  colors: {
    regular: "#10B981", // Green
    premium: "#F59E0B", // Amber
    diesel: "#3B82F6", // Blue
    market: "#6B7280", // Gray
    positive: "#10B981", // Green for positive
    negative: "#EF4444", // Red for negative
  },
  animations: {
    duration: 300,
    easing: "ease-in-out",
  },
  margins: {
    top: 20,
    right: 30,
    bottom: 40,
    left: 60,
  },
  responsive: {
    mobile: { height: 300 },
    tablet: { height: 400 },
    desktop: { height: 500 },
  },
};
```

### Statistical Calculations

[Source: apps/api/app/Services/TrendAnalysisService.php]

```typescript
// Volatility calculation (standard deviation)
const calculateVolatility = (prices: number[]): number => {
  if (prices.length < 2) return 0;

  const mean = prices.reduce((a, b) => a + b, 0) / prices.length;
  const squaredDiffs = prices.map((price) => Math.pow(price - mean, 2));
  const variance = squaredDiffs.reduce((a, b) => a + b, 0) / prices.length;

  return Math.sqrt(variance);
};

// Moving average
const calculateMovingAverage = (prices: number[], window: number): number[] => {
  return prices.map((_, index, array) => {
    const start = Math.max(0, index - window + 1);
    const subset = array.slice(start, index + 1);
    return subset.reduce((a, b) => a + b, 0) / subset.length;
  });
};

// Trend detection
const detectTrend = (prices: number[]): "rising" | "falling" | "stable" => {
  // Linear regression to determine trend
  // Returns direction based on slope
};
```

### Date Range Management

```typescript
interface DateRange {
  preset?: "7d" | "15d" | "30d" | "custom";
  startDate: Date;
  endDate: Date;
}

const DATE_PRESETS = {
  "7d": {
    label: "7 dÃ­as",
    getDates: () => ({
      startDate: subDays(new Date(), 7),
      endDate: new Date(),
    }),
  },
  "15d": {
    label: "15 dÃ­as",
    getDates: () => ({
      startDate: subDays(new Date(), 15),
      endDate: new Date(),
    }),
  },
  "30d": {
    label: "30 dÃ­as",
    getDates: () => ({
      startDate: subDays(new Date(), 30),
      endDate: new Date(),
    }),
  },
};
```

### Tooltip Configuration

```typescript
interface TooltipProps {
  active?: boolean;
  payload?: Array<{
    value: number;
    name: string;
    color: string;
  }>;
  label?: string;
}

const CustomTooltip = ({ active, payload, label }: TooltipProps) => {
  if (!active || !payload) return null;

  return (
    <div className="bg-white p-3 rounded-lg shadow-lg border">
      <p className="font-semibold">{formatDate(label)}</p>
      {payload.map((entry) => (
        <div key={entry.name} className="flex items-center gap-2">
          <span
            className="w-3 h-3 rounded-full"
            style={{ backgroundColor: entry.color }}
          />
          <span className="text-sm">
            {entry.name}: ${entry.value.toFixed(2)}
          </span>
        </div>
      ))}
    </div>
  );
};
```

### Performance Optimizations

[Source: Backend caching strategies]

- **Data Caching**: 5-minute TTL for history, 1-hour for trends
- **Request Debouncing**: 300ms delay on date range changes
- **Data Decimation**: Reduce points for periods > 30 days
- **Memoization**: Use React.memo for chart components
- **Lazy Loading**: Load charts only when visible
- **Virtual Scrolling**: For statistics tables with many rows

### Responsive Design

[Source: Story 4.1 breakpoints]

```css
/* Chart height adjustments */
@media (max-width: 768px) {
  .chart-container {
    height: 300px;
  }
}

@media (min-width: 768px) and (max-width: 1024px) {
  .chart-container {
    height: 400px;
  }
}

@media (min-width: 1024px) {
  .chart-container {
    height: 500px;
  }
}
```

### Component File Structure

```
src/
âââ pages/
â   âââ analytics/
â       âââ HistoricalTrends.tsx
âââ components/
â   âââ charts/
â   â   âââ TrendChart.tsx
â   â   âââ ComparisonChart.tsx
â   â   âââ ChartTooltip.tsx
â   âââ features/
â       âââ analytics/
â           âââ DateRangeSelector.tsx
â           âââ FuelTypeToggle.tsx
â           âââ StatisticsPanel.tsx
âââ stores/
â   âââ analyticsStore.ts
âââ services/
â   âââ analytics.service.ts
âââ utils/
    âââ trendCalculations.ts
```

### Gap Filling Strategy

[Source: apps/api/app/Repositories/HistoricalDataRepository.php]

When data points are missing:

1. Fill with last known price
2. Mark as interpolated in metadata
3. Show visual indicator in chart
4. Include in statistics with notation

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

- **Framework**: Vitest with React Testing Library
- **Coverage Target**: 80% for analytics components
- **Mock Strategy**: Mock chart library for unit tests
- **Data Mocking**: Use factory functions for time series

### Specific Test Cases

1. Test chart renders with valid data
2. Test date range selector updates chart
3. Test fuel type toggle switches data
4. Test zoom and pan functionality
5. Test tooltip displays correct values
6. Test statistics calculations accuracy
7. Test handling of missing data points
8. Test responsive chart resizing
9. Test animation transitions
10. Test performance with large datasets
11. Test API error handling
12. Test cache invalidation on range change

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-30 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
