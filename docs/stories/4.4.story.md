# Story 4.4: Historical Trends Visualization

## Status

Draft

## Story

**As a** data analyst,
**I want** to see price trends in interactive charts,
**so that** I can identify patterns and opportunities.

## Acceptance Criteria

1. Line chart displays price history with selectable date ranges (7, 15, 30 days)
2. Multi-series chart compares user's prices against market average
3. Chart.js or Recharts implementation with zoom and pan capabilities
4. Toggle between fuel types with animated transitions
5. Tooltip shows exact values and percentage changes on hover
6. Trend summary statistics (avg, min, max, volatility) displayed below chart

## Tasks / Subtasks

- [x] **Task 1: Install and Configure Charting Library** (AC: 3)
  - [x] Install Recharts and dependencies
  - [x] Create chart configuration constants
  - [x] Set up responsive container wrapper
  - [x] Configure TypeScript types for charts
  - [x] Add chart animation utilities
  - [x] Create chart theme configuration

- [x] **Task 2: Create Trend Chart Component** (AC: 1, 3, 4, 5)
  - [x] Create src/components/charts/TrendChart.tsx
  - [x] Implement line chart with multiple series
  - [x] Add zoom and pan functionality
  - [x] Create custom tooltip component
  - [x] Add animated transitions between datasets
  - [x] Implement responsive sizing
  - [x] Add loading skeleton state

- [x] **Task 3: Build Date Range Selector** (AC: 1)
  - [x] Create src/components/features/analytics/DateRangeSelector.tsx
  - [x] Add preset buttons (7, 15, 30 days)
  - [x] Implement custom date picker
  - [x] Add quick navigation (previous/next period)
  - [x] Store selected range in URL params
  - [x] Add date validation logic

- [x] **Task 4: Implement Fuel Type Toggle** (AC: 4)
  - [x] Create src/components/features/analytics/FuelTypeToggle.tsx
  - [x] Build tab navigation for fuel types
  - [x] Add "All fuels" comparison option
  - [x] Implement smooth transitions between views
  - [x] Sync with chart data updates
  - [x] Add active state indicators

- [x] **Task 5: Create Comparison Chart** (AC: 2)
  - [x] Create src/components/charts/ComparisonChart.tsx
  - [x] Display user prices vs market average
  - [x] Add difference visualization (area between lines)
  - [x] Implement percentage difference overlay
  - [x] Color code advantageous periods
  - [x] Add market position indicators

- [x] **Task 6: Build Statistics Panel** (AC: 6)
  - [x] Create src/components/features/analytics/StatisticsPanel.tsx
  - [x] Calculate and display average price
  - [x] Show minimum price with date
  - [x] Show maximum price with date
  - [x] Calculate and display volatility
  - [x] Add trend direction indicator
  - [x] Include price change summary

- [x] **Task 7: Create Analytics Store** (AC: All)
  - [x] Create src/stores/analyticsStore.ts
  - [x] Store historical price data
  - [x] Manage selected date range
  - [x] Handle fuel type selection
  - [x] Cache fetched data by range
  - [x] Implement data aggregation logic
  - [x] Add loading and error states

- [x] **Task 8: Build Analytics Service** (AC: 1, 2, 6)
  - [x] Create src/services/analytics.service.ts
  - [x] Implement getStationHistory() method
  - [x] Implement getMarketTrends() method
  - [x] Add getTrendAnalysis() method
  - [x] Create data transformation utilities
  - [x] Handle gap filling in time series
  - [x] Implement request caching

- [x] **Task 9: Create Historical Trends Page** (AC: All)
  - [x] Create src/pages/analytics/HistoricalTrends.tsx
  - [x] Layout with chart as main focus
  - [x] Add controls above chart
  - [x] Place statistics below chart
  - [x] Implement responsive layout
  - [x] Add export functionality
  - [x] Include refresh button

- [x] **Task 10: Implement Data Processing** (AC: 2, 6)
  - [x] Create src/utils/trendCalculations.ts
  - [x] Calculate moving averages
  - [x] Implement volatility calculation
  - [x] Add trend detection algorithm
  - [x] Create market comparison logic
  - [x] Handle missing data points
  - [x] Add seasonal pattern detection

- [ ] **Task 11: Add Chart Interactions** (AC: 3, 5)
  - [ ] Implement zoom controls (+/- buttons)
  - [ ] Add pan gesture support
  - [ ] Create crosshair cursor on hover
  - [ ] Build detailed tooltip with formatting
  - [ ] Add click to focus functionality
  - [ ] Implement reset zoom button
  - [ ] Add keyboard navigation

- [ ] **Task 12: Optimize Performance** (AC: 3, 4)
  - [ ] Implement data decimation for large datasets
  - [ ] Add virtualization for long time periods
  - [ ] Use React.memo for chart components
  - [ ] Implement lazy loading for charts
  - [ ] Add request debouncing
  - [ ] Cache rendered chart states

- [ ] **Task 13: Write Unit Tests** (AC: All)
  - [ ] Test statistical calculations
  - [ ] Test date range logic
  - [ ] Test data transformation
  - [ ] Test chart configuration
  - [ ] Test tooltip formatting
  - [ ] Test responsive behavior

- [ ] **Task 14: Write Integration Tests** (AC: 1, 2, 6)
  - [ ] Test API data fetching
  - [ ] Test chart rendering with data
  - [ ] Test date range changes
  - [ ] Test fuel type switching
  - [ ] Test zoom/pan functionality
  - [ ] Test statistics updates

## Dev Notes

### Previous Story Context

[Source: Stories 4.1-4.3]

Stories 4.1-4.3 established:

- React app with TypeScript and Vite
- Authentication and dashboard layout
- Current prices and competitor views
- Zustand state management
- API client with interceptors
- Responsive design patterns

### API Endpoints

[Source: apps/api/routes/api/v1.php]
[Source: apps/api/app/Http/Controllers/Api/AnalyticsController.php]

#### Price History

```
GET /api/v1/prices/history/{station_id}
Query params: days (7|15|30), fuel_type
Response: Time series data with gap filling
Cache: 5 minutes
```

#### Station Trends

```
GET /api/v1/trends/station/{id}
Query params: start_date, end_date, period
Response: Trend analysis with volatility, confidence
Cache: 1 hour
```

#### Market Trends

```
GET /api/v1/trends/market
Query params: entidad_id, municipio_id, start_date, end_date, grouping
Response: Regional market aggregation
Cache: 1 hour
```

### Data Structures

[Source: apps/api/app/Services/ChartFormatterService.php]

#### Chart Data Format

```typescript
interface ChartDataPoint {
  date: string; // ISO date
  regular?: number; // Price for regular
  premium?: number; // Price for premium
  diesel?: number; // Price for diesel
  events?: PriceEvent[]; // Price change events
}

interface PriceEvent {
  type: "price_change";
  fuel: FuelType;
  change: number; // Price difference
  changePercent: number; // Percentage change
}
```

#### Statistics Response

```typescript
interface TrendStatistics {
  average: number;
  min: { value: number; date: string };
  max: { value: number; date: string };
  volatility: number; // Standard deviation
  trend: {
    direction: "rising" | "falling" | "stable";
    slope: number;
    confidence: number; // R² value
  };
  changeCount: number; // Number of price changes
}
```

### Charting Library Choice

[Source: Architecture analysis]

**Recommendation: Recharts**

- React-native, no wrapper needed
- TypeScript support out of the box
- Composable chart components
- Built-in animations
- Responsive by default
- Lighter than Chart.js

Installation:

```bash
npm install recharts
```

### Chart Configuration

```typescript
const CHART_CONFIG = {
  colors: {
    regular: "#10B981", // Green
    premium: "#F59E0B", // Amber
    diesel: "#3B82F6", // Blue
    market: "#6B7280", // Gray
    positive: "#10B981", // Green for positive
    negative: "#EF4444", // Red for negative
  },
  animations: {
    duration: 300,
    easing: "ease-in-out",
  },
  margins: {
    top: 20,
    right: 30,
    bottom: 40,
    left: 60,
  },
  responsive: {
    mobile: { height: 300 },
    tablet: { height: 400 },
    desktop: { height: 500 },
  },
};
```

### Statistical Calculations

[Source: apps/api/app/Services/TrendAnalysisService.php]

```typescript
// Volatility calculation (standard deviation)
const calculateVolatility = (prices: number[]): number => {
  if (prices.length < 2) return 0;

  const mean = prices.reduce((a, b) => a + b, 0) / prices.length;
  const squaredDiffs = prices.map((price) => Math.pow(price - mean, 2));
  const variance = squaredDiffs.reduce((a, b) => a + b, 0) / prices.length;

  return Math.sqrt(variance);
};

// Moving average
const calculateMovingAverage = (prices: number[], window: number): number[] => {
  return prices.map((_, index, array) => {
    const start = Math.max(0, index - window + 1);
    const subset = array.slice(start, index + 1);
    return subset.reduce((a, b) => a + b, 0) / subset.length;
  });
};

// Trend detection
const detectTrend = (prices: number[]): "rising" | "falling" | "stable" => {
  // Linear regression to determine trend
  // Returns direction based on slope
};
```

### Date Range Management

```typescript
interface DateRange {
  preset?: "7d" | "15d" | "30d" | "custom";
  startDate: Date;
  endDate: Date;
}

const DATE_PRESETS = {
  "7d": {
    label: "7 días",
    getDates: () => ({
      startDate: subDays(new Date(), 7),
      endDate: new Date(),
    }),
  },
  "15d": {
    label: "15 días",
    getDates: () => ({
      startDate: subDays(new Date(), 15),
      endDate: new Date(),
    }),
  },
  "30d": {
    label: "30 días",
    getDates: () => ({
      startDate: subDays(new Date(), 30),
      endDate: new Date(),
    }),
  },
};
```

### Tooltip Configuration

```typescript
interface TooltipProps {
  active?: boolean;
  payload?: Array<{
    value: number;
    name: string;
    color: string;
  }>;
  label?: string;
}

const CustomTooltip = ({ active, payload, label }: TooltipProps) => {
  if (!active || !payload) return null;

  return (
    <div className="bg-white p-3 rounded-lg shadow-lg border">
      <p className="font-semibold">{formatDate(label)}</p>
      {payload.map((entry) => (
        <div key={entry.name} className="flex items-center gap-2">
          <span
            className="w-3 h-3 rounded-full"
            style={{ backgroundColor: entry.color }}
          />
          <span className="text-sm">
            {entry.name}: ${entry.value.toFixed(2)}
          </span>
        </div>
      ))}
    </div>
  );
};
```

### Performance Optimizations

[Source: Backend caching strategies]

- **Data Caching**: 5-minute TTL for history, 1-hour for trends
- **Request Debouncing**: 300ms delay on date range changes
- **Data Decimation**: Reduce points for periods > 30 days
- **Memoization**: Use React.memo for chart components
- **Lazy Loading**: Load charts only when visible
- **Virtual Scrolling**: For statistics tables with many rows

### Responsive Design

[Source: Story 4.1 breakpoints]

```css
/* Chart height adjustments */
@media (max-width: 768px) {
  .chart-container {
    height: 300px;
  }
}

@media (min-width: 768px) and (max-width: 1024px) {
  .chart-container {
    height: 400px;
  }
}

@media (min-width: 1024px) {
  .chart-container {
    height: 500px;
  }
}
```

### Component File Structure

```
src/
├── pages/
│   └── analytics/
│       └── HistoricalTrends.tsx
├── components/
│   ├── charts/
│   │   ├── TrendChart.tsx
│   │   ├── ComparisonChart.tsx
│   │   └── ChartTooltip.tsx
│   └── features/
│       └── analytics/
│           ├── DateRangeSelector.tsx
│           ├── FuelTypeToggle.tsx
│           └── StatisticsPanel.tsx
├── stores/
│   └── analyticsStore.ts
├── services/
│   └── analytics.service.ts
└── utils/
    └── trendCalculations.ts
```

### Gap Filling Strategy

[Source: apps/api/app/Repositories/HistoricalDataRepository.php]

When data points are missing:

1. Fill with last known price
2. Mark as interpolated in metadata
3. Show visual indicator in chart
4. Include in statistics with notation

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

- **Framework**: Vitest with React Testing Library
- **Coverage Target**: 80% for analytics components
- **Mock Strategy**: Mock chart library for unit tests
- **Data Mocking**: Use factory functions for time series

### Specific Test Cases

1. Test chart renders with valid data
2. Test date range selector updates chart
3. Test fuel type toggle switches data
4. Test zoom and pan functionality
5. Test tooltip displays correct values
6. Test statistics calculations accuracy
7. Test handling of missing data points
8. Test responsive chart resizing
9. Test animation transitions
10. Test performance with large datasets
11. Test API error handling
12. Test cache invalidation on range change

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-30 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

- Task 1 completed: Installed Recharts 3.1.2 and date-fns 4.1.0 dependencies
- Created comprehensive chart configuration with colors, animations, margins, and responsive breakpoints
- Built responsive ChartContainer component with automatic height adjustment based on viewport
- Defined TypeScript interfaces for ChartDataPoint, TrendStatistics, DateRange, and comparison data
- Added chart animation utilities with preset configurations for lines, areas, and transitions
- Created theme configuration with light/dark mode support and consistent styling

- Task 2 completed: Built comprehensive TrendChart component with full interactivity
- Implemented multi-series line chart supporting regular, premium, and diesel fuel types
- Added zoom and pan functionality with mouse interaction and reset controls
- Created custom tooltip component showing formatted date and price values
- Integrated animated transitions between datasets using Recharts animation props
- Built responsive sizing using ChartContainer wrapper with automatic height adjustment
- Added loading skeleton and error states with proper fallback UI

- Task 3 completed: Created comprehensive DateRangeSelector integrated with existing UI store
- Built preset buttons for 7, 15, and 30-day periods with active state indication
- Implemented custom date picker modal with validation and error handling
- Added quick navigation controls (previous/next period) with boundary checking
- Integrated with existing UI store activeFilters.dateRange for consistent state management
- Used shared date utilities from packages/shared instead of external dependencies
- Created robust date validation logic preventing invalid ranges and future dates

- Task 9 completed: Created fully functional HistoricalTrends page demonstrating all components
- Built complete page layout with chart as main focus and responsive design
- Integrated TrendChart and DateRangeSelector components with mock data functionality
- Added control panels above chart with date range and fuel type selection
- Placed statistics cards below chart showing average, min, max, and volatility
- Implemented CSV export functionality with proper Spanish formatting
- Added refresh button with loading states and real-time data simulation

- Task 4 completed: Built comprehensive FuelTypeToggle component with multiple variants
- Created flexible component supporting tabs, buttons, and checkboxes variants
- Implemented smooth framer-motion animations for transitions between fuel selections
- Added "All fuels" selection/deselection functionality with visual feedback
- Built active state indicators with color-coded fuel type dots and check marks
- Integrated seamlessly with chart data updates and state management
- Supports individual fuel toggle, select all, and deselect all operations

- Task 5 completed: Created advanced ComparisonChart for market analysis visualization
- Built sophisticated comparison chart displaying user prices vs market average
- Implemented visual difference areas between lines with color-coded advantages
- Added percentage difference overlay in tooltips with trend indicators
- Color-coded advantageous periods (green for below market, red for above)
- Created market position indicators showing advantage percentage and average difference
- Integrated seamlessly with enhanced data structure supporting market comparison data

- Task 6 completed: Built comprehensive StatisticsPanel with advanced analytics capabilities
- Created StatisticsPanel component with sophisticated statistical calculations including linear regression
- Implemented trend analysis with confidence scoring using R-squared correlation coefficient
- Added volatility calculation using standard deviation with proper mathematical implementation
- Built min/max price tracking with date stamps using shared date formatting utilities
- Created trend direction indicators with visual feedback (rising, falling, stable)
- Included comprehensive price change analysis with significant change count (>1% threshold)
- Added support for three display variants: cards, compact, and detailed layouts
- Integrated framer-motion animations for smooth transitions and loading states
- Successfully replaced basic statistics cards with comprehensive analytics panel

- Task 7 completed: Built comprehensive Analytics Store using Zustand with advanced state management
- Implemented centralized state management for historical data, comparison data, selected fuels, and date ranges
- Created sophisticated caching mechanism with TTL (5 minutes) and cache key generation based on date ranges
- Added data aggregation logic supporting daily, weekly, and monthly periods using moving averages
- Built data fetching abstraction with error handling, loading states, and automatic fallback to mock data
- Integrated with real analytics service API calls while maintaining backward compatibility with mock data
- Implemented fuel type selection management with toggle, select all, and deselect all functionality

- Task 8 completed: Extended existing Analytics Service with comprehensive historical trends functionality
- Added getStationHistory() method for fetching price history data with flexible date range parameters
- Implemented getMarketTrends() method for market comparison data with regional filtering capabilities
- Created getTrendAnalysis() method for advanced statistical analysis with confidence scoring
- Built robust data transformation utilities for converting API responses to standardized chart data formats
- Implemented sophisticated gap filling algorithms supporting last_known, interpolation, and market_average methods
- Added comprehensive request caching system with automatic TTL management and cache invalidation
- Fully integrated analytics service with Analytics Store for seamless data flow and error handling

- Task 10 completed: Implemented comprehensive Data Processing with full integration
- Created comprehensive trend calculations utility with sophisticated mathematical algorithms
- Implemented moving averages (simple and exponential) with configurable window periods
- Built volatility calculation using standard deviation with coefficient of variation analysis
- Added advanced trend detection using linear regression with R-squared confidence scoring
- Created market comparison logic with advantage analysis and competitive positioning metrics
- Implemented missing data analysis with gap detection and data quality assessment
- Added seasonal pattern detection for weekly and monthly price cycles with statistical significance
- Fully integrated all calculations with Analytics Store for automatic computation on data changes
- Enhanced StatisticsPanel component with real-time analytics insights and data quality metrics
- Added comprehensive market comparison visualization with competitive advantage indicators

### File List

**Created:**
- `src/config/charts.ts` - Chart configuration constants, date presets, and fuel type definitions
- `src/components/charts/ChartContainer.tsx` - Responsive container wrapper component for charts
- `src/components/charts/TrendChart.tsx` - Interactive line chart component with zoom, pan, and multi-series support
- `src/components/charts/ComparisonChart.tsx` - Advanced market comparison chart with position indicators and difference visualization
- `src/components/features/analytics/DateRangeSelector.tsx` - Date range selector with presets, custom picker, and UI store integration
- `src/components/features/analytics/FuelTypeToggle.tsx` - Multi-variant fuel type toggle with animations and state management
- `src/components/features/analytics/StatisticsPanel.tsx` - Comprehensive statistics panel with advanced analytics and multiple display variants
- `src/pages/analytics/HistoricalTrends.tsx` - Complete historical trends page with integrated chart, controls, and statistics
- `src/types/charts.ts` - TypeScript interfaces for chart data structures and props
- `src/utils/chartAnimations.ts` - Animation utilities and preset configurations
- `src/config/chartTheme.ts` - Chart theme configuration with light/dark mode support
- `src/stores/analyticsStore.ts` - Zustand store for analytics state management with caching and API integration
- `src/utils/trendCalculations.ts` - Comprehensive data processing utilities with advanced mathematical algorithms

**Modified:**
- `src/router/index.tsx` - Added analytics/trends route and lazy-loaded HistoricalTrends component
- `src/pages/Analytics.tsx` - Updated with navigation link to historical trends page
- `src/pages/analytics/HistoricalTrends.tsx` - Enhanced with chart type toggle, ComparisonChart integration, and real analytics service integration
- `src/services/api/analytics.service.ts` - Extended with historical trends methods, data transformation utilities, gap filling, and caching
- `src/stores/analyticsStore.ts` - Enhanced with comparison data support, real API service integration, and comprehensive trend calculations
- `src/components/features/analytics/StatisticsPanel.tsx` - Enhanced with advanced analytics insights, data quality metrics, and market comparison visualization
- `apps/web/package.json` - Added recharts@3.1.2, date-fns@4.1.0, and framer-motion@12.1.2 dependencies

## QA Results

(To be filled by QA agent)
