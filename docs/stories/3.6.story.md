# Story 3.6: Bot Performance & Error Handling

## Status

Ready for dev

## Story

**As a** platform operator,
**I want** the bot to handle high load and errors gracefully,
**so that** users have a reliable experience.

## Acceptance Criteria

1. Bot handles 100+ concurrent conversations without performance degradation
2. Redis session management maintains conversation state for 30 minutes
3. Timeout handling for API calls with user-friendly timeout messages
4. Error messages in Spanish with clear next steps ("Intenta de nuevo en unos momentos")
5. Admin commands for monitoring bot health and user statistics
6. Graceful degradation when external services (DeepSeek, Laravel API) are unavailable

## Tasks / Subtasks

- [ ] **Task 1: Implement Circuit Breaker for External Services** (AC: 6)
  - [ ] Create app/Services/Telegram/CircuitBreaker.php
  - [ ] Port circuit breaker logic from scraper implementation
  - [ ] Configure for DeepSeek API with 5 failure threshold
  - [ ] Configure for Laravel API with 3 failure threshold
  - [ ] Implement fallback responses for open circuits
  - [ ] Add health check endpoints for circuit status
  - [ ] Log circuit state changes to monitoring

- [ ] **Task 2: Enhance Concurrent Request Handling** (AC: 1)
  - [ ] Create app/Services/Telegram/ConcurrencyManager.php
  - [ ] Implement request queue with configurable concurrency limit
  - [ ] Add connection pooling for Redis operations
  - [ ] Implement request batching for bulk operations
  - [ ] Monitor active conversation count
  - [ ] Add backpressure handling when limit reached

- [ ] **Task 3: Optimize Redis Session Management** (AC: 2)
  - [ ] Enhance SessionManager with connection pooling
  - [ ] Implement session cleanup job for expired sessions
  - [ ] Add session persistence metrics
  - [ ] Create session recovery mechanism
  - [ ] Implement session compression for large data
  - [ ] Add Redis sentinel support for high availability

- [ ] **Task 4: Implement Comprehensive Timeout Handling** (AC: 3)
  - [ ] Create app/Services/Telegram/TimeoutManager.php
  - [ ] Set 2-second timeout for DeepSeek API
  - [ ] Set 5-second timeout for analytics queries
  - [ ] Set 30-second timeout for webhook responses
  - [ ] Implement timeout error messages in Spanish
  - [ ] Add retry logic with exponential backoff

- [ ] **Task 5: Enhance Error Handling System** (AC: 4)
  - [ ] Extend app/Exceptions/TelegramExceptionHandler.php
  - [ ] Create Spanish error message templates
  - [ ] Implement error categorization (recoverable/non-recoverable)
  - [ ] Add user-friendly error codes
  - [ ] Create error recovery suggestions
  - [ ] Log errors with correlation IDs

- [ ] **Task 6: Build Admin Command System** (AC: 5)
  - [ ] Create app/Telegram/Commands/Admin/StatsCommand.php
  - [ ] Create app/Telegram/Commands/Admin/HealthCommand.php
  - [ ] Create app/Telegram/Commands/Admin/CircuitStatusCommand.php
  - [ ] Create app/Telegram/Commands/Admin/SessionsCommand.php
  - [ ] Create app/Telegram/Commands/Admin/ClearCacheCommand.php
  - [ ] Implement admin authentication middleware
  - [ ] Add command usage statistics

- [ ] **Task 7: Implement Performance Monitoring** (AC: 1, 5)
  - [ ] Create app/Services/Telegram/PerformanceMonitor.php
  - [ ] Track response times for each command
  - [ ] Monitor memory usage per conversation
  - [ ] Track database query counts
  - [ ] Implement slow query alerts
  - [ ] Create performance dashboard data
  - [ ] Add Prometheus metrics export

- [ ] **Task 8: Build Graceful Degradation System** (AC: 6)
  - [ ] Create app/Services/Telegram/DegradationManager.php
  - [ ] Define service health levels (healthy/degraded/unhealthy)
  - [ ] Implement fallback responses for each service
  - [ ] Create cached responses for common queries
  - [ ] Add feature toggles for non-critical features
  - [ ] Implement read-only mode for database issues

- [ ] **Task 9: Create Rate Limiting for Bot** (AC: 1)
  - [ ] Implement per-user rate limiting (30 requests/minute)
  - [ ] Add global rate limiting (1000 requests/minute)
  - [ ] Create rate limit exceeded messages in Spanish
  - [ ] Implement sliding window algorithm
  - [ ] Add rate limit headers in responses
  - [ ] Create admin bypass for rate limits

- [ ] **Task 10: Implement Health Check System** (AC: 5, 6)
  - [ ] Create app/Http/Controllers/Telegram/HealthController.php
  - [ ] Add /telegram/health endpoint
  - [ ] Check Redis connectivity
  - [ ] Check database connectivity
  - [ ] Check external service availability
  - [ ] Return structured health status
  - [ ] Add monitoring webhook for alerts

- [ ] **Task 11: Build Load Testing Suite** (AC: 1)
  - [ ] Create tests/Load/TelegramBotLoadTest.php
  - [ ] Simulate 100 concurrent users
  - [ ] Test various command patterns
  - [ ] Measure response times under load
  - [ ] Test circuit breaker activation
  - [ ] Verify graceful degradation

- [ ] **Task 12: Write Unit Tests** (AC: All)
  - [ ] Test circuit breaker state transitions
  - [ ] Test concurrency manager limits
  - [ ] Test timeout handling
  - [ ] Test error message generation
  - [ ] Test admin command authorization
  - [ ] Mock external service failures

- [ ] **Task 13: Write Integration Tests** (AC: 2, 3, 6)
  - [ ] Test Redis session persistence
  - [ ] Test timeout recovery
  - [ ] Test service degradation
  - [ ] Test health check accuracy
  - [ ] Test rate limiting

- [ ] **Task 14: Write Performance Tests** (AC: 1, 5)
  - [ ] Test concurrent conversation handling
  - [ ] Test memory usage under load
  - [ ] Test response time consistency
  - [ ] Test monitoring data accuracy
  - [ ] Test admin command performance

## Dev Notes

### Previous Story Context

[Source: Stories 3.1-3.5 implementations]

Previous stories have established:

- Basic Telegram bot infrastructure (Story 3.1)
- SessionManager with Redis storage (Story 3.1)
- Price query commands (Story 3.2)
- NLP processing with DeepSeek (Story 3.3)
- Analytics and alert system (Story 3.4)
- User preferences and notifications (Story 3.5)

This story focuses on hardening the bot for production use.

### Circuit Breaker Implementation

[Source: apps/scraper/src/utils/circuitBreaker.ts]

Existing circuit breaker pattern to adapt:

```typescript
export enum CircuitBreakerState {
  CLOSED = "CLOSED",
  OPEN = "OPEN",
  HALF_OPEN = "HALF_OPEN",
}

export interface CircuitBreakerOptions {
  failureThreshold?: number; // Default: 5
  cooldownPeriod?: number; // Default: 60000ms
  successThreshold?: number; // Default: 3
}
```

Key features to port:

- Failure tracking with configurable threshold
- Automatic state transitions
- Cooldown period before retry
- Success threshold for recovery
- Integration with monitoring (Sentry)

### Rate Limiting Architecture

[Source: apps/api/app/Http/Middleware/ThrottleByTier.php]
[Source: apps/api/config/rate_limits.php]

Existing tier-based rate limiting:

```php
'tiers' => [
    'free' => 100,        // 100 requests per hour
    'basic' => 500,       // 500 requests per hour
    'premium' => 1000,    // 1000 requests per hour
    'enterprise' => 10000, // 10000 requests per hour
]
```

For Telegram bot, implement:

- Per-user limits based on subscription tier
- Global bot limits to prevent abuse
- Sliding window algorithm for smooth limiting
- Rate limit headers in callback responses

### Error Handling Patterns

[Source: apps/api/app/Exceptions/Handler.php]
[Source: apps/api/app/Services/Telegram/MessageRouter.php]

Existing error handling to extend:

```php
protected function sendErrorMessage(Update $update): void
{
    $chatId = $this->getChatId($update);

    Telegram::sendMessage([
        'chat_id' => $chatId,
        'text' => "❌ Ocurrió un error al procesar tu mensaje. Por favor, intenta de nuevo o contacta a soporte con /help."
    ]);
}
```

Standardized error response format:

```php
$response = [
    'error' => [
        'code' => $errorCode,
        'title' => $this->getErrorTitle($e),
        'detail' => $this->getErrorDetail($e),
        'hint' => $this->getErrorHint($e),
        'correlation_id' => $correlationId,
    ]
];
```

### Session Management Optimization

[Source: apps/api/app/Services/Telegram/SessionManager.php]

Current implementation:

- **TTL**: 30 minutes (const TTL = 1800)
- **Key Pattern**: `telegram:session:{userId}`
- **Storage**: Redis with JSON serialization

Optimizations needed:

- Connection pooling for high concurrency
- Session compression for large data
- Batch operations for cleanup
- Sentinel support for HA

### Performance Monitoring

[Source: apps/api/app/Http/Middleware/PerformanceMonitoring.php]

Metrics to track:

```php
$context = [
    'endpoint' => $request->path(),
    'method' => $request->method(),
    'response_time_ms' => $responseTime,
    'memory_usage_bytes' => $memoryUsage,
    'status_code' => $response->status(),
    'query_count' => count(\DB::getQueryLog() ?? []),
];
```

Additional bot-specific metrics:

- Active conversations count
- Commands per minute
- Average response time by command
- Circuit breaker state changes
- Rate limit hits

### Health Check System

[Source: apps/scraper/src/monitoring/server.ts]

Health check endpoints to implement:

```
GET /telegram/health      - Overall bot health
GET /telegram/metrics     - Prometheus metrics
GET /telegram/status      - Detailed status
```

Health checks:

- Redis connectivity and latency
- Database connectivity
- External API availability (DeepSeek, pricing)
- Circuit breaker states
- Memory and CPU usage
- Active session count

### Admin Commands

New admin commands structure:

```
/admin_stats - User and usage statistics
/admin_health - Service health status
/admin_circuits - Circuit breaker states
/admin_sessions - Active session management
/admin_cache - Cache management
```

Admin authentication:

```php
// Check if user is admin
$adminIds = config('telegram.admin_chat_ids', []);
if (!in_array($chatId, $adminIds)) {
    return "❌ No autorizado";
}
```

### Spanish Error Messages

Error message templates:

```php
const ERROR_MESSAGES = [
    'timeout' => '⏱️ La operación tardó demasiado. Por favor, intenta de nuevo en unos momentos.',
    'rate_limit' => '🚦 Has alcanzado el límite de solicitudes. Intenta de nuevo en {minutes} minutos.',
    'service_unavailable' => '🔧 El servicio está temporalmente no disponible. Estamos trabajando para solucionarlo.',
    'invalid_input' => '❓ No entendí tu solicitud. Usa /help para ver los comandos disponibles.',
    'circuit_open' => '⚡ Servicio en mantenimiento. Por favor, intenta más tarde.',
    'session_expired' => '⏰ Tu sesión ha expirado. Por favor, inicia de nuevo con /start.',
];
```

### Timeout Configuration

[Source: apps/scraper/src/utils/webhookClient.ts]

Timeout settings:

```php
const TIMEOUT_SETTINGS = [
    'deepseek_api' => 2000,      // 2 seconds
    'price_query' => 3000,        // 3 seconds
    'analytics' => 5000,          // 5 seconds
    'webhook' => 30000,           // 30 seconds
    'default' => 10000,           // 10 seconds
];
```

### Graceful Degradation Levels

Service degradation strategy:

```php
const DEGRADATION_LEVELS = [
    'healthy' => [
        'all_features' => true,
    ],
    'degraded' => [
        'disable_nlp' => true,      // Fallback to commands only
        'disable_analytics' => true,  // Use cached data
        'slow_mode' => true,         // Add delays between responses
    ],
    'unhealthy' => [
        'read_only' => true,         // Only allow read operations
        'emergency_responses' => true, // Pre-defined responses only
    ],
];
```

### Environment Variables

Add to .env.example:

```env
# Performance Settings
TELEGRAM_MAX_CONCURRENT_CONVERSATIONS=100
TELEGRAM_RATE_LIMIT_PER_USER=30
TELEGRAM_RATE_LIMIT_GLOBAL=1000
TELEGRAM_SESSION_COMPRESSION=true

# Circuit Breaker
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
CIRCUIT_BREAKER_COOLDOWN_MS=60000
CIRCUIT_BREAKER_SUCCESS_THRESHOLD=3

# Timeouts (milliseconds)
TIMEOUT_DEEPSEEK_API=2000
TIMEOUT_PRICE_QUERY=3000
TIMEOUT_ANALYTICS=5000
TIMEOUT_WEBHOOK=30000

# Admin Configuration
TELEGRAM_ADMIN_CHAT_IDS=123456,789012

# Monitoring
TELEGRAM_HEALTH_CHECK_INTERVAL=60
TELEGRAM_METRICS_ENABLED=true
SENTRY_DSN=
```

### Performance Requirements

[Source: AC 1]

- Support 100+ concurrent conversations
- Response time < 3 seconds for 95% of requests
- Memory usage < 512MB per 100 conversations
- Redis operations < 50ms
- Circuit breaker activation < 100ms
- Health check response < 500ms

### File Structure

[Source: docs/architecture/unified-project-structure.md]

New files to create:

```
apps/api/app/
├── Services/Telegram/
│   ├── CircuitBreaker.php
│   ├── ConcurrencyManager.php
│   ├── TimeoutManager.php
│   ├── PerformanceMonitor.php
│   └── DegradationManager.php
├── Telegram/Commands/Admin/
│   ├── StatsCommand.php
│   ├── HealthCommand.php
│   ├── CircuitStatusCommand.php
│   ├── SessionsCommand.php
│   └── ClearCacheCommand.php
├── Exceptions/
│   └── TelegramExceptionHandler.php
└── Http/Controllers/Telegram/
    └── HealthController.php

apps/api/tests/
├── Load/
│   └── TelegramBotLoadTest.php
└── Performance/
    └── TelegramPerformanceTest.php
```

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

- **Test file location**: apps/api/tests/
- **Load tests**: tests/Load/
- **Performance tests**: tests/Performance/
- **Unit tests**: tests/Unit/Services/Telegram/
- **Integration tests**: tests/Integration/Telegram/
- **Framework**: PHPUnit with Artillery for load testing
- **Coverage minimum**: 90% for critical paths

### Specific Test Cases

1. Test 100 concurrent users sending commands
2. Test circuit breaker activation and recovery
3. Test session persistence under load
4. Test timeout handling for each service
5. Test error messages in Spanish
6. Test admin command authorization
7. Test graceful degradation levels
8. Test rate limiting accuracy
9. Test health check response times
10. Test memory usage under sustained load
11. Test recovery from Redis disconnection
12. Test handling of malformed messages

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-30 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
