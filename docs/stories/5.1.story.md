# Story 5.1: Alert Rules Engine

## Status

Draft

## Story

**As a** platform architect,
**I want** to build a flexible alert rules engine,
**so that** users can receive customized notifications based on their criteria.

## Acceptance Criteria

1. Rules engine supports conditions based on price changes, thresholds, and competitor movements
2. Alert types include immediate (Telegram), daily digest, and weekly summary
3. Rules can combine multiple conditions with AND/OR logic
4. User-specific alert preferences stored and managed through API
5. Alert history tracked with delivery status and user acknowledgment
6. Admin interface to monitor alert volume and delivery success rates

## Tasks / Subtasks

- [ ] Task 1: Create alert rules data models and migrations (AC: 1, 3, 4)
  - [ ] Create AlertRule model with jsonb conditions field for flexible rule storage
  - [ ] Create AlertHistory model for tracking triggered alerts
  - [ ] Create migrations for alert_rules and alert_histories tables
  - [ ] Add indexes for efficient querying by user_id and status

- [ ] Task 2: Implement alert condition evaluator service (AC: 1, 3)
  - [ ] Create AlertEvaluatorService in apps/api/app/Services/
  - [ ] Implement price change detection logic
  - [ ] Implement threshold comparison logic
  - [ ] Implement competitor movement detection
  - [ ] Support AND/OR condition combination logic

- [ ] Task 3: Build alert notification system (AC: 2, 5)
  - [ ] Create AlertNotificationService for dispatching alerts
  - [ ] Implement immediate Telegram notifications via BotMan
  - [ ] Implement daily digest aggregation logic
  - [ ] Implement weekly summary compilation
  - [ ] Track delivery status and acknowledgments

- [ ] Task 4: Create API endpoints for alert management (AC: 4)
  - [ ] POST /api/v1/alerts - Create new alert rule
  - [ ] GET /api/v1/alerts - List user's alert rules
  - [ ] PUT /api/v1/alerts/{id} - Update alert rule
  - [ ] DELETE /api/v1/alerts/{id} - Delete alert rule
  - [ ] GET /api/v1/alerts/history - Get alert trigger history

- [ ] Task 5: Implement alert processing queue job (AC: 1, 2, 5)
  - [ ] Create ProcessAlerts job in apps/api/app/Jobs/
  - [ ] Queue job after each scraper run completion
  - [ ] Evaluate all active rules against new price data
  - [ ] Dispatch notifications based on alert types
  - [ ] Record alert history with status

- [ ] Task 6: Build admin monitoring interface (AC: 6)
  - [ ] Create AlertMonitoringController for admin endpoints
  - [ ] Implement metrics aggregation for alert volume
  - [ ] Track delivery success/failure rates
  - [ ] Create dashboard component in apps/web/src/pages/admin/

- [ ] Task 7: Write comprehensive tests (AC: 1-6)
  - [ ] Unit tests for AlertEvaluatorService logic
  - [ ] Feature tests for alert API endpoints
  - [ ] Integration tests for notification delivery
  - [ ] Queue job tests for alert processing

## Dev Notes

### Data Models

The Alert model already exists in the architecture (data-models.md#alert-model) with the following structure:

- id: uuid - Primary key
- user_id: uuid - Foreign key to User
- name: string - User-defined alert name
- type: enum - 'price_change', 'competitor_move', 'market_trend'
- conditions: jsonb - Alert trigger conditions
- is_active: boolean - Whether alert is enabled
- last_triggered_at: timestamp - Last time alert fired

AlertConditions interface includes:

- fuel_types?: FuelType[]
- threshold_percentage?: number
- threshold_amount?: number
- competitor_stations?: string[]
- radius_km?: number
- comparison_type?: "above" | "below" | "any"
  [Source: architecture/data-models.md#alert-model]

### API Integration

Alert endpoints should follow existing patterns:

- Use Laravel Sanctum for authentication
- Follow REST naming conventions with kebab-case
- Use Cache facade with consistent key naming: `alerts:{user_id}:{property}`
- All heavy operations must be queued
  [Source: architecture/coding-standards.md#critical-fullstack-rules]

### File Locations

Based on the project structure:

- Models: apps/api/app/Models/Alert.php, AlertHistory.php
- Services: apps/api/app/Services/AlertEvaluatorService.php, AlertNotificationService.php
- Controllers: apps/api/app/Http/Controllers/Api/AlertController.php
- Jobs: apps/api/app/Jobs/ProcessAlerts.php
- Migrations: apps/api/database/migrations/
- Admin UI: apps/web/src/pages/admin/alerts/
  [Source: architecture/unified-project-structure.md]

### Technology Stack

- Backend: Laravel 11.x with PHP 8.3+
- Queue System: Laravel Queues with Redis driver
- Bot Framework: BotMan 2.8+ for Telegram integration
- State Management: Zustand 4.4+ for admin dashboard
- Testing: PHPUnit 10.x for backend, Vitest 1.0+ for frontend
  [Source: architecture/tech-stack.md#technology-stack-table]

### Testing Requirements

- Test file locations:
  - Backend: apps/api/tests/Unit/, apps/api/tests/Feature/
  - Frontend: apps/web/tests/unit/
- Follow testing pyramid: 30% unit, 30% integration, 10% E2E
- Alert API tests should verify validation, auth, and response structure
  [Source: architecture/testing-strategy.md#test-organization]

## Testing

### Testing Standards from Architecture

- Backend tests in apps/api/tests/ using PHPUnit
- Test alert rule CRUD operations in Feature/AlertApiTest.php
- Test evaluator logic in Unit/AlertEvaluatorServiceTest.php
- Test notification delivery in Integration/AlertNotificationTest.php
- Frontend admin components in apps/web/tests/unit/
- Use factories for test data generation
- Mock external services (Telegram) in tests
  [Source: architecture/testing-strategy.md]

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-31 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
