# Story 5.3: AI-Powered Recommendations

## Status

Draft

## Story

**As a** multi-station owner,
**I want** AI-generated recommendations based on market analysis for each of my stations,
**so that** I can optimize pricing strategy across my portfolio.

## Acceptance Criteria

1. DeepSeek API analyzes price trends, competitor positions, and historical patterns per station
2. Recommendations consider day of week, holidays, and seasonal patterns for each station's market
3. Suggestions include specific actions with station context ("Station 001: Consider raising Premium by $0.50")
4. Confidence scores indicate recommendation strength based on data quality and station-specific factors
5. A/B testing framework tracks recommendation acceptance and outcomes per station
6. Feedback mechanism allows users to rate recommendation usefulness for each station
7. Portfolio-wide recommendations identify opportunities across multiple stations
8. Station comparison features show which recommendations work best across the network

## Tasks / Subtasks

- [ ] Task 1: Integrate DeepSeek API client with multi-station support (AC: 1)
  - [ ] Create DeepSeekService in apps/api/app/Services/
  - [ ] Configure API credentials in .env
  - [ ] Implement API client with retry logic
  - [ ] Create request/response type definitions with station_numero context
  - [ ] Handle API rate limits and errors per station
  - [ ] Add station-aware prompt generation

- [ ] Task 2: Build station-aware market analysis data preparation (AC: 1, 2)
  - [ ] Create MarketAnalysisService for station-specific data aggregation
  - [ ] Collect competitor pricing data within radius per station
  - [ ] Calculate price trends over time periods by station_numero
  - [ ] Identify day-of-week pricing patterns for each station's market
  - [ ] Detect holiday and seasonal variations specific to station location
  - [ ] Format data for DeepSeek prompt with station context
  - [ ] Add portfolio-wide trend analysis across stations

- [ ] Task 3: Implement station-aware recommendation generation (AC: 1, 3, 4, 7)
  - [ ] Create RecommendationEngine service with station_numero parameter
  - [ ] Build prompts for different recommendation types per station
  - [ ] Parse DeepSeek responses into structured recommendations with station context
  - [ ] Calculate confidence scores based on station-specific data completeness
  - [ ] Generate specific actionable suggestions with station identification
  - [ ] Store recommendations with station metadata and cross-station insights
  - [ ] Implement portfolio-wide recommendation analysis

- [ ] Task 4: Create station-aware recommendation API endpoints (AC: 3, 4, 5, 8)
  - [ ] GET /api/v1/stations/{numero}/recommendations - Get station recommendations
  - [ ] GET /api/v1/recommendations/portfolio - Get portfolio-wide recommendations
  - [ ] POST /api/v1/stations/{numero}/recommendations/generate - Trigger station analysis
  - [ ] POST /api/v1/recommendations/generate-all - Trigger multi-station analysis
  - [ ] PUT /api/v1/recommendations/{id}/accept - Mark as accepted with station context
  - [ ] PUT /api/v1/recommendations/{id}/reject - Mark as rejected with station context
  - [ ] POST /api/v1/recommendations/{id}/feedback - Submit station-specific rating
  - [ ] GET /api/v1/recommendations/comparison - Compare recommendations across stations

- [ ] Task 5: Build station-aware A/B testing framework (AC: 5, 8)
  - [ ] Create RecommendationTracking model and migration with station_numero
  - [ ] Track recommendation presentation to users per station
  - [ ] Record acceptance/rejection decisions by station
  - [ ] Monitor price changes after recommendations per station
  - [ ] Calculate outcome metrics (revenue impact) by station and portfolio
  - [ ] Generate A/B test reports with station comparisons
  - [ ] Track cross-station recommendation effectiveness

- [ ] Task 6: Implement station-aware feedback collection system (AC: 6, 8)
  - [ ] Create feedback rating schema (1-5 stars + comments) with station_numero
  - [ ] Add feedback UI components with station identification
  - [ ] Store feedback with recommendation and station context
  - [ ] Aggregate feedback for model improvement per station and portfolio
  - [ ] Create feedback analytics dashboard with station comparisons
  - [ ] Track recommendation performance across different station types

- [ ] Task 7: Build station-aware recommendation UI components (AC: 3, 4, 6, 7, 8)
  - [ ] Create recommendation card component with station identification
  - [ ] Display confidence scores visually per station
  - [ ] Add accept/reject action buttons with station context
  - [ ] Build feedback modal component for station-specific feedback
  - [ ] Create recommendation history view filterable by station
  - [ ] Add recommendation insights dashboard with portfolio overview
  - [ ] Build station comparison view for recommendation effectiveness
  - [ ] Add portfolio-wide recommendation summary widgets

- [ ] Task 8: Write comprehensive tests for multi-station architecture (AC: 1-8)
  - [ ] Unit tests for RecommendationEngine logic with station parameters
  - [ ] Mock DeepSeek API responses with station context in tests
  - [ ] Test station-specific market analysis data preparation
  - [ ] Feature tests for station-aware recommendation API endpoints
  - [ ] Test A/B tracking logic per station and portfolio
  - [ ] Verify feedback collection flow with station context
  - [ ] Test portfolio-wide recommendation generation
  - [ ] Test cross-station recommendation comparisons

## Dev Notes

### DeepSeek API Integration

- AI/NLP: DeepSeek API (Latest) specified for Spanish NLP
- Create service wrapper for API calls
- Implement proper error handling and retries
- Cache API responses to minimize costs
- Use environment variables for API keys
  [Source: architecture/tech-stack.md#technology-stack-table]

### Market Analysis Data Sources

- PriceChange model for historical pricing data
- Station model for competitor identification
- Calculate trends using change-only storage pattern
- Group data by fuel_type: 'regular', 'premium', 'diesel'
- Consider radius_km from user preferences
  [Source: architecture/data-models.md#pricechange-model]

### File Locations

Based on project structure:

- Services: apps/api/app/Services/DeepSeekService.php, RecommendationEngine.php
- Models: apps/api/app/Models/Recommendation.php, RecommendationTracking.php
- Controllers: apps/api/app/Http/Controllers/Api/RecommendationController.php
- UI Components: apps/web/src/components/features/recommendations/
- Dashboard: apps/web/src/pages/insights/recommendations/
  [Source: architecture/unified-project-structure.md]

### Multi-Station Caching Strategy

- Cache station recommendations: `recommendations:{station_numero}:{user_id}:current`
- Cache portfolio recommendations: `recommendations:portfolio:{user_id}:current`
- Cache market analysis: `analysis:{station_numero}:{date}`
- Cache cross-station comparisons: `comparison:{user_id}:{station_list}:{date}`
- Use Redis for temporary data storage
- Implement cache invalidation on new data per station
- Follow cache key pattern: `{entity}:{station_numero}:{id}:{property}`
  [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Multi-Station Prompt Engineering Considerations

- Include specific station context (numero, location, brand) and competitor data
- Provide historical price trends specific to each station's market
- Specify Mexican fuel market context with regional variations
- Request Spanish language responses with station identification
- Format for structured JSON output with station_numero field
- Include confidence scoring criteria based on station-specific data quality
- Add portfolio context for cross-station insights
- Include market positioning relative to user's other stations

### A/B Testing Implementation

- Track recommendation_id, user_id, action, timestamp
- Store baseline metrics before recommendation
- Monitor changes for defined period (e.g., 7 days)
- Calculate revenue/margin impact
- Use Laravel Queues for async tracking
  [Source: architecture/backend-architecture.md#service-architecture]

## Testing

### Testing Standards from Architecture

- Backend unit tests: apps/api/tests/Unit/
- Test recommendation engine in Unit/RecommendationEngineTest.php
- Mock DeepSeek API calls in tests
- Feature tests: apps/api/tests/Feature/RecommendationApiTest.php
- Frontend tests: apps/web/tests/unit/
- Test recommendation card component rendering
- Verify feedback submission flow
- Use factories for test data generation
  [Source: architecture/testing-strategy.md]

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-31 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
