# Story 4.7: Frontend Station Management Interface

## Status

Draft

## Story

**As a** multi-station owner,
**I want** to search, assign, and manage my stations through the dashboard,
**so that** I can control which stations I monitor and switch between them.

## Acceptance Criteria

1. Station management page accessible from Settings with list of all user stations
2. Search and assign existing stations from the stations database
3. View station details (nombre, direccion, municipio, entidad)
4. Unassign station with confirmation dialog
5. Station switcher component in dashboard header to change active station
6. Display user's role for each station (owner, manager, viewer)
7. Success notifications for all operations in Spanish

## Tasks / Subtasks

- [ ] **Task 1: Create Station Management Page** (AC: 1)
  - [ ] Create src/pages/Stations.tsx page component
  - [ ] Add route /settings/stations to router
  - [ ] Create responsive layout with header and actions
  - [ ] Add navigation link in Settings page
  - [ ] Implement loading state while fetching stations
  - [ ] Add empty state when no stations exist

- [ ] **Task 2: Build Station List Component** (AC: 1)
  - [ ] Create src/components/stations/StationList.tsx
  - [ ] Display stations in card or table format (responsive)
  - [ ] Show station numero, nombre, and address
  - [ ] Add edit and delete action buttons per station
  - [ ] Implement active station indicator
  - [ ] Add search/filter functionality

- [ ] **Task 3: Create Station Search Component** (AC: 2)
  - [ ] Create src/components/stations/StationSearch.tsx
  - [ ] Implement search by numero (PEMEX/CRE ID)
  - [ ] Add filters for municipio and entidad
  - [ ] Search by station nombre (partial match)
  - [ ] Display search results with station details
  - [ ] Add "Assign" button for each result

- [ ] **Task 4: Build Assign Station Modal** (AC: 2, 6)
  - [ ] Create src/components/stations/AssignStationModal.tsx
  - [ ] Show station details before assignment
  - [ ] Select role (owner, manager, viewer)
  - [ ] Confirm assignment action
  - [ ] Show loading state during API call
  - [ ] Handle duplicate assignment errors

- [ ] **Task 5: Implement Unassign Station Functionality** (AC: 4)
  - [ ] Create confirmation dialog component
  - [ ] Show warning message in Spanish
  - [ ] Prevent deletion if only one station exists
  - [ ] Handle cascade implications (prices, alerts)
  - [ ] Show success message after deletion
  - [ ] Refresh station list after delete

- [ ] **Task 6: Create Station Switcher Component** (AC: 5)
  - [ ] Create src/components/layout/StationSwitcher.tsx
  - [ ] Design dropdown or select component
  - [ ] Show current station name and numero
  - [ ] List all stations on click/hover
  - [ ] Highlight current selection
  - [ ] Trigger station change on selection

- [ ] **Task 7: Integrate Station API Service** (AC: All)
  - [ ] Create src/services/api/stations.service.ts
  - [ ] Implement getUserStations() - list user's stations
  - [ ] Implement searchStations() - search available stations
  - [ ] Implement assignStation() - assign station to user
  - [ ] Implement unassignStation() - remove station from user
  - [ ] Add TypeScript interfaces for Station and UserStation

- [ ] **Task 8: Create Station Store (Zustand)** (AC: 5, 6)
  - [ ] Create src/stores/stationStore.ts
  - [ ] Store user stations list and selected station
  - [ ] Implement actions for assign/unassign operations
  - [ ] Add station switching logic
  - [ ] Persist selected station to localStorage
  - [ ] Store user role for each station

- [ ] **Task 9: Update Auth Store Integration** (AC: 1, 6)
  - [ ] Update auth store to handle stations array
  - [ ] Remove old single station field
  - [ ] Set default selected station on login
  - [ ] Include station roles in auth state
  - [ ] Sync station selection between stores
  - [ ] Handle logout to clear station data

- [ ] **Task 10: Implement Success Notifications** (AC: 7)
  - [ ] Use toast notifications from Shadcn/ui
  - [ ] Create success messages for each operation
  - [ ] Add error notifications with details
  - [ ] Implement auto-dismiss after 5 seconds
  - [ ] Allow manual dismissal
  - [ ] Stack multiple notifications

- [ ] **Task 11: Add Station Filtering** (AC: 1, 3)
  - [ ] Filter user stations by role
  - [ ] Filter by municipio/entidad
  - [ ] Sort by nombre or numero
  - [ ] Show station count
  - [ ] Add quick filters (Owner only, etc.)
  - [ ] Implement search within user's stations

- [ ] **Task 12: Update Header Layout** (AC: 5)
  - [ ] Integrate StationSwitcher in Header component
  - [ ] Ensure responsive design on mobile
  - [ ] Update header spacing and alignment
  - [ ] Test with long station names
  - [ ] Add loading state during switch
  - [ ] Show station indicator on mobile

- [ ] **Task 13: Write Unit Tests** (AC: All)
  - [ ] Test station list rendering
  - [ ] Test form validations
  - [ ] Test CRUD operations
  - [ ] Test station switching
  - [ ] Test error handling
  - [ ] Test loading states

- [ ] **Task 14: Write Integration Tests** (AC: 2, 3, 4, 5)
  - [ ] Test complete add station flow
  - [ ] Test edit station flow
  - [ ] Test delete with confirmation
  - [ ] Test station switching persistence
  - [ ] Test API error scenarios
  - [ ] Test form validation messages

## Dev Notes

### Component Structure

```
src/
├── pages/
│   └── Stations.tsx              # Station management page
├── components/
│   ├── stations/
│   │   ├── StationList.tsx      # List of stations
│   │   ├── StationCard.tsx      # Individual station display
│   │   ├── AddStationModal.tsx  # Add new station form
│   │   ├── EditStationModal.tsx # Edit station form
│   │   └── DeleteConfirmation.tsx # Delete confirmation dialog
│   └── layout/
│       └── StationSwitcher.tsx  # Header station selector
├── stores/
│   └── stationStore.ts          # Zustand store for stations
└── services/
    └── api/
        └── stations.service.ts  # Station API service
```

### Station Interfaces

```typescript
// Station from database (read-only)
interface Station {
  numero: string;        // PEMEX/CRE ID (E12345) - Primary Key
  nombre: string;
  direccion: string;
  lat?: number;
  lng?: number;
  municipio_id: number;
  entidad_id: number;
  municipio?: Municipio;
  entidad?: Entidad;
  brand?: string;
  is_active: boolean;
}

// User's assigned station
interface UserStation {
  numero: string;
  nombre: string;
  direccion: string;
  municipio: string;
  entidad: string;
  lat?: number;
  lng?: number;
  role: 'owner' | 'manager' | 'viewer';
  assigned_at: string;
}

// Station assignment request
interface AssignStationData {
  station_numero: string;
  role: 'owner' | 'manager' | 'viewer';
}
```

### Zustand Store Structure

```typescript
interface StationState {
  userStations: UserStation[];
  selectedStation: UserStation | null;
  availableStations: Station[];  // For search results
  isLoading: boolean;
  error: string | null;

  // Actions
  fetchUserStations: () => Promise<void>;
  searchStations: (query: string, filters?: StationFilters) => Promise<void>;
  assignStation: (data: AssignStationData) => Promise<void>;
  unassignStation: (numero: string) => Promise<void>;
  selectStation: (station: UserStation) => void;
  clearError: () => void;
}
```

### Station Search Component

```typescript
const StationSearch = () => {
  const [searchTerm, setSearchTerm] = useState('');
  const { searchStations, availableStations, assignStation } = useStationStore();

  const handleSearch = async () => {
    await searchStations(searchTerm);
  };

  const handleAssign = async (station: Station) => {
    await assignStation({
      station_numero: station.numero,
      role: 'owner'  // Or show role selector
    });
    toast.success(`Estación ${station.nombre} asignada correctamente`);
  };

  return (
    <div>
      <Input 
        placeholder="Buscar por número o nombre..." 
        value={searchTerm}
        onChange={(e) => setSearchTerm(e.target.value)}
      />
      <div className="mt-4 space-y-2">
        {availableStations.map(station => (
          <Card key={station.numero}>
            <CardContent className="flex justify-between items-center">
              <div>
                <p className="font-medium">{station.nombre}</p>
                <p className="text-sm text-muted-foreground">
                  {station.numero} • {station.municipio}, {station.entidad}
                </p>
              </div>
              <Button onClick={() => handleAssign(station)}>
                Asignar
              </Button>
            </CardContent>
          </Card>
        ))}
      </div>
    </div>
  );
};
```

### Station Switcher Design

```tsx
<Select value={selectedStation?.id} onValueChange={handleStationChange}>
  <SelectTrigger className="w-[250px]">
    <div className="flex items-center gap-2">
      <Building2 className="h-4 w-4" />
      <span className="truncate">
        {selectedStation?.nombre || 'Seleccionar estación'}
      </span>
    </div>
  </SelectTrigger>
  <SelectContent>
    {stations.map((station) => (
      <SelectItem key={station.id} value={station.id}>
        <div>
          <div className="font-medium">{station.nombre}</div>
          <div className="text-sm text-muted-foreground">
            {station.numero} • {station.municipio}, {station.estado}
          </div>
        </div>
      </SelectItem>
    ))}
  </SelectContent>
</Select>
```

### User Stations List

```tsx
const UserStationsList = () => {
  const { userStations, selectedStation, selectStation, unassignStation } = useStationStore();

  const handleUnassign = async (numero: string) => {
    if (userStations.length === 1) {
      toast.error('No puedes eliminar tu única estación');
      return;
    }
    
    if (confirm('¿Estás seguro de quitar esta estación?')) {
      await unassignStation(numero);
      toast.success('Estación removida correctamente');
    }
  };

  return (
    <div className="space-y-4">
      {userStations.map(station => (
        <Card 
          key={station.numero}
          className={station.numero === selectedStation?.numero ? 'border-primary' : ''}
        >
          <CardContent className="p-4">
            <div className="flex justify-between items-start">
              <div className="flex-1">
                <h3 className="font-semibold">{station.nombre}</h3>
                <p className="text-sm text-muted-foreground">
                  {station.numero} • {station.municipio}, {station.entidad}
                </p>
                <Badge className="mt-2" variant={
                  station.role === 'owner' ? 'default' : 
                  station.role === 'manager' ? 'secondary' : 'outline'
                }>
                  {station.role === 'owner' ? 'Propietario' :
                   station.role === 'manager' ? 'Gerente' : 'Visor'}
                </Badge>
              </div>
              <div className="space-x-2">
                <Button 
                  size="sm" 
                  variant="outline"
                  onClick={() => selectStation(station)}
                >
                  Seleccionar
                </Button>
                <Button 
                  size="sm" 
                  variant="destructive"
                  onClick={() => handleUnassign(station.numero)}
                >
                  Quitar
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
};
```

### Spanish Error Messages

```typescript
const errorMessages = {
  required: 'Este campo es requerido',
  invalidFormat: 'Formato inválido',
  stationExists: 'Ya existe una estación con este número',
  networkError: 'Error de conexión. Intente nuevamente.',
  serverError: 'Error del servidor. Por favor contacte soporte.',
  deleteLastStation: 'No puede eliminar su única estación',
  updateFailed: 'No se pudo actualizar la estación',
  createFailed: 'No se pudo crear la estación',
  loadFailed: 'Error al cargar las estaciones'
};
```

### Mobile Responsive Considerations

- Station list: Cards on mobile, table on desktop
- Station switcher: Drawer on mobile, dropdown on desktop
- Forms: Single column on mobile, two columns on desktop
- Action buttons: Bottom sheet on mobile, inline on desktop

### API Integration Example

```typescript
class StationService {
  async getUserStations(): Promise<UserStation[]> {
    const response = await apiClient.get('/user/stations');
    return response.data.data;
  }

  async searchStations(query: string, filters?: StationFilters): Promise<Station[]> {
    const response = await apiClient.get('/stations/search', {
      params: { q: query, ...filters }
    });
    return response.data.data;
  }

  async assignStation(data: AssignStationData): Promise<UserStation> {
    const response = await apiClient.post('/user/stations', data);
    return response.data.data;
  }

  async unassignStation(numero: string): Promise<void> {
    await apiClient.delete(`/user/stations/${numero}`);
  }
}
```

## Testing

### Testing Standards

- Framework: Vitest + React Testing Library
- Location: apps/web/tests/
- Coverage target: 85%
- Mock API calls with MSW
- Test on mobile and desktop viewports

### Specific Test Cases

1. Display list of user's assigned stations
2. Search for available stations by numero/name
3. Assign station to user account
4. Display user's role for each station
5. Unassign station shows confirmation
6. Cannot unassign last station
7. Station switcher changes active station
8. Selected station persists on refresh
9. Show Spanish success/error messages
10. Filter search results by municipio/entidad
11. Loading states display correctly
12. Empty state shows when no stations assigned

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-01-04 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)