# Story 1.5: Laravel Application Foundation

## Status

Approved

## Story

**As a** backend developer,
**I want** to establish the core Laravel application with basic health endpoints,
**so that** we can monitor system status and begin building API functionality.

## Acceptance Criteria

1. Laravel application boots successfully with proper database and Redis connections
2. Health check endpoint (/api/health) returns system status including database connectivity, Redis status, and last scraper run time
3. Laravel scheduling configured to trigger Node.js scraper daily at configured time
4. Basic API versioning structure established (/api/v1/)
5. Laravel logs properly configured with daily rotation and error alerting
6. Telescope or similar debugging tool configured for development environment

## Tasks / Subtasks

- [ ] **Task 1: Initialize Laravel application** (AC: 1)
  - [ ] Verify Laravel 11.x installation in apps/api/ from Story 1.1
  - [ ] Configure database connection for PostgreSQL in config/database.php
  - [ ] Configure Redis connection in config/cache.php and config/queue.php
  - [ ] Update .env with proper connection strings
  - [ ] Run `php artisan config:cache` to optimize configuration

- [ ] **Task 2: Create health check endpoint** (AC: 2)
  - [ ] Create HealthController in app/Http/Controllers/
  - [ ] Implement database connectivity check
  - [ ] Implement Redis connectivity check
  - [ ] Query last scraper_runs record for last execution time
  - [ ] Return JSON response with service statuses and versions

- [ ] **Task 3: Set up API versioning structure** (AC: 4)
  - [ ] Create routes/api/v1.php for version 1 routes
  - [ ] Configure RouteServiceProvider to load versioned routes
  - [ ] Set up API prefix and middleware groups
  - [ ] Create base API controller with common response methods
  - [ ] Configure CORS for API endpoints

- [ ] **Task 4: Configure Laravel scheduler** (AC: 3)
  - [ ] Create command to trigger Node.js scraper: `php artisan scraper:run`
  - [ ] Add daily schedule in app/Console/Kernel.php
  - [ ] Configure schedule time via environment variable (SCRAPER_RUN_TIME)
  - [ ] Set up supervisor configuration for schedule:work
  - [ ] Add logging for scheduler execution

- [ ] **Task 5: Set up logging system** (AC: 5)
  - [ ] Configure daily log rotation in config/logging.php
  - [ ] Set up separate channels for different log levels
  - [ ] Configure Sentry integration for error alerting
  - [ ] Add request/response logging middleware
  - [ ] Create custom log formatter for structured logging

- [ ] **Task 6: Install and configure Laravel Telescope** (AC: 6)
  - [ ] Install Telescope package: `composer require laravel/telescope --dev`
  - [ ] Publish Telescope assets and migrations
  - [ ] Run Telescope migrations
  - [ ] Configure Telescope to only run in local/development
  - [ ] Set up authorization for Telescope dashboard

- [ ] **Task 7: Create API documentation structure** (AC: 4)
  - [ ] Install Laravel OpenAPI package or similar
  - [ ] Create initial API documentation template
  - [ ] Document health check endpoint
  - [ ] Set up automatic documentation generation
  - [ ] Configure documentation route (/api/documentation)

- [ ] **Task 8: Implement error handling** (AC: 1, 5)
  - [ ] Create custom exception handler
  - [ ] Configure JSON error responses for API
  - [ ] Set up error logging with context
  - [ ] Create standardized error response format
  - [ ] Add correlation IDs for request tracking

- [ ] **Task 9: Set up middleware stack** (AC: 1, 4)
  - [ ] Configure rate limiting middleware
  - [ ] Add request ID middleware for tracking
  - [ ] Set up API authentication middleware (prepare for future)
  - [ ] Configure trusted proxy settings
  - [ ] Add security headers middleware

- [ ] **Task 10: Create service provider structure** (AC: 1)
  - [ ] Create AppServiceProvider configurations
  - [ ] Set up repository service provider
  - [ ] Configure service container bindings
  - [ ] Register custom validation rules
  - [ ] Set up macro registrations

- [ ] **Task 11: Verify application boot and connections** (AC: 1, 2)
  - [ ] Test database connection with migration status
  - [ ] Verify Redis connection with cache test
  - [ ] Confirm health endpoint returns all green statuses
  - [ ] Test scheduler can execute commands
  - [ ] Verify logs are being written correctly

## Dev Notes

### Previous Story Context

[Source: Stories 1.1-1.4]

- Story 1.1: Laravel project initialized in apps/api/ with environment setup
- Story 1.2: Database schema created with all tables (Approved)
- Story 1.3: External services configured including Sentry DSN (Approved)
- Story 1.4: Node.js scraper implemented, ready for scheduling

### Laravel Configuration

[Source: architecture/tech-stack.md]

**Required Packages:**

- Laravel 11.x (framework)
- Laravel Sanctum 3.3+ (future auth)
- Laravel Telescope 4.x (debugging)
- Sentry/Laravel (error tracking)

**Key Configurations:**

- PHP 8.3+ runtime
- PostgreSQL 15+ database
- Redis 7.0+ for cache/queues
- Supervisor for queue workers

### API Structure

[Source: architecture/backend-architecture.md#controller-organization]

Directory structure to create:

```
apps/api/app/
├── Http/
│   ├── Controllers/
│   │   ├── HealthController.php
│   │   └── Api/
│   │       └── BaseApiController.php
│   ├── Middleware/
│   │   ├── RequestId.php
│   │   └── LogRequests.php
│   └── Requests/
├── Console/
│   └── Commands/
│       └── RunScraperCommand.php
├── Services/
├── Repositories/
└── Exceptions/
    └── Handler.php
```

### Health Check Specification

[Source: architecture/api-specification.md]

**GET /api/health**

```json
{
  "status": "healthy",
  "timestamp": "2024-01-13T10:00:00Z",
  "services": {
    "database": {
      "status": "connected",
      "latency_ms": 5
    },
    "redis": {
      "status": "connected",
      "latency_ms": 2
    },
    "scraper": {
      "last_run": "2024-01-13T05:00:00Z",
      "status": "completed",
      "next_run": "2024-01-14T05:00:00Z"
    }
  },
  "version": {
    "api": "1.0.0",
    "laravel": "11.x",
    "php": "8.3"
  }
}
```

### Scheduler Configuration

[Source: architecture/core-workflows.md#price-scraping-workflow]

The Laravel scheduler should:

1. Run daily at 5 AM (configurable)
2. Execute Node.js scraper via shell command
3. Log execution start/end
4. Handle failures gracefully
5. Send notifications on failure (future)

**Kernel.php Schedule:**

```php
$schedule->command('scraper:run')
    ->dailyAt(config('scraper.run_time', '05:00'))
    ->withoutOverlapping()
    ->appendOutputTo(storage_path('logs/scraper.log'));
```

### Logging Configuration

[Source: architecture/monitoring-and-observability.md]

**Log Channels:**

- `daily`: General application logs with daily rotation
- `error`: Error-level logs for Sentry
- `scraper`: Dedicated scraper execution logs
- `api`: API request/response logs

**Sentry Integration:**

- DSN from Story 1.3: SENTRY_LARAVEL_DSN
- Capture all errors level WARNING and above
- Include user context when available
- Sample rate: 100% for errors, 10% for transactions

### Environment Variables

[Source: Stories 1.1, 1.3]

Required in apps/api/.env:

```
APP_ENV=local
APP_DEBUG=true
APP_URL=http://localhost:8000

DB_CONNECTION=pgsql
DB_HOST=127.0.0.1
DB_PORT=5432
DB_DATABASE=fuelintel
DB_USERNAME=postgres
DB_PASSWORD=

REDIS_HOST=127.0.0.1
REDIS_PASSWORD=null
REDIS_PORT=6379

SENTRY_LARAVEL_DSN=xxx (from Story 1.3)

SCRAPER_RUN_TIME=05:00
SCRAPER_COMMAND="cd ../scraper && npm run scrape"

TELESCOPE_ENABLED=true
```

### API Versioning Strategy

[Source: architecture/api-specification.md]

- Base URL: `/api/v1/`
- Version in URL path (not header)
- Deprecation notices in headers for old versions
- Maintain backward compatibility for 6 months

### Security Considerations

[Source: architecture/security-and-performance.md]

**Required Security Headers:**

- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- X-XSS-Protection: 1; mode=block
- Strict-Transport-Security: max-age=31536000

**Rate Limiting:**

- Default: 60 requests per minute
- Configurable per route
- Return 429 with Retry-After header

## Testing

### Testing Standards

[Source: architecture/testing-strategy.md]

- Feature tests in apps/api/tests/Feature/
- Unit tests in apps/api/tests/Unit/
- Use PHPUnit 10.x
- Mock external services
- Use test database for integration tests

### Specific Test Cases

1. Test health endpoint returns 200 with all services healthy
2. Verify database connection failure returns degraded status
3. Test Redis connection failure handling
4. Verify scheduler can execute scraper command
5. Test API versioning with /api/v1/ prefix
6. Verify Telescope only loads in local environment
7. Test error handler returns JSON for API requests
8. Verify logs rotate daily
9. Test Sentry integration captures errors
10. Verify rate limiting returns 429 after limit exceeded

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-13 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
