# Story 4.5: Analytics Dashboard

## Status

Draft

## Story

**As a** multi-station owner,
**I want** comprehensive analytics for my selected station and portfolio overview,
**so that** I can make informed business decisions for each location.

## Acceptance Criteria

1. Dashboard grid layout with customizable widget arrangement per station
2. Station name/numero displayed prominently in dashboard header
3. KPI cards show station-specific ranking, price spread, and market position
4. Multi-station overview widget showing all stations' performance
5. Mini charts display 7-day trends for selected station's fuel types
6. Alert feed shows recent price changes for selected station
7. Market heat map visualizes price variations in station's region
8. Widget layouts saved per station in localStorage
9. Performance optimized to load all widgets in under 3 seconds
10. Data refreshes when user switches between stations

## Tasks / Subtasks

- [ ] **Task 1: Create Station-Aware Dashboard Grid Layout** (AC: 1, 2, 8)
  - [ ] Create src/pages/dashboard/AnalyticsDashboard.tsx
  - [ ] Display selected station name in header
  - [ ] Implement responsive grid system (12-col desktop, 4-col mobile)
  - [ ] Add react-grid-layout for drag-and-drop
  - [ ] Create layout persistence in localStorage keyed by station_numero
  - [ ] Implement responsive breakpoints
  - [ ] Add reset layout button per station
  - [ ] Create layout templates (default, compact, detailed)

- [ ] **Task 2: Build Station KPI Card Components** (AC: 3, 10)
  - [ ] Create src/components/dashboard/KPICard.tsx
  - [ ] Accept station_numero as prop
  - [ ] Implement station-specific ranking position
  - [ ] Add price spread indicator for station's market
  - [ ] Show market position percentile in station's region
  - [ ] Create loading skeleton states
  - [ ] Add trend arrows and color coding
  - [ ] Implement comparison to previous period
  - [ ] Update KPIs on station change

- [ ] **Task 3: Create Multi-Station Overview Widget** (AC: 4)
  - [ ] Create src/components/dashboard/MultiStationOverview.tsx
  - [ ] Display all user's stations in compact cards
  - [ ] Show key metrics per station (current price, trend)
  - [ ] Highlight best/worst performing stations
  - [ ] Add quick station switch buttons
  - [ ] Calculate portfolio-wide statistics
  - [ ] Implement comparison view
  - [ ] Add station filter/search

- [ ] **Task 4: Create Station Mini Trend Charts** (AC: 5, 10)
  - [ ] Create src/components/dashboard/MiniTrendChart.tsx
  - [ ] Accept station_numero as prop
  - [ ] Build sparkline charts for 7-day trends
  - [ ] Add fuel type labels and colors
  - [ ] Implement hover tooltips
  - [ ] Show min/max indicators
  - [ ] Add percentage change badge
  - [ ] Create responsive sizing
  - [ ] Refresh data on station change

- [ ] **Task 5: Implement Station Alert Feed** (AC: 6)
  - [ ] Create src/components/dashboard/AlertFeed.tsx
  - [ ] Filter alerts by selected station_numero
  - [ ] Build scrollable feed container
  - [ ] Implement alert item component
  - [ ] Add urgency indicators (colors/icons)
  - [ ] Create timestamp formatting
  - [ ] Add mark as read functionality
  - [ ] Clear and reload alerts on station change

- [ ] **Task 6: Build Station Market Heat Map** (AC: 7)
  - [ ] Create src/components/dashboard/MarketHeatMap.tsx
  - [ ] Center map on selected station's region
  - [ ] Integrate map visualization library
  - [ ] Implement color gradient for prices
  - [ ] Add municipality boundaries
  - [ ] Create legend component
  - [ ] Add zoom and pan controls
  - [ ] Re-render map on station change

- [ ] **Task 7: Create Station-Aware Dashboard Store** (AC: All)
  - [ ] Create src/stores/dashboardStore.ts
  - [ ] Store widget data per station_numero
  - [ ] Store layout preferences per station
  - [ ] Manage loading states per widget
  - [ ] Implement parallel data fetching
  - [ ] Add error handling per widget
  - [ ] Cache widget data with TTL per station
  - [ ] Clear cache on station switch

- [ ] **Task 8: Build Station-Aware Dashboard Service** (AC: 3, 4, 6, 7)
  - [ ] Create src/services/dashboard.service.ts
  - [ ] Implement getDashboardMetrics(station_numero) method
  - [ ] Implement getMultiStationOverview() method
  - [ ] Add getAlertFeed(station_numero) method
  - [ ] Create getHeatMapData(station_numero) method
  - [ ] Implement batch API calls
  - [ ] Add request prioritization
  - [ ] Handle partial failures

- [ ] **Task 9: Build Recommendation Cards** (AC: 4)
  - [ ] Create src/components/dashboard/RecommendationCard.tsx
  - [ ] Display recommendation text
  - [ ] Show confidence score
  - [ ] Add impact estimation
  - [ ] Create action buttons
  - [ ] Implement dismiss functionality
  - [ ] Add priority indicators

- [ ] **Task 10: Optimize Performance** (AC: 6)
  - [ ] Implement code splitting for widgets
  - [ ] Add lazy loading for below-fold widgets
  - [ ] Use React.memo for widget components
  - [ ] Implement virtual scrolling for feed
  - [ ] Add progressive data loading
  - [ ] Cache static data in service worker
  - [ ] Optimize bundle size

- [ ] **Task 11: Add Real-time Updates** (AC: 4, 6)
  - [ ] Implement WebSocket connection
  - [ ] Create update handlers per widget
  - [ ] Add fallback to polling (30s)
  - [ ] Show real-time indicators
  - [ ] Handle connection loss gracefully
  - [ ] Implement reconnection logic
  - [ ] Add update animations

- [ ] **Task 12: Create Dashboard Header** (AC: 1)
  - [ ] Build dashboard toolbar
  - [ ] Add date/time display
  - [ ] Create refresh all button
  - [ ] Add export functionality
  - [ ] Implement view mode toggle
  - [ ] Add filter dropdown
  - [ ] Create help tooltip

- [ ] **Task 13: Write Unit Tests** (AC: All)
  - [ ] Test grid layout logic
  - [ ] Test KPI calculations
  - [ ] Test alert feed updates
  - [ ] Test widget error handling
  - [ ] Test performance metrics
  - [ ] Test responsive behavior

- [ ] **Task 14: Write Integration Tests** (AC: 1, 2, 4, 6)
  - [ ] Test dashboard data loading
  - [ ] Test widget interactions
  - [ ] Test layout persistence
  - [ ] Test real-time updates
  - [ ] Test error recovery
  - [ ] Test performance targets

## Dev Notes

### Previous Story Context

[Source: Stories 4.1-4.4]

Stories 4.1-4.4 established:

- React app with authentication and layout
- Current prices and competitor views
- Historical trends with charts
- Zustand stores and services
- Recharts for visualizations

### API Endpoints

[Source: apps/api/routes/api/v1.php]
[Source: apps/api/app/Http/Controllers/Api/AnalysisController.php]

#### Analysis Endpoints

```
GET /api/v1/analysis/ranking
Response: Station rankings by fuel type with percentiles
Cache: 15 minutes

GET /api/v1/analysis/spread
Response: Price spread analysis across fuels
Cache: 15 minutes

GET /api/v1/analysis/insights
Response: Competitive insights and market position
Cache: 15 minutes
```

#### Trend Endpoints

```
GET /api/v1/trends/station/{id}
Query: start_date, end_date, period
Response: Station-specific trends with statistics

GET /api/v1/trends/market
Query: entidad_id, municipio_id, grouping
Response: Market trends for region
```

#### Geographic Data

```
GET /api/v1/geo/heatmap
Response: Municipality-level price data for mapping

GET /api/v1/geo/stats/{municipio}
Response: Statistics for specific municipality
```

### Dashboard Layout

[Source: docs/front-end-spec.md]

Grid system:

- **Mobile (320-767px)**: Single column
- **Tablet (768-1023px)**: 2-column grid
- **Desktop (1024-1919px)**: 3-4 column grid
- **Wide (1920px+)**: Max 1440px centered

Widget sizes:

```typescript
const WIDGET_SIZES = {
  small: { w: 3, h: 2 }, // KPI cards
  medium: { w: 6, h: 3 }, // Mini charts
  large: { w: 9, h: 4 }, // Heat map
  tall: { w: 3, h: 6 }, // Alert feed
};
```

### KPI Metrics

[Source: apps/api/app/Services/RecommendationEngine.php]

```typescript
interface KPIMetrics {
  ranking: {
    overall: number; // Position among all stations
    percentile: number; // Percentile (0-100)
    trend: "up" | "down" | "stable";
    change: number; // Position change from yesterday
  };
  priceSpread: {
    value: number; // Max - Min price
    percentage: number; // As % of average
    comparison: "narrow" | "normal" | "wide";
  };
  marketPosition: {
    vsAverage: number; // % difference from market avg
    competitiveness:
      | "very_competitive"
      | "competitive"
      | "average"
      | "expensive";
    recommendation: string; // Pricing recommendation
  };
}
```

### Alert Feed Structure

[Source: apps/api/app/Services/RecommendationEngine.php]

```typescript
interface Alert {
  id: string;
  type: "price_change" | "recommendation" | "competitor_move" | "market_trend";
  priority: "critical" | "high" | "medium" | "low";
  title: string;
  description: string;
  timestamp: string;
  impact?: {
    type: "revenue" | "margin" | "customers";
    value: number;
    unit: string;
  };
  action?: {
    label: string;
    route: string;
  };
}
```

Priority colors:

- **Critical**: Red (#EF4444)
- **High**: Orange (#F97316)
- **Medium**: Yellow (#F59E0B)
- **Low**: Blue (#3B82F6)

### Heat Map Configuration

```typescript
interface HeatMapConfig {
  center: { lat: 20.6597; lng: -103.3496 }; // Guadalajara
  zoom: 8; // State level
  colorScale: {
    min: "#10B981"; // Green - low prices
    mid: "#F59E0B"; // Yellow - average
    max: "#EF4444"; // Red - high prices
  };
  opacity: 0.6;
  legend: {
    position: "bottomright";
    title: "Precio Promedio";
  };
}
```

### Widget Data Management

```typescript
interface WidgetData {
  id: string;
  type: "kpi" | "chart" | "feed" | "map";
  data: any;
  loading: boolean;
  error: Error | null;
  lastUpdated: string;
  refreshInterval?: number; // milliseconds
}

interface DashboardState {
  widgets: Record<string, WidgetData>;
  layout: ReactGridLayout.Layout[];
  isLoading: boolean;
  lastRefresh: string;
}
```

### Performance Requirements

[Source: AC 6]

Target: Load all widgets in < 3 seconds

Strategies:

1. **Parallel Loading**: Fetch all widget data simultaneously
2. **Progressive Loading**: Show above-fold widgets first
3. **Caching**:
   - KPIs: 15-minute cache
   - Trends: 5-minute cache
   - Heat map: 1-hour cache
4. **Bundle Optimization**:
   - Code split by widget type
   - Lazy load below-fold widgets
   - < 200KB initial bundle

### Real-time Updates

[Source: apps/web/src/components/dashboard/ApiDashboard.tsx]

WebSocket pattern:

```typescript
const WS_EVENTS = {
  PRICE_UPDATE: "price_update",
  ALERT_NEW: "alert_new",
  KPI_UPDATE: "kpi_update",
  RECOMMENDATION: "recommendation_new",
};

// Fallback to polling if WebSocket fails
const POLL_INTERVAL = 30000; // 30 seconds
```

### Recommendation Engine

[Source: apps/api/app/Services/RecommendationEngine.php]

Types:

- **above_average**: Price above market average
- **below_average**: Price below market average
- **optimal_position**: In ideal market position
- **outlier_high**: Significantly above market
- **outlier_low**: Significantly below market
- **competitive_advantage**: Better than competitors

### Responsive Breakpoints

[Source: Story 4.1]

```css
/* Widget visibility */
@media (max-width: 768px) {
  /* Hide heat map on mobile */
  .heat-map-widget {
    display: none;
  }
}

@media (min-width: 768px) {
  /* 2-column grid */
  .dashboard-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 1024px) {
  /* 4-column grid */
  .dashboard-grid {
    grid-template-columns: repeat(4, 1fr);
  }
}
```

### Component File Structure

```
src/
├── pages/
│   └── dashboard/
│       └── AnalyticsDashboard.tsx
├── components/
│   └── dashboard/
│       ├── KPICard.tsx
│       ├── MiniTrendChart.tsx
│       ├── AlertFeed.tsx
│       ├── MarketHeatMap.tsx
│       ├── RecommendationCard.tsx
│       ├── WidgetContainer.tsx
│       └── DashboardHeader.tsx
├── stores/
│   └── dashboardStore.ts
├── services/
│   └── dashboard.service.ts
└── utils/
    └── dashboardHelpers.ts
```

### Error Handling

Each widget should handle errors independently:

```typescript
const WidgetErrorBoundary = ({ children, widgetId }) => {
  return (
    <ErrorBoundary
      fallback={
        <div className="p-4 bg-red-50 rounded">
          <p>Error loading widget</p>
          <button onClick={() => refreshWidget(widgetId)}>
            Retry
          </button>
        </div>
      }
    >
      {children}
    </ErrorBoundary>
  );
};
```

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

- **Framework**: Vitest with React Testing Library
- **Coverage Target**: 80% for dashboard components
- **Mock Strategy**: Mock API calls and WebSocket
- **Performance Testing**: Measure load times

### Specific Test Cases

1. Test grid layout responsiveness
2. Test widget drag and drop
3. Test KPI calculations accuracy
4. Test alert feed real-time updates
5. Test heat map rendering
6. Test performance < 3 second load
7. Test error recovery per widget
8. Test WebSocket reconnection
9. Test layout persistence
10. Test progressive loading
11. Test cache invalidation
12. Test recommendation display

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-30 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
