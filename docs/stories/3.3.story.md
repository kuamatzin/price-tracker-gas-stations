# Story 3.3: Natural Language Processing Integration

## Status

Done

## Story

**As a** conversational user,
**I want** to ask questions in natural Spanish,
**so that** I don't need to memorize specific commands.

## Acceptance Criteria

1. Bot understands variations like "cuánto está la premium?", "precio de diesel", "gasolina verde"
2. DeepSeek API integration processes natural language with <2 second response time
3. Context maintained for follow-up questions ("¿y la regular?" after asking about premium)
4. Bot handles typos and colloquialisms common in Mexican Spanish
5. Fallback to command suggestions when natural language isn't understood
6. Natural language queries logged for continuous improvement

## Tasks / Subtasks

- [x] **Task 1: Create DeepSeek API Service Layer** (AC: 2)
  - [x] Create app/Services/External/DeepSeekService.php
  - [x] Implement API client with timeout handling (2 second max)
  - [x] Add retry logic with exponential backoff
  - [x] Implement response caching for repeated queries
  - [x] Create config/deepseek.php configuration file
  - [x] Add environment variables to .env.example

- [x] **Task 2: Implement NLP Message Processor** (AC: 1, 4)
  - [x] Create app/Services/Telegram/NlpProcessor.php
  - [x] Extend CommandParser to detect more natural variations
  - [x] Implement fuel type normalization (verde->regular, magna->regular, roja->premium)
  - [x] Add typo correction using Levenshtein distance
  - [x] Map colloquialisms to standard commands
  - [x] Extract intent and entities from natural queries

- [x] **Task 3: Enhance Session Context Management** (AC: 3)
  - [x] Extend TelegramSession to store conversation context
  - [x] Add conversation_context field to session data structure
  - [x] Implement context merging for follow-up questions
  - [x] Add context expiry (5 minutes for follow-ups)
  - [x] Store last query intent and entities
  - [x] Implement context-aware response generation

- [x] **Task 4: Integrate NLP with MessageRouter** (AC: 1, 2, 5)
  - [x] Modify app/Services/Telegram/MessageRouter.php handleNaturalLanguage method
  - [x] Route natural queries through NlpProcessor first
  - [x] If NLP confidence > 0.7, execute interpreted command
  - [x] If confidence < 0.7, use DeepSeek API for deeper analysis
  - [x] Implement fallback flow to suggest similar commands
  - [x] Add response time monitoring

- [x] **Task 5: Implement Query Logging System** (AC: 6)
  - [x] Create nlp_queries table migration
  - [x] Store: query, interpreted_intent, confidence, response_time, success
  - [x] Create NlpQueryRepository for data access
  - [x] Add async job for query logging (don't block response)
  - [x] Create analytics endpoint for query analysis
  - [x] Implement daily report of unrecognized queries

- [x] **Task 6: Build DeepSeek Integration** (AC: 2, 4)
  - [x] Create DeepSeekClient class with proper error handling
  - [x] Implement Spanish-optimized system prompt
  - [x] Add context injection for fuel price domain
  - [x] Configure temperature and max_tokens for consistency
  - [x] Handle API timeouts gracefully
  - [x] Implement response parsing and validation

- [x] **Task 7: Create Fallback Command Suggester** (AC: 5)
  - [x] Build command similarity matcher
  - [x] Generate "Did you mean?" suggestions
  - [x] Rank suggestions by relevance
  - [x] Format suggestions with inline keyboard
  - [x] Track suggestion acceptance rate

- [x] **Task 8: Write Unit Tests** (AC: All)
  - [x] Test NlpProcessor intent extraction
  - [x] Test typo correction algorithm
  - [x] Test colloquialism mapping
  - [x] Test context merging logic
  - [x] Test DeepSeek API timeout handling
  - [x] Test fallback suggestion generation
  - [x] Mock external API calls

- [x] **Task 9: Write Integration Tests** (AC: 2, 3, 6)
  - [x] Test DeepSeek API real integration
  - [x] Test session context persistence in Redis
  - [x] Test query logging to database
  - [x] Test end-to-end NLP flow
  - [x] Test performance under load

- [x] **Task 10: Write Feature Tests** (AC: 1, 3, 4, 5)
  - [x] Test natural language variations
  - [x] Test multi-turn conversations
  - [x] Test Mexican Spanish colloquialisms
  - [x] Test fallback behavior
  - [x] Test response time requirements

## Dev Notes

### Previous Story Context

[Source: Story 3.2 QA Results]

Story 3.2 successfully implemented price query commands with the following key components that Story 3.3 will build upon:

- Telegram bot command structure using BaseCommand pattern
- SessionManager with Redis storage (30-minute TTL)
- MessageRouter handling text messages and callbacks
- CommandParser with basic keyword detection for natural language
- Error handling patterns with Spanish error messages

### Current Natural Language Infrastructure

[Source: apps/api/app/Services/Telegram/MessageRouter.php]

The MessageRouter already has a basic natural language handler:

```php
if ($this->parser->isNaturalQuery($text)) {
    $this->handleNaturalLanguage($text, $update, $session);
}
```

[Source: apps/api/app/Services/Telegram/CommandParser.php]

CommandParser already detects 50+ Spanish keywords in categories:

- Price keywords: "precio", "cuánto", "cuesta", "valor", "cobran"
- Question keywords: "cuál", "dónde", "cómo", "qué"
- Fuel type mapping: "magna" → regular, "premium" → premium, "diesel" → diesel

### DeepSeek API Configuration

[Source: docs/architecture/tech-stack.md]

- **Technology**: DeepSeek API (Latest version)
- **Purpose**: Natural language processing for Spanish NLP
- **Test Implementation**: scripts/test-deepseek.js already exists
- **Model**: deepseek-chat
- **System Prompt**: "Eres un asistente experto en análisis de precios de gasolina en México"
- **Configuration**: Temperature 0.7, Max tokens 500

### Session Management Architecture

[Source: apps/api/app/Services/Telegram/SessionManager.php]
[Source: apps/api/app/Services/Telegram/TelegramSession.php]

Existing session infrastructure:

- **Storage**: Redis with key pattern `telegram:session:{userId}`
- **TTL**: 30 minutes (const TTL = 1800)
- **Session Data Structure**:
  - state: string (conversation flow state)
  - state_data: array (conversation context data)
  - language: string (default: 'es')
- **Methods**: getState(), setState(), clearState(), getStateData(), addStateData()

### File Structure and Locations

[Source: docs/architecture/unified-project-structure.md]

New files should be created in:

```
apps/api/app/
├── Services/
│   ├── External/
│   │   └── DeepSeekService.php         # NEW: DeepSeek API client
│   └── Telegram/
│       └── NlpProcessor.php            # NEW: NLP message processor
├── Repositories/
│   └── NlpQueryRepository.php          # NEW: Query logging repository
└── Jobs/
    └── LogNlpQuery.php                 # NEW: Async query logging job

apps/api/database/migrations/
└── [timestamp]_create_nlp_queries_table.php  # NEW: Query logging table

apps/api/config/
└── deepseek.php                        # NEW: DeepSeek configuration
```

### Service Layer Patterns

[Source: docs/architecture/backend-architecture.md]
[Source: docs/architecture/coding-standards.md]

- **Never make direct HTTP calls** - use service layer for DeepSeek API
- **Use repository pattern** for data access (NlpQueryRepository)
- **Queue heavy operations** - NLP query logging must be async
- **Handle errors gracefully** with Spanish user messages
- **Use dependency injection** for all services

### Error Handling Pattern

[Source: apps/api/app/Services/Telegram/MessageRouter.php]

Standard error handling pattern to follow:

```php
try {
    // NLP processing
} catch (\Exception $e) {
    Log::error('NLP processing error', [
        'error' => $e->getMessage(),
        'trace' => $e->getTraceAsString()
    ]);
    // Return graceful fallback
}
```

### Testing Requirements

[Source: docs/architecture/testing-strategy.md]

Test structure:

```
apps/api/tests/
├── Unit/
│   ├── Services/
│   │   ├── External/
│   │   │   └── DeepSeekServiceTest.php
│   │   └── Telegram/
│   │       └── NlpProcessorTest.php
├── Integration/
│   └── Telegram/
│       └── NlpIntegrationTest.php
└── Feature/
    └── Telegram/
        └── NaturalLanguageTest.php
```

Test coverage requirements:

- Unit tests: 30% (service components, parsing logic)
- Integration tests: 30% (DeepSeek API, Redis session)
- Feature tests: 30% (end-to-end conversations)
- E2E tests: 10% (complete user flows)

### Data Model

[Source: docs/architecture/data-models.md]

New NLP queries table schema:

```sql
CREATE TABLE nlp_queries (
    id BIGINT PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    chat_id VARCHAR(255),
    original_query TEXT NOT NULL,
    normalized_query TEXT,
    interpreted_intent VARCHAR(100),
    extracted_entities JSONB,
    confidence DECIMAL(3,2),
    response_time_ms INTEGER,
    used_deepseek BOOLEAN DEFAULT FALSE,
    command_executed VARCHAR(100),
    success BOOLEAN,
    fallback_suggested JSONB,
    created_at TIMESTAMP
);
```

### Environment Variables

[Source: Story 3.1 implementation]

Add to .env.example:

```env
DEEPSEEK_API_KEY=
DEEPSEEK_API_URL=https://api.deepseek.com/v1
DEEPSEEK_MODEL=deepseek-chat
DEEPSEEK_MAX_TOKENS=500
DEEPSEEK_TEMPERATURE=0.7
DEEPSEEK_TIMEOUT_SECONDS=2
NLP_CONFIDENCE_THRESHOLD=0.7
NLP_CONTEXT_TTL_SECONDS=300
```

### Mexican Spanish Colloquialisms to Support

Common variations to handle:

- "gasolina verde" → regular
- "la magna" → regular
- "la roja" → premium
- "gasofa" → diesel
- "cuánto anda" → precio
- "a cómo está" → precio
- "qué tal está" → precio

### Performance Requirements

[Source: AC 2]

- DeepSeek API response time: <2 seconds
- Implement timeout handling at 2 seconds
- Cache repeated queries for 5 minutes
- Use async job for query logging

### Critical Implementation Notes

[Source: docs/architecture/coding-standards.md]

- All heavy operations must be queued, never block API responses
- Use Laravel's queue system for NLP query logging
- Implement circuit breaker for DeepSeek API
- Rate limiting: Respect user's api_rate_limit field
- Always validate and sanitize natural language input
- Log all NLP queries for improvement analysis

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

- **Test file location**: apps/api/tests/
- **Unit tests**: tests/Unit/Services/External/, tests/Unit/Services/Telegram/
- **Integration tests**: tests/Integration/Telegram/
- **Feature tests**: tests/Feature/Telegram/
- **Framework**: PHPUnit for all backend tests
- **Mocking**: Mock DeepSeek API calls in unit tests
- **Coverage minimum**: 80% for NLP components

### Specific Test Cases

1. Test natural language variations for each fuel type
2. Test typo correction with common misspellings
3. Test context preservation across multiple queries
4. Test DeepSeek API timeout handling
5. Test fallback suggestions when confidence is low
6. Test Mexican Spanish colloquialisms
7. Test query logging doesn't block response
8. Test session context expiry after 5 minutes
9. Test performance with 100 concurrent NLP requests
10. Test graceful degradation when DeepSeek unavailable

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-30 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References

- DeepSeek API integration with retry logic and timeout handling
- NLP processor with typo correction and colloquialism mapping
- Session context management with TTL and merging capabilities
- Async query logging via Laravel jobs
- Fallback suggestions with inline keyboards

### Completion Notes List

- Implemented full NLP processing pipeline with local and DeepSeek API fallback
- Added comprehensive Mexican Spanish colloquialism support
- Session context maintains conversation state for 5 minutes
- Query logging happens asynchronously to avoid blocking responses
- All response times kept under 2 second threshold
- Fallback suggestions use inline keyboards for better UX
- Created ExternalServiceException for proper error handling
- All tests written with proper mocking of external services

### File List

**Created:**

- apps/api/app/Services/External/DeepSeekService.php
- apps/api/app/Services/Telegram/NlpProcessor.php
- apps/api/app/Repositories/NlpQueryRepository.php
- apps/api/app/Jobs/LogNlpQuery.php
- apps/api/app/Exceptions/ExternalServiceException.php
- apps/api/config/deepseek.php
- apps/api/database/migrations/2025_08_31_145455_create_nlp_queries_table.php
- apps/api/tests/Unit/Services/Telegram/NlpProcessorTest.php
- apps/api/tests/Unit/Services/External/DeepSeekServiceTest.php
- apps/api/tests/Integration/Telegram/NlpIntegrationTest.php
- apps/api/tests/Feature/Telegram/NaturalLanguageTest.php

**Modified:**

- apps/api/app/Services/Telegram/TelegramSession.php
- apps/api/app/Services/Telegram/MessageRouter.php
- apps/api/.env.example

## QA Results

### Review Date: 2025-08-31

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

Excellent implementation of NLP integration with comprehensive natural language processing capabilities. The code demonstrates solid architectural patterns with proper separation of concerns, dependency injection, and asynchronous processing. The integration with DeepSeek API is well-structured with appropriate fallback mechanisms.

### Refactoring Performed

- **File**: apps/api/app/Services/External/DeepSeekService.php
  - **Change**: Added circuit breaker pattern implementation
  - **Why**: To prevent cascading failures when DeepSeek API is down
  - **How**: Tracks failure count and opens circuit after threshold, preventing unnecessary API calls and improving resilience

- **File**: apps/api/app/Services/Telegram/NlpProcessor.php
  - **Change**: Enhanced confidence calculation algorithm
  - **Why**: Original calculation was too simplistic and could produce inconsistent results
  - **How**: Implemented weighted scoring system with intent, entity, and relevance factors for more accurate confidence scores

- **File**: apps/api/tests/Unit/Services/External/DeepSeekServiceTest.php
  - **Change**: Added circuit breaker test coverage
  - **Why**: New functionality needed test validation
  - **How**: Added tests for circuit breaker opening, closing, and availability checks

### Compliance Check

- Coding Standards: ✓ Follows Laravel best practices and PSR standards
- Project Structure: ✓ Files properly organized according to unified-project-structure.md
- Testing Strategy: ✓ Comprehensive unit, integration, and feature tests implemented
- All ACs Met: ✓ All 6 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] Implemented circuit breaker pattern for DeepSeek API resilience
- [x] Enhanced confidence calculation algorithm for better accuracy
- [x] Added missing test coverage for circuit breaker functionality
- [x] Verified all heavy operations are queued (LogNlpQuery job)
- [x] Confirmed proper error handling with Spanish messages
- [x] Validated 2-second timeout handling in DeepSeek service

### Security Review

- API keys properly stored in environment variables ✓
- Input sanitization implemented in NlpProcessor ✓
- No sensitive data logged ✓
- Rate limiting respects user's api_rate_limit field ✓
- Circuit breaker prevents API abuse ✓

### Performance Considerations

- Response time kept under 2-second threshold via timeout configuration ✓
- Caching implemented for repeated queries (5-minute TTL) ✓
- Async job queuing for NLP query logging ✓
- Circuit breaker prevents unnecessary API calls during outages ✓
- Context expiry properly handled (5-minute TTL) ✓

### Final Status

✓ Approved - Ready for Done

All acceptance criteria have been met, code quality is excellent, and the implementation follows all architectural guidelines. The refactoring improvements enhance resilience and accuracy. The story is ready to be marked as Done.
