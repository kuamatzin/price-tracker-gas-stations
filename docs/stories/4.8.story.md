# Story 4.8: Multi-Station Dashboard Updates

## Status

Draft

## Story

**As a** multi-station owner viewing the dashboard,
**I want** all data and features to be filtered by my selected station,
**so that** I can focus on metrics and management for one location at a time.

## Acceptance Criteria

1. Dashboard displays selected station name/numero prominently
2. All price data shows only for selected station (using station_numero)
3. Analytics and charts filter by selected station
4. Competitor data shows stations near selected location
5. Alerts are station-specific and clearly labeled
6. Station selection persists across page navigation and refresh
7. Loading states while switching between stations
8. Handle users with no stations assigned gracefully

## Tasks / Subtasks

- [ ] **Task 1: Update Dashboard Header** (AC: 1)
  - [ ] Add station info display component
  - [ ] Show station nombre and numero
  - [ ] Display station address summary
  - [ ] Add "Change Station" quick action
  - [ ] Ensure mobile responsive design
  - [ ] Add station status indicator

- [ ] **Task 2: Modify Price Display Components** (AC: 2)
  - [ ] Update PriceCard components to show station context
  - [ ] Filter price history by station_numero
  - [ ] Update price form to include station_numero
  - [ ] Clear price cache on station switch
  - [ ] Add station name to price labels
  - [ ] Update empty states with station context

- [ ] **Task 3: Update Analytics Components** (AC: 3)
  - [ ] Pass station_numero to all analytics API calls
  - [ ] Update chart titles with station name
  - [ ] Reset date ranges on station switch
  - [ ] Clear analytics cache on change
  - [ ] Update metric cards for station data
  - [ ] Add station comparison view (future)

- [ ] **Task 4: Enhance Competitor Components** (AC: 4)
  - [ ] Use selected station coordinates for proximity
  - [ ] Update competitor map center to station location
  - [ ] Recalculate distances from selected station
  - [ ] Update competitor list on station change
  - [ ] Show "competitors near [station name]"
  - [ ] Add radius selector for competitor search

- [ ] **Task 5: Update Alert System** (AC: 5)
  - [ ] Filter alerts by station_numero
  - [ ] Add station badge to alert cards
  - [ ] Update alert creation with station context
  - [ ] Group alerts by station in list view
  - [ ] Clear alert cache on station switch
  - [ ] Update notification titles with station

- [ ] **Task 6: Implement Station Context Provider** (AC: 6)
  - [ ] Create StationContext provider
  - [ ] Wrap app with context provider
  - [ ] Provide selected station to all components
  - [ ] Handle station switching logic
  - [ ] Sync with localStorage for persistence
  - [ ] Broadcast station changes to all tabs

- [ ] **Task 7: Add Station Switch Handlers** (AC: 7)
  - [ ] Create loading overlay during switch
  - [ ] Cancel pending API requests
  - [ ] Clear component states
  - [ ] Fetch new station data
  - [ ] Update URL params with station_id
  - [ ] Show success notification

- [ ] **Task 8: Update API Hooks** (AC: 2, 3, 4, 5)
  - [ ] Modify usePrice hook for station context
  - [ ] Update useAnalytics with station filter
  - [ ] Enhance useCompetitors with location
  - [ ] Update useAlerts for station scope
  - [ ] Add station_numero to all API calls
  - [ ] Implement request cancellation

- [ ] **Task 9: Create Station Data Aggregation** (AC: 3)
  - [ ] Build station summary statistics
  - [ ] Calculate station-specific KPIs
  - [ ] Compare station performance metrics
  - [ ] Generate station health score
  - [ ] Track station activity trends
  - [ ] Create station report generator

- [ ] **Task 10: Update Navigation Breadcrumbs** (AC: 1, 6)
  - [ ] Add station name to breadcrumbs
  - [ ] Update page titles with station context
  - [ ] Show station in browser title
  - [ ] Add station to URL structure
  - [ ] Update back navigation behavior
  - [ ] Handle deep linking with station

- [ ] **Task 11: Implement Data Isolation** (AC: 2, 3, 5)
  - [ ] Separate cache keys by station_numero
  - [ ] Prevent data leakage between stations
  - [ ] Clear stale data on switch
  - [ ] Validate data belongs to station
  - [ ] Handle missing station scenarios
  - [ ] Add data integrity checks

- [ ] **Task 12: Add No-Station State** (AC: 8)
  - [ ] Create empty state component for users with no stations
  - [ ] Add "Assign Your First Station" CTA button
  - [ ] Redirect to station management page
  - [ ] Show helpful onboarding message
  - [ ] Prevent access to dashboard features
  - [ ] Display in Spanish with clear instructions

- [ ] **Task 13: Write Unit Tests** (AC: All)
  - [ ] Test station context provider
  - [ ] Test data filtering by station
  - [ ] Test station persistence
  - [ ] Test cache invalidation
  - [ ] Test loading states
  - [ ] Test error scenarios

- [ ] **Task 14: Write Integration Tests** (AC: 1, 6, 7)
  - [ ] Test station switching flow
  - [ ] Test data refresh on switch
  - [ ] Test persistence across navigation
  - [ ] Test multi-tab synchronization
  - [ ] Test deep linking with station
  - [ ] Test fallback behaviors

## Dev Notes

### Station Context Implementation

```typescript
interface StationContextType {
  selectedStation: UserStation | null;
  userStations: UserStation[];
  isLoading: boolean;
  switchStation: (stationNumero: string) => Promise<void>;
  refreshStations: () => Promise<void>;
}

const StationContext = createContext<StationContextType | null>(null);

export const StationProvider: React.FC = ({ children }) => {
  const [selectedStation, setSelectedStation] = useState<UserStation | null>(null);
  const { userStations, fetchUserStations } = useStationStore();

  useEffect(() => {
    // Load persisted station on mount
    const savedStationNumero = localStorage.getItem('selectedStationNumero');
    if (savedStationNumero && userStations.length > 0) {
      const station = userStations.find(s => s.numero === savedStationNumero);
      setSelectedStation(station || userStations[0]);
    }
  }, [userStations]);

  const switchStation = async (stationNumero: string) => {
    // Implementation
  };

  return (
    <StationContext.Provider value={{
      selectedStation,
      userStations,
      isLoading,
      switchStation,
      refreshStations: fetchUserStations
    }}>
      {children}
    </StationContext.Provider>
  );
};
```

### Updated API Hooks Pattern

```typescript
// After multi-station update
const usePrice = () => {
  const { selectedStation } = useStation();
  
  return useQuery(
    ['prices', selectedStation?.numero],
    () => priceService.getCurrentPrices(selectedStation?.numero),
    {
      enabled: !!selectedStation,
      staleTime: 5 * 60 * 1000, // 5 minutes
    }
  );
};
```

### Dashboard Header Update

```tsx
const DashboardHeader = () => {
  const { selectedStation } = useStation();

  return (
    <div className="border-b bg-card">
      <div className="container flex items-center justify-between py-4">
        <div className="flex items-center gap-4">
          <Building2 className="h-6 w-6 text-primary" />
          <div>
            <h1 className="text-xl font-semibold">
              {selectedStation?.nombre || 'Sin estación seleccionada'}
            </h1>
            <p className="text-sm text-muted-foreground">
              {selectedStation?.numero} • {selectedStation?.municipio}, {selectedStation?.estado}
            </p>
          </div>
        </div>
        <StationQuickActions station={selectedStation} />
      </div>
    </div>
  );
};
```

### Price Component Updates

```tsx
const PriceCard = () => {
  const { selectedStation } = useStation();
  const { data: prices, isLoading } = usePrice();

  if (!selectedStation) {
    return (
      <Card>
        <CardContent className="pt-6">
          <Alert>
            <AlertDescription>
              Selecciona una estación para ver los precios
            </AlertDescription>
          </Alert>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Precios Actuales</CardTitle>
        <CardDescription>
          Estación: {selectedStation.nombre}
        </CardDescription>
      </CardHeader>
      <CardContent>
        {/* Price display */}
      </CardContent>
    </Card>
  );
};
```

### Station Switching Flow

```typescript
const handleStationSwitch = async (newStationNumero: string) => {
  // 1. Show loading overlay
  setIsSwitching(true);
  
  // 2. Cancel pending requests
  queryClient.cancelQueries();
  
  // 3. Clear current data
  queryClient.removeQueries(['prices']);
  queryClient.removeQueries(['analytics']);
  queryClient.removeQueries(['alerts']);
  
  // 4. Update selected station
  const newStation = userStations.find(s => s.numero === newStationNumero);
  await switchStation(newStationNumero);
  
  // 5. Save to localStorage
  localStorage.setItem('selectedStationNumero', newStationNumero);
  
  // 6. Broadcast to other tabs
  window.dispatchEvent(new CustomEvent('station-changed', {
    detail: { stationNumero: newStationNumero }
  }));
  
  // 7. Refetch data for new station
  await queryClient.refetchQueries();
  
  // 8. Hide loading
  setIsSwitching(false);
  
  // 9. Show success notification
  toast({
    title: 'Estación cambiada',
    description: `Ahora viendo datos de ${newStation?.nombre}`,
  });
};
```

### URL Structure with Station Context

```typescript
// Routes with station parameter
const routes = [
  {
    path: '/dashboard/:stationId?',
    element: <Dashboard />,
  },
  {
    path: '/prices/:stationId?',
    element: <Prices />,
  },
  {
    path: '/analytics/:stationId?',
    element: <Analytics />,
  },
];

// Hook to sync URL with selected station
const useSyncStationUrl = () => {
  const { selectedStation } = useStation();
  const navigate = useNavigate();
  const location = useLocation();

  useEffect(() => {
    if (selectedStation && !location.pathname.includes(selectedStation.id)) {
      const newPath = location.pathname.replace(
        /\/([^\/]+)(?:\/[^\/]+)?$/,
        `/$1/${selectedStation.id}`
      );
      navigate(newPath, { replace: true });
    }
  }, [selectedStation, location]);
};
```

### Cache Key Strategy

```typescript
// Unique cache keys per station
const cacheKeys = {
  prices: (stationNumero: string) => ['prices', stationNumero],
  analytics: (stationNumero: string, dateRange: DateRange) => 
    ['analytics', stationNumero, dateRange],
  competitors: (stationNumero: string, radius: number) => 
    ['competitors', stationNumero, radius],
  alerts: (stationNumero: string) => ['alerts', stationNumero],
};
```

### Multi-Tab Synchronization

```typescript
// Listen for station changes in other tabs
useEffect(() => {
  const handleStationChange = (event: CustomEvent) => {
    const { stationNumero } = event.detail;
    // Sync this tab with the new selection
    if (stationNumero !== selectedStation?.numero) {
      switchStation(stationNumero);
    }
  };

  window.addEventListener('station-changed', handleStationChange);
  return () => {
    window.removeEventListener('station-changed', handleStationChange);
  };
}, [selectedStation]);
```

### Loading Overlay Component

```tsx
const StationSwitchOverlay = ({ isVisible }: { isVisible: boolean }) => {
  if (!isVisible) return null;

  return (
    <div className="fixed inset-0 z-50 bg-background/80 backdrop-blur-sm">
      <div className="flex h-full items-center justify-center">
        <div className="text-center">
          <Loader2 className="mx-auto h-8 w-8 animate-spin" />
          <p className="mt-2 text-sm text-muted-foreground">
            Cambiando estación...
          </p>
        </div>
      </div>
    </div>
  );
};
```

### No Station State Component

```typescript
const NoStationState = () => {
  const navigate = useNavigate();
  
  return (
    <div className="flex flex-col items-center justify-center h-[60vh]">
      <Building2 className="h-16 w-16 text-muted-foreground mb-4" />
      <h2 className="text-2xl font-semibold mb-2">
        No tienes estaciones asignadas
      </h2>
      <p className="text-muted-foreground text-center max-w-md mb-6">
        Para comenzar a usar el dashboard, necesitas asignar al menos una estación 
        de servicio a tu cuenta.
      </p>
      <Button 
        size="lg"
        onClick={() => navigate('/settings/stations')}
      >
        Asignar Mi Primera Estación
      </Button>
    </div>
  );
};
```

## Testing

### Testing Standards

- Framework: Vitest + React Testing Library
- Location: apps/web/tests/
- Coverage target: 85%
- Test with multiple station scenarios
- Mock station switching delays

### Specific Test Cases

1. Dashboard shows selected station info
2. Price data filters by station
3. Analytics update on station switch
4. Competitors recalculate by location
5. Alerts filter by station
6. Station persists on page refresh
7. Loading overlay during switch
8. Cache clears on station change
9. URL updates with station ID
10. Multi-tab synchronization works
11. Handles missing station gracefully
12. Deep linking with station works

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-01-04 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)