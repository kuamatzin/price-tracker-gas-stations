# Story 2.1: API Authentication & User Management

## Status

Done

## Story

**As a** platform administrator,
**I want** to implement JWT-based authentication and user registration,
**so that** gas station owners can securely access their personalized data.

## Acceptance Criteria

1. User registration endpoint (/api/v1/auth/register) creates accounts with email, password, and station details
2. Login endpoint (/api/v1/auth/login) returns JWT token valid for 24 hours with refresh capability
3. User profile includes station_id, name, location (entidad, municipio), and subscription tier
4. Password reset flow implemented with secure token generation and email notification
5. API middleware validates JWT tokens and attaches user context to all protected routes
6. Rate limiting implemented per user tier (free: 100/hour, paid: 1000/hour)

## Tasks / Subtasks

- [x] **Task 1: Install and configure Laravel Sanctum** (AC: 2, 5)
  - [x] Install Laravel Sanctum: `composer require laravel/sanctum`
  - [x] Publish Sanctum configuration and migrations
  - [x] Run Sanctum migrations
  - [x] Configure Sanctum for API token authentication
  - [x] Set token expiration to 24 hours

- [x] **Task 2: Create authentication controllers** (AC: 1, 2)
  - [x] Create RegisterController in app/Http/Controllers/Auth/
  - [x] Create LoginController with token generation
  - [x] Create LogoutController to revoke tokens
  - [x] Create RefreshController for token refresh
  - [x] Add controllers to routes/api/v1.php

- [x] **Task 3: Implement user registration** (AC: 1, 3)
  - [x] Create RegisterRequest with validation rules
  - [x] Validate email uniqueness and password strength
  - [x] Hash password using bcrypt
  - [x] Create user with station association
  - [x] Return user profile with token on success

- [x] **Task 4: Build login functionality** (AC: 2)
  - [x] Create LoginRequest with email/password validation
  - [x] Verify credentials against database
  - [x] Generate Sanctum token with abilities
  - [x] Include user profile in response
  - [x] Log successful/failed login attempts

- [x] **Task 5: Implement password reset flow** (AC: 4)
  - [x] Create PasswordResetController
  - [x] Generate secure reset token
  - [x] Create password_resets table migration
  - [x] Send reset email with token link
  - [x] Implement token verification and password update

- [x] **Task 6: Create user profile management** (AC: 3)
  - [x] Create ProfileController for user data
  - [x] Implement GET /api/v1/profile endpoint
  - [x] Create PUT /api/v1/profile for updates
  - [x] Include station details in profile
  - [x] Add subscription tier information

- [x] **Task 7: Set up authentication middleware** (AC: 5)
  - [x] Configure auth:sanctum middleware
  - [x] Create middleware to attach user context
  - [x] Apply middleware to protected routes
  - [x] Handle unauthorized access with 401 response
  - [x] Add token validation in middleware

- [x] **Task 8: Implement rate limiting** (AC: 6)
  - [x] Create RateLimitMiddleware
  - [x] Configure limits based on subscription tier
  - [x] Use Redis for rate limit tracking
  - [x] Add rate limit headers to responses
  - [x] Return 429 when limit exceeded

- [x] **Task 9: Create user-station relationship** (AC: 1, 3)
  - [x] Implement user_stations table seeding
  - [x] Create station selection during registration
  - [x] Validate station exists in database
  - [x] Associate user with station role
  - [x] Include station data in user queries

- [x] **Task 10: Add email service configuration** (AC: 4)
  - [x] Configure Laravel mail settings
  - [x] Create email templates for registration
  - [x] Create password reset email template
  - [x] Set up email queue for async sending
  - [x] Test email delivery

- [x] **Task 11: Implement security features** (AC: 1, 2, 4, 5)
  - [x] Add CSRF protection for web routes
  - [x] Implement account lockout after failed attempts
  - [x] Add email verification requirement
  - [x] Log security events (login, password reset)
  - [x] Implement token revocation on password change

## Dev Notes

### Previous Story Context

[Source: Epic 1 Stories]

- Story 1.2: Users table and related tables created (Approved)
- Story 1.5: Laravel foundation with middleware stack ready (Approved)
- Story 1.6: API token authentication pattern established (Approved)

### Authentication Architecture

[Source: architecture/backend-architecture.md#authentication-and-authorization]

**Laravel Sanctum Configuration:**

- Token-based authentication for API
- 24-hour token expiration
- Abilities/scopes for fine-grained permissions
- Token stored in personal_access_tokens table

**JWT Token Structure (via Sanctum):**

```json
{
  "token": "1|a9s8d7f6g5h4j3k2l1...",
  "type": "Bearer",
  "expires_at": "2024-01-14T10:00:00Z",
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "John Doe",
    "station": {
      "numero": "12345",
      "nombre": "Pemex Centro",
      "municipio": "Cuauhtémoc",
      "entidad": "CDMX"
    },
    "subscription_tier": "free"
  }
}
```

### API Endpoints Specification

[Source: architecture/api-specification.md]

**POST /api/v1/auth/register**

```json
// Request
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "password_confirmation": "SecurePass123!",
  "name": "John Doe",
  "station_numero": "12345"
}

// Response (201)
{
  "token": "1|a9s8d7f6g5h4j3k2l1...",
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "John Doe",
    "station": {...},
    "subscription_tier": "free"
  }
}
```

**POST /api/v1/auth/login**

```json
// Request
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}

// Response (200)
{
  "token": "1|a9s8d7f6g5h4j3k2l1...",
  "expires_at": "2024-01-14T10:00:00Z",
  "user": {...}
}
```

### User Model Configuration

[Source: Story 1.2, architecture/data-models.md#user-model]

**User Model Attributes:**

```php
class User extends Authenticatable
{
    use HasApiTokens, HasFactory, Notifiable;

    protected $fillable = [
        'name',
        'email',
        'password',
        'telegram_chat_id',
        'subscription_tier',
        'notification_preferences',
        'api_rate_limit',
    ];

    protected $hidden = [
        'password',
        'remember_token',
    ];

    protected $casts = [
        'email_verified_at' => 'datetime',
        'notification_preferences' => 'array',
        'id' => 'string',
    ];

    public function station()
    {
        return $this->hasOneThrough(
            Station::class,
            UserStation::class,
            'user_id',
            'numero',
            'id',
            'station_numero'
        );
    }
}
```

### Rate Limiting Configuration

[Source: AC 6, architecture/security-and-performance.md]

**Rate Limits by Tier:**

```php
// config/rate_limits.php
return [
    'tiers' => [
        'free' => [
            'requests_per_hour' => 100,
            'burst' => 10,
        ],
        'basic' => [
            'requests_per_hour' => 500,
            'burst' => 50,
        ],
        'premium' => [
            'requests_per_hour' => 1000,
            'burst' => 100,
        ],
    ],
];
```

**Rate Limit Headers:**

```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1705125600
```

### Password Security Requirements

[Source: architecture/security-and-performance.md]

**Password Policy:**

- Minimum 8 characters
- At least 1 uppercase letter
- At least 1 number
- Optional: 1 special character

**Validation Rules:**

```php
'password' => [
    'required',
    'string',
    'min:8',
    'regex:/[A-Z]/',      // must contain uppercase
    'regex:/[0-9]/',      // must contain number
    'confirmed',          // must match password_confirmation
],
```

### Email Configuration

[Source: AC 4]

**Mail Settings (.env):**

```
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=
MAIL_PASSWORD=
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@fuelintel.mx
MAIL_FROM_NAME="${APP_NAME}"
```

**Password Reset Email:**

```php
// app/Mail/ResetPasswordMail.php
public function build()
{
    return $this->markdown('emails.auth.reset')
        ->subject('Restablecer tu contraseña - FuelIntel')
        ->with([
            'token' => $this->token,
            'expiration' => config('auth.passwords.users.expire'),
        ]);
}
```

### Security Middleware Stack

[Source: Story 1.5, AC 5]

**Middleware Application Order:**

```php
// routes/api/v1.php
Route::prefix('v1')->group(function () {
    // Public routes
    Route::post('/auth/register', [RegisterController::class, 'register']);
    Route::post('/auth/login', [LoginController::class, 'login']);
    Route::post('/auth/forgot-password', [PasswordResetController::class, 'sendReset']);

    // Protected routes
    Route::middleware(['auth:sanctum', 'throttle:tier'])->group(function () {
        Route::get('/profile', [ProfileController::class, 'show']);
        Route::put('/profile', [ProfileController::class, 'update']);
        Route::post('/auth/logout', [LogoutController::class, 'logout']);
        Route::post('/auth/refresh', [RefreshController::class, 'refresh']);
    });
});
```

### Database Tables Used

[Source: Story 1.2]

**Tables involved:**

- `users`: User accounts
- `user_stations`: User-station associations
- `stations`: Station details
- `personal_access_tokens`: Sanctum tokens
- `password_resets`: Reset tokens

### Environment Variables

[Source: Stories 1.3, 1.5]

Required additions to apps/api/.env:

```
SANCTUM_STATEFUL_DOMAINS=localhost:3000
SANCTUM_TOKEN_EXPIRATION=1440  # 24 hours in minutes

MAIL_MAILER=smtp
MAIL_HOST=
MAIL_PORT=
MAIL_USERNAME=
MAIL_PASSWORD=
```

## Testing

### Testing Standards

[Source: architecture/testing-strategy.md]

- Feature tests for all authentication endpoints
- Unit tests for token generation and validation
- Test rate limiting enforcement
- Mock email sending in tests

### Specific Test Cases

1. User can register with valid data
2. Registration fails with duplicate email
3. Login returns token with correct expiration
4. Invalid credentials return 401
5. Protected routes require valid token
6. Expired tokens are rejected
7. Password reset email sends successfully
8. Reset token validates and updates password
9. Rate limiting blocks after threshold
10. Different tiers have different limits
11. User profile includes station data
12. Token refresh extends expiration

## Change Log

| Date       | Version | Description             | Author      |
| ---------- | ------- | ----------------------- | ----------- |
| 2025-08-13 | 1.0     | Initial story creation  | BMad Master |
| 2025-08-14 | 2.0     | Implementation complete | James (Dev) |

## Dev Agent Record

### Agent Model Used

claude-opus-4-1-20250805

### Debug Log References

- Sanctum installation and configuration completed successfully
- All authentication endpoints implemented and tested
- Rate limiting middleware configured with tier-based limits
- Account lockout mechanism implemented for failed login attempts
- Email templates created for registration and password reset

### Completion Notes List

1. Sanctum token authentication fully configured with 24-hour expiration
2. All authentication endpoints working: register, login, logout, refresh, password reset
3. Rate limiting implemented based on subscription tiers (free: 100/hr, basic: 500/hr, premium: 1000/hr)
4. Account lockout after 5 failed login attempts for 15 minutes
5. Email templates created for welcome and password reset emails
6. User-station relationship properly established with models and migrations
7. Comprehensive test suite created with 12 test cases covering all authentication flows
8. Security features include: token revocation on password change, CSRF protection, email verification middleware

### File List

**Modified Files:**

- apps/api/app/Models/User.php - Added HasApiTokens trait and station relationship
- apps/api/config/sanctum.php - Set token expiration to 24 hours
- apps/api/routes/api/v1.php - Added authentication routes
- apps/api/bootstrap/app.php - Registered authentication middleware
- apps/api/.env.example - Added mail and Sanctum configuration

**Created Files:**

- apps/api/app/Models/Station.php
- apps/api/app/Models/UserStation.php
- apps/api/app/Models/Municipio.php
- apps/api/app/Models/Entidad.php
- apps/api/app/Models/PriceChange.php
- apps/api/app/Http/Controllers/Auth/RegisterController.php
- apps/api/app/Http/Controllers/Auth/LoginController.php
- apps/api/app/Http/Controllers/Auth/LogoutController.php
- apps/api/app/Http/Controllers/Auth/RefreshController.php
- apps/api/app/Http/Controllers/Auth/PasswordResetController.php
- apps/api/app/Http/Controllers/ProfileController.php
- apps/api/app/Http/Requests/Auth/RegisterRequest.php
- apps/api/app/Http/Requests/Auth/LoginRequest.php
- apps/api/app/Http/Requests/UpdateProfileRequest.php
- apps/api/app/Http/Middleware/AttachUserContext.php
- apps/api/app/Http/Middleware/ThrottleByTier.php
- apps/api/app/Http/Middleware/AccountLockout.php
- apps/api/app/Http/Middleware/EnsureEmailIsVerified.php
- apps/api/app/Mail/ResetPasswordMail.php
- apps/api/config/rate_limits.php
- apps/api/resources/views/emails/auth/reset.blade.php
- apps/api/resources/views/emails/auth/welcome.blade.php
- apps/api/database/migrations/2025_08_14_183751_create_password_resets_table.php
- apps/api/database/seeders/UserStationSeeder.php
- apps/api/tests/Feature/AuthenticationTest.php

## QA Results

- **Date**: 2025-08-15
- **Reviewed By**: Quinn (Senior Developer & QA Architect)
- **Status**: ✅ PASSED - All acceptance criteria met

### Findings

#### ✅ User Registration Endpoint (/api/v1/auth/register)

- Registration endpoint properly implemented with comprehensive validation
- Creates user accounts with email, password, and station association
- Password hashing using bcrypt for security
- Returns JWT token and user profile on successful registration
- Transaction wrapping ensures data consistency
- Station association works correctly via UserStation pivot table

#### ✅ Login Endpoint (/api/v1/auth/login)

- Login endpoint returns valid JWT tokens with 24-hour expiration
- Proper credential validation against database
- Token includes user abilities based on subscription tier
- Revokes all previous tokens on successful login for security
- Includes comprehensive user profile with station data in response
- Proper error handling for invalid credentials

#### ✅ User Profile Implementation

- Profile includes station_id, name, location (entidad, municipio)
- Subscription tier information properly stored and returned
- User-station relationship correctly implemented using hasOneThrough
- Profile endpoints support both GET and PUT operations
- Station data includes numero, nombre, municipio, and entidad

#### ✅ Password Reset Flow

- Secure token generation using 64-character random string
- Password reset tokens properly hashed before storage
- Email notification system implemented with queue support
- Token expiration enforced (60 minutes)
- Password validation includes uppercase, numbers, and confirmation
- All existing tokens revoked on password change for security

#### ✅ JWT Token Authentication Middleware

- Laravel Sanctum properly configured with 24-hour token expiration
- auth:sanctum middleware validates tokens on protected routes
- Proper 401 responses for unauthorized access
- User context attached to authenticated requests
- Token expiration handled correctly

#### ✅ Rate Limiting Implementation

- Tier-based rate limiting implemented (free: 100/hour, premium: 1000/hour)
- Redis-backed rate limiting for scalability
- Proper rate limit headers returned (X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset)
- 429 status code returned when limits exceeded
- Different limits enforced based on subscription tier

### Security Assessment

- ✅ Password hashing using bcrypt
- ✅ Secure token generation for password resets
- ✅ Account lockout after 5 failed login attempts (15-minute lockout)
- ✅ Token revocation on password change
- ✅ Proper validation of all input fields
- ✅ Protection against timing attacks in password reset
- ✅ SQL injection prevention through Eloquent ORM
- ✅ CSRF protection for web routes

### Code Quality Assessment

- ✅ Clean separation of concerns across controllers
- ✅ Proper use of Form Request validation classes
- ✅ Database transactions for data consistency
- ✅ Well-structured middleware with clear responsibilities
- ✅ Comprehensive error handling and logging
- ✅ Proper use of Laravel conventions and best practices
- ✅ Resource loading optimization (lazy loading relationships)

### Test Coverage Analysis

- ✅ Comprehensive test suite with 12 test cases covering all authentication flows
- ✅ Feature tests for all endpoints (register, login, logout, refresh, password reset)
- ✅ Rate limiting enforcement tests
- ✅ Token expiration and validation tests
- ✅ User profile and station relationship tests
- ✅ Edge cases and error conditions covered
- ✅ Proper test database setup with factories and seeders

### Performance Considerations

- ✅ Redis caching for rate limiting prevents database overload
- ✅ Token queries optimized with proper indexing
- ✅ Lazy loading of user relationships to prevent N+1 queries
- ✅ Background queue processing for email notifications
- ✅ Efficient account lockout mechanism using cache

### Integration Points

- ✅ Proper integration with Laravel Sanctum
- ✅ Station data properly linked from existing database
- ✅ Mail configuration ready for production deployment
- ✅ Cache configuration for rate limiting
- ✅ Queue system configured for email processing

### Minor Issues Identified

1. **Test case line 232**: UserStation relationship creation in test may not match the actual hasOneThrough relationship pattern
2. **Rate limiting headers**: Reset time calculation could be more precise for better client experience

### Recommendations

1. **Add API documentation** - Consider implementing OpenAPI/Swagger docs for authentication endpoints
2. **Add refresh token rotation** - Implement refresh token rotation for enhanced security
3. **Add device tracking** - Consider tracking login devices/sessions for security monitoring
4. **Enhanced password policy** - Consider adding additional password complexity requirements
5. **Add audit logging** - Implement comprehensive audit trails for authentication events

### Conclusion

Story 2.1 successfully implements a robust JWT-based authentication system with comprehensive security features. All acceptance criteria have been met with high-quality implementation following Laravel best practices. The authentication system provides secure user registration, login, password reset, and rate limiting functionality with proper test coverage and security considerations.
