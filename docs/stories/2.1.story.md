# Story 2.1: API Authentication & User Management

## Status

Approved

## Story

**As a** platform administrator,
**I want** to implement JWT-based authentication and user registration,
**so that** gas station owners can securely access their personalized data.

## Acceptance Criteria

1. User registration endpoint (/api/v1/auth/register) creates accounts with email, password, and station details
2. Login endpoint (/api/v1/auth/login) returns JWT token valid for 24 hours with refresh capability
3. User profile includes station_id, name, location (entidad, municipio), and subscription tier
4. Password reset flow implemented with secure token generation and email notification
5. API middleware validates JWT tokens and attaches user context to all protected routes
6. Rate limiting implemented per user tier (free: 100/hour, paid: 1000/hour)

## Tasks / Subtasks

- [ ] **Task 1: Install and configure Laravel Sanctum** (AC: 2, 5)
  - [ ] Install Laravel Sanctum: `composer require laravel/sanctum`
  - [ ] Publish Sanctum configuration and migrations
  - [ ] Run Sanctum migrations
  - [ ] Configure Sanctum for API token authentication
  - [ ] Set token expiration to 24 hours

- [ ] **Task 2: Create authentication controllers** (AC: 1, 2)
  - [ ] Create RegisterController in app/Http/Controllers/Auth/
  - [ ] Create LoginController with token generation
  - [ ] Create LogoutController to revoke tokens
  - [ ] Create RefreshController for token refresh
  - [ ] Add controllers to routes/api/v1.php

- [ ] **Task 3: Implement user registration** (AC: 1, 3)
  - [ ] Create RegisterRequest with validation rules
  - [ ] Validate email uniqueness and password strength
  - [ ] Hash password using bcrypt
  - [ ] Create user with station association
  - [ ] Return user profile with token on success

- [ ] **Task 4: Build login functionality** (AC: 2)
  - [ ] Create LoginRequest with email/password validation
  - [ ] Verify credentials against database
  - [ ] Generate Sanctum token with abilities
  - [ ] Include user profile in response
  - [ ] Log successful/failed login attempts

- [ ] **Task 5: Implement password reset flow** (AC: 4)
  - [ ] Create PasswordResetController
  - [ ] Generate secure reset token
  - [ ] Create password_resets table migration
  - [ ] Send reset email with token link
  - [ ] Implement token verification and password update

- [ ] **Task 6: Create user profile management** (AC: 3)
  - [ ] Create ProfileController for user data
  - [ ] Implement GET /api/v1/profile endpoint
  - [ ] Create PUT /api/v1/profile for updates
  - [ ] Include station details in profile
  - [ ] Add subscription tier information

- [ ] **Task 7: Set up authentication middleware** (AC: 5)
  - [ ] Configure auth:sanctum middleware
  - [ ] Create middleware to attach user context
  - [ ] Apply middleware to protected routes
  - [ ] Handle unauthorized access with 401 response
  - [ ] Add token validation in middleware

- [ ] **Task 8: Implement rate limiting** (AC: 6)
  - [ ] Create RateLimitMiddleware
  - [ ] Configure limits based on subscription tier
  - [ ] Use Redis for rate limit tracking
  - [ ] Add rate limit headers to responses
  - [ ] Return 429 when limit exceeded

- [ ] **Task 9: Create user-station relationship** (AC: 1, 3)
  - [ ] Implement user_stations table seeding
  - [ ] Create station selection during registration
  - [ ] Validate station exists in database
  - [ ] Associate user with station role
  - [ ] Include station data in user queries

- [ ] **Task 10: Add email service configuration** (AC: 4)
  - [ ] Configure Laravel mail settings
  - [ ] Create email templates for registration
  - [ ] Create password reset email template
  - [ ] Set up email queue for async sending
  - [ ] Test email delivery

- [ ] **Task 11: Implement security features** (AC: 1, 2, 4, 5)
  - [ ] Add CSRF protection for web routes
  - [ ] Implement account lockout after failed attempts
  - [ ] Add email verification requirement
  - [ ] Log security events (login, password reset)
  - [ ] Implement token revocation on password change

## Dev Notes

### Previous Story Context

[Source: Epic 1 Stories]

- Story 1.2: Users table and related tables created (Approved)
- Story 1.5: Laravel foundation with middleware stack ready (Approved)
- Story 1.6: API token authentication pattern established (Approved)

### Authentication Architecture

[Source: architecture/backend-architecture.md#authentication-and-authorization]

**Laravel Sanctum Configuration:**

- Token-based authentication for API
- 24-hour token expiration
- Abilities/scopes for fine-grained permissions
- Token stored in personal_access_tokens table

**JWT Token Structure (via Sanctum):**

```json
{
  "token": "1|a9s8d7f6g5h4j3k2l1...",
  "type": "Bearer",
  "expires_at": "2024-01-14T10:00:00Z",
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "John Doe",
    "station": {
      "numero": "12345",
      "nombre": "Pemex Centro",
      "municipio": "Cuauhtémoc",
      "entidad": "CDMX"
    },
    "subscription_tier": "free"
  }
}
```

### API Endpoints Specification

[Source: architecture/api-specification.md]

**POST /api/v1/auth/register**

```json
// Request
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "password_confirmation": "SecurePass123!",
  "name": "John Doe",
  "station_numero": "12345"
}

// Response (201)
{
  "token": "1|a9s8d7f6g5h4j3k2l1...",
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "John Doe",
    "station": {...},
    "subscription_tier": "free"
  }
}
```

**POST /api/v1/auth/login**

```json
// Request
{
  "email": "user@example.com",
  "password": "SecurePass123!"
}

// Response (200)
{
  "token": "1|a9s8d7f6g5h4j3k2l1...",
  "expires_at": "2024-01-14T10:00:00Z",
  "user": {...}
}
```

### User Model Configuration

[Source: Story 1.2, architecture/data-models.md#user-model]

**User Model Attributes:**

```php
class User extends Authenticatable
{
    use HasApiTokens, HasFactory, Notifiable;

    protected $fillable = [
        'name',
        'email',
        'password',
        'telegram_chat_id',
        'subscription_tier',
        'notification_preferences',
        'api_rate_limit',
    ];

    protected $hidden = [
        'password',
        'remember_token',
    ];

    protected $casts = [
        'email_verified_at' => 'datetime',
        'notification_preferences' => 'array',
        'id' => 'string',
    ];

    public function station()
    {
        return $this->hasOneThrough(
            Station::class,
            UserStation::class,
            'user_id',
            'numero',
            'id',
            'station_numero'
        );
    }
}
```

### Rate Limiting Configuration

[Source: AC 6, architecture/security-and-performance.md]

**Rate Limits by Tier:**

```php
// config/rate_limits.php
return [
    'tiers' => [
        'free' => [
            'requests_per_hour' => 100,
            'burst' => 10,
        ],
        'basic' => [
            'requests_per_hour' => 500,
            'burst' => 50,
        ],
        'premium' => [
            'requests_per_hour' => 1000,
            'burst' => 100,
        ],
    ],
];
```

**Rate Limit Headers:**

```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1705125600
```

### Password Security Requirements

[Source: architecture/security-and-performance.md]

**Password Policy:**

- Minimum 8 characters
- At least 1 uppercase letter
- At least 1 number
- Optional: 1 special character

**Validation Rules:**

```php
'password' => [
    'required',
    'string',
    'min:8',
    'regex:/[A-Z]/',      // must contain uppercase
    'regex:/[0-9]/',      // must contain number
    'confirmed',          // must match password_confirmation
],
```

### Email Configuration

[Source: AC 4]

**Mail Settings (.env):**

```
MAIL_MAILER=smtp
MAIL_HOST=smtp.mailtrap.io
MAIL_PORT=2525
MAIL_USERNAME=
MAIL_PASSWORD=
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@fuelintel.mx
MAIL_FROM_NAME="${APP_NAME}"
```

**Password Reset Email:**

```php
// app/Mail/ResetPasswordMail.php
public function build()
{
    return $this->markdown('emails.auth.reset')
        ->subject('Restablecer tu contraseña - FuelIntel')
        ->with([
            'token' => $this->token,
            'expiration' => config('auth.passwords.users.expire'),
        ]);
}
```

### Security Middleware Stack

[Source: Story 1.5, AC 5]

**Middleware Application Order:**

```php
// routes/api/v1.php
Route::prefix('v1')->group(function () {
    // Public routes
    Route::post('/auth/register', [RegisterController::class, 'register']);
    Route::post('/auth/login', [LoginController::class, 'login']);
    Route::post('/auth/forgot-password', [PasswordResetController::class, 'sendReset']);

    // Protected routes
    Route::middleware(['auth:sanctum', 'throttle:tier'])->group(function () {
        Route::get('/profile', [ProfileController::class, 'show']);
        Route::put('/profile', [ProfileController::class, 'update']);
        Route::post('/auth/logout', [LogoutController::class, 'logout']);
        Route::post('/auth/refresh', [RefreshController::class, 'refresh']);
    });
});
```

### Database Tables Used

[Source: Story 1.2]

**Tables involved:**

- `users`: User accounts
- `user_stations`: User-station associations
- `stations`: Station details
- `personal_access_tokens`: Sanctum tokens
- `password_resets`: Reset tokens

### Environment Variables

[Source: Stories 1.3, 1.5]

Required additions to apps/api/.env:

```
SANCTUM_STATEFUL_DOMAINS=localhost:3000
SANCTUM_TOKEN_EXPIRATION=1440  # 24 hours in minutes

MAIL_MAILER=smtp
MAIL_HOST=
MAIL_PORT=
MAIL_USERNAME=
MAIL_PASSWORD=
```

## Testing

### Testing Standards

[Source: architecture/testing-strategy.md]

- Feature tests for all authentication endpoints
- Unit tests for token generation and validation
- Test rate limiting enforcement
- Mock email sending in tests

### Specific Test Cases

1. User can register with valid data
2. Registration fails with duplicate email
3. Login returns token with correct expiration
4. Invalid credentials return 401
5. Protected routes require valid token
6. Expired tokens are rejected
7. Password reset email sends successfully
8. Reset token validates and updates password
9. Rate limiting blocks after threshold
10. Different tiers have different limits
11. User profile includes station data
12. Token refresh extends expiration

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-13 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
