# Story 5.4: Predictive Analytics

## Status

Draft

## Story

**As a** strategic planner,
**I want** predictions about future price movements,
**so that** I can plan ahead for market changes.

## Acceptance Criteria

1. Time series analysis predicts likely price movements for next 7 days
2. Predictions based on historical patterns, trends, and seasonal factors
3. Confidence intervals displayed with predictions (e.g., "likely range $19.50-20.50")
4. Market volatility index indicates prediction reliability
5. Backtesting shows prediction accuracy metrics in dashboard
6. API endpoint provides predictions for integration with business planning tools

## Tasks / Subtasks

- [ ] Task 1: Implement time series analysis engine (AC: 1, 2)
  - [ ] Create TimeSeriesAnalysisService in apps/api/app/Services/
  - [ ] Implement ARIMA or Prophet model for forecasting
  - [ ] Process historical PriceChange data
  - [ ] Identify trend components and seasonality
  - [ ] Generate 7-day price predictions

- [ ] Task 2: Build prediction confidence system (AC: 3, 4)
  - [ ] Calculate confidence intervals for predictions
  - [ ] Implement volatility index calculation
  - [ ] Factor in data quality and completeness
  - [ ] Create reliability scoring algorithm
  - [ ] Generate prediction ranges (min/max/likely)

- [ ] Task 3: Develop backtesting framework (AC: 5)
  - [ ] Create BacktestingService for accuracy validation
  - [ ] Compare historical predictions with actual prices
  - [ ] Calculate accuracy metrics (MAE, RMSE, MAPE)
  - [ ] Store backtesting results for analysis
  - [ ] Generate accuracy trend reports

- [ ] Task 4: Create prediction API endpoints (AC: 6)
  - [ ] GET /api/v1/predictions/fuel/{type} - Get predictions by fuel type
  - [ ] GET /api/v1/predictions/station/{numero} - Station-specific predictions
  - [ ] GET /api/v1/predictions/regional - Regional market predictions
  - [ ] GET /api/v1/predictions/accuracy - Backtesting metrics
  - [ ] POST /api/v1/predictions/export - Export for planning tools

- [ ] Task 5: Build seasonal pattern detection (AC: 2)
  - [ ] Identify weekly patterns (weekday vs weekend)
  - [ ] Detect monthly trends
  - [ ] Recognize holiday impact patterns
  - [ ] Account for vacation season variations
  - [ ] Incorporate local event influences

- [ ] Task 6: Create prediction visualization components (AC: 1, 3, 4)
  - [ ] Build prediction chart component with confidence bands
  - [ ] Create volatility indicator widget
  - [ ] Design forecast timeline view
  - [ ] Implement comparison view (predicted vs actual)
  - [ ] Add interactive date range selector

- [ ] Task 7: Implement prediction monitoring (AC: 5)
  - [ ] Create PredictionMonitoringJob for daily checks
  - [ ] Compare predictions with actual prices
  - [ ] Update accuracy metrics automatically
  - [ ] Alert on significant prediction deviations
  - [ ] Generate weekly accuracy reports

- [ ] Task 8: Write comprehensive tests (AC: 1-6)
  - [ ] Unit tests for TimeSeriesAnalysisService
  - [ ] Test prediction algorithm accuracy
  - [ ] Verify confidence interval calculations
  - [ ] Feature tests for prediction API
  - [ ] Test backtesting logic
  - [ ] Validate export functionality

## Dev Notes

### Historical Data Access

- PriceChange model stores all price changes
- Query by station_numero, fuel_type, and date range
- Use changed_at for actual price change timing
- Group by day/week/month for pattern analysis
- Only store changes, reconstruct daily prices as needed
  [Source: architecture/data-models.md#pricechange-model]

### Time Series Implementation

- Consider using PHP-ML or custom implementation
- Alternative: Call Python microservice for advanced models
- Cache predictions to reduce computation
- Update predictions after each scraper run
- Store predictions with timestamp and confidence
  [Source: architecture/tech-stack.md#technology-stack-table]

### File Locations

Based on project structure:

- Services: apps/api/app/Services/TimeSeriesAnalysisService.php, BacktestingService.php
- Models: apps/api/app/Models/Prediction.php, PredictionAccuracy.php
- Controllers: apps/api/app/Http/Controllers/Api/PredictionController.php
- Jobs: apps/api/app/Jobs/PredictionMonitoringJob.php
- UI Components: apps/web/src/components/features/predictions/
- Dashboard: apps/web/src/pages/analytics/predictions/
  [Source: architecture/unified-project-structure.md]

### Performance Optimization

- Cache predictions: `predictions:{station}:{fuel_type}:{date}`
- Pre-calculate common prediction windows
- Use queue jobs for heavy computations
- Implement database indexing for time-series queries
- Consider Redis for temporary calculation storage
  [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Volatility Calculation

- Standard deviation of price changes over period
- Weight recent changes more heavily
- Consider competitor price movements
- Factor in regional market conditions
- Express as percentage or index value

### Export Format Considerations

- Support JSON, CSV, and Excel formats
- Include metadata (confidence, volatility)
- Provide API documentation for integrations
- Implement rate limiting for exports
- Track export usage for analytics

## Testing

### Testing Standards from Architecture

- Backend tests: apps/api/tests/
- Unit tests for prediction algorithms
- Test with various data patterns (stable, volatile, trending)
- Mock time-series calculations in tests
- Feature tests for API endpoints
- Verify export formats and data integrity
- Frontend component tests: apps/web/tests/unit/
- Test chart rendering with mock data
  [Source: architecture/testing-strategy.md]

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-31 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
