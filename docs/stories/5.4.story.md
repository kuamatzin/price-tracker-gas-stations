# Story 5.4: Predictive Analytics

## Status

Draft

## Story

**As a** multi-station owner,
**I want** predictions about future price movements for each of my stations,
**so that** I can plan ahead for market changes across my portfolio.

## Acceptance Criteria

1. Time series analysis predicts likely price movements for next 7 days per station
2. Predictions based on station-specific historical patterns, trends, and seasonal factors
3. Confidence intervals displayed with predictions per station (e.g., "Station 001: likely range $19.50-20.50")
4. Market volatility index indicates prediction reliability for each station's market
5. Backtesting shows prediction accuracy metrics per station in dashboard
6. API endpoints provide station-specific and portfolio-wide predictions for business planning
7. Cross-station prediction patterns identify market-wide trends affecting multiple stations
8. Station comparison views show prediction accuracy and market behavior differences

## Tasks / Subtasks

- [ ] Task 1: Implement station-aware time series analysis engine (AC: 1, 2, 7)
  - [ ] Create TimeSeriesAnalysisService with station_numero parameter in apps/api/app/Services/
  - [ ] Implement ARIMA or Prophet model for station-specific forecasting
  - [ ] Process historical PriceChange data filtered by station_numero
  - [ ] Identify trend components and seasonality per station market
  - [ ] Generate 7-day price predictions per station
  - [ ] Add portfolio-wide trend analysis across stations

- [ ] Task 2: Build station-aware prediction confidence system (AC: 3, 4, 8)
  - [ ] Calculate confidence intervals for predictions per station
  - [ ] Implement volatility index calculation for each station's market
  - [ ] Factor in station-specific data quality and completeness
  - [ ] Create reliability scoring algorithm based on station history
  - [ ] Generate prediction ranges (min/max/likely) per station
  - [ ] Compare confidence levels across stations in portfolio

- [ ] Task 3: Develop station-aware backtesting framework (AC: 5, 8)
  - [ ] Create BacktestingService with station_numero parameter for accuracy validation
  - [ ] Compare historical predictions with actual prices per station
  - [ ] Calculate accuracy metrics (MAE, RMSE, MAPE) by station
  - [ ] Store backtesting results for station-specific analysis
  - [ ] Generate accuracy trend reports with station comparisons
  - [ ] Track prediction performance across different station types and markets

- [ ] Task 4: Create station-aware prediction API endpoints (AC: 6, 7, 8)
  - [ ] GET /api/v1/stations/{numero}/predictions - Get station predictions
  - [ ] GET /api/v1/stations/{numero}/predictions/{fuel_type} - Station predictions by fuel type
  - [ ] GET /api/v1/predictions/portfolio - Portfolio-wide predictions
  - [ ] GET /api/v1/predictions/portfolio/trends - Cross-station trend analysis
  - [ ] GET /api/v1/stations/{numero}/predictions/accuracy - Station backtesting metrics
  - [ ] GET /api/v1/predictions/accuracy/comparison - Compare accuracy across stations
  - [ ] POST /api/v1/predictions/export - Export station and portfolio predictions
  - [ ] GET /api/v1/predictions/regional/{station_numero} - Regional predictions for station's market

- [ ] Task 5: Build station-specific seasonal pattern detection (AC: 2, 7)
  - [ ] Identify weekly patterns (weekday vs weekend) per station market
  - [ ] Detect monthly trends specific to each station's location
  - [ ] Recognize holiday impact patterns by regional market
  - [ ] Account for vacation season variations per station geography
  - [ ] Incorporate local event influences specific to station areas
  - [ ] Compare seasonal patterns across stations in portfolio

- [ ] Task 6: Create station-aware prediction visualization components (AC: 1, 3, 4, 8)
  - [ ] Build prediction chart component with confidence bands per station
  - [ ] Create volatility indicator widget for each station
  - [ ] Design forecast timeline view with station selection
  - [ ] Implement comparison view (predicted vs actual) per station
  - [ ] Add interactive date range selector with station filtering
  - [ ] Build portfolio overview dashboard showing all stations
  - [ ] Create station comparison charts for prediction analysis

- [ ] Task 7: Implement station-aware prediction monitoring (AC: 5, 8)
  - [ ] Create PredictionMonitoringJob for daily checks per station
  - [ ] Compare predictions with actual prices by station
  - [ ] Update accuracy metrics automatically per station
  - [ ] Alert on significant prediction deviations by station
  - [ ] Generate weekly accuracy reports with station breakdowns
  - [ ] Monitor cross-station prediction pattern consistency

- [ ] Task 8: Write comprehensive tests for multi-station architecture (AC: 1-8)
  - [ ] Unit tests for TimeSeriesAnalysisService with station parameters
  - [ ] Test prediction algorithm accuracy per station
  - [ ] Verify confidence interval calculations by station
  - [ ] Feature tests for station-aware prediction API endpoints
  - [ ] Test backtesting logic with station context
  - [ ] Validate export functionality for station and portfolio data
  - [ ] Test cross-station trend analysis
  - [ ] Test station comparison functionality

## Dev Notes

### Historical Data Access

- PriceChange model stores all price changes
- Query by station_numero, fuel_type, and date range
- Use changed_at for actual price change timing
- Group by day/week/month for pattern analysis
- Only store changes, reconstruct daily prices as needed
  [Source: architecture/data-models.md#pricechange-model]

### Time Series Implementation

- Consider using PHP-ML or custom implementation
- Alternative: Call Python microservice for advanced models
- Cache predictions to reduce computation
- Update predictions after each scraper run
- Store predictions with timestamp and confidence
  [Source: architecture/tech-stack.md#technology-stack-table]

### File Locations

Based on project structure:

- Services: apps/api/app/Services/TimeSeriesAnalysisService.php, BacktestingService.php
- Models: apps/api/app/Models/Prediction.php, PredictionAccuracy.php
- Controllers: apps/api/app/Http/Controllers/Api/PredictionController.php
- Jobs: apps/api/app/Jobs/PredictionMonitoringJob.php
- UI Components: apps/web/src/components/features/predictions/
- Dashboard: apps/web/src/pages/analytics/predictions/
  [Source: architecture/unified-project-structure.md]

### Multi-Station Performance Optimization

- Cache station predictions: `predictions:{station_numero}:{fuel_type}:{date}`
- Cache portfolio predictions: `predictions:portfolio:{user_id}:{date}`
- Cache cross-station trends: `trends:portfolio:{user_id}:{date_range}`
- Pre-calculate common prediction windows per station
- Use queue jobs for heavy computations with station context
- Implement database indexing for time-series queries by station_numero
- Consider Redis for temporary calculation storage with station partitioning
- Batch process multiple stations for efficiency
  [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Multi-Station Volatility Calculation

- Standard deviation of price changes over period per station
- Weight recent changes more heavily by station market
- Consider competitor price movements specific to each station's radius
- Factor in regional market conditions per station location
- Express as percentage or index value per station
- Compare volatility patterns across stations in portfolio
- Identify stations with unusual volatility patterns

### Export Format Considerations

- Support JSON, CSV, and Excel formats
- Include metadata (confidence, volatility)
- Provide API documentation for integrations
- Implement rate limiting for exports
- Track export usage for analytics

## Testing

### Testing Standards from Architecture

- Backend tests: apps/api/tests/
- Unit tests for prediction algorithms
- Test with various data patterns (stable, volatile, trending)
- Mock time-series calculations in tests
- Feature tests for API endpoints
- Verify export formats and data integrity
- Frontend component tests: apps/web/tests/unit/
- Test chart rendering with mock data
  [Source: architecture/testing-strategy.md]

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-31 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
