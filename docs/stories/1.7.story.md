# Story 1.7: Testing & CI/CD Setup

## Status

Approved

## Story

**As a** development team,
**I want** automated testing and deployment pipelines configured,
**so that** code quality is maintained and deployments are reliable.

## Acceptance Criteria

1. PHPUnit configured for Laravel with example test for health endpoint passing
2. Vitest configured for React application with example component test passing
3. Jest configured for Node.js scraper with example unit test passing
4. Playwright installed with basic E2E test for login flow (can be marked as pending)
5. GitHub Actions workflow created for CI that runs on all pull requests
6. CI pipeline runs linting, type checking, and all test suites with status checks
7. CD pipeline configured to deploy frontend to Vercel on main branch merge
8. CD pipeline triggers Laravel Forge deployment via webhook on main branch merge
9. Test coverage reporting configured with minimum thresholds (60% for MVP)
10. Pre-commit hooks prevent commits with failing tests or linting errors

## Tasks / Subtasks

- [ ] **Task 1: Configure PHPUnit for Laravel** (AC: 1)
  - [ ] Verify PHPUnit installation in apps/api/
  - [ ] Configure test database in phpunit.xml
  - [ ] Create HealthControllerTest in tests/Feature/
  - [ ] Write test for GET /api/health endpoint
  - [ ] Ensure test passes with `php artisan test`

- [ ] **Task 2: Set up Vitest for React** (AC: 2)
  - [ ] Install Vitest and testing dependencies in apps/web/
  - [ ] Configure vitest.config.ts for React/TypeScript
  - [ ] Set up testing utilities and test setup file
  - [ ] Create example component test (e.g., Button.test.tsx)
  - [ ] Verify tests run with `npm run test`

- [ ] **Task 3: Configure Jest for Node.js scraper** (AC: 3)
  - [ ] Install Jest and ts-jest in apps/scraper/
  - [ ] Configure jest.config.js for TypeScript
  - [ ] Create test for fuel type mapping utility
  - [ ] Write test for rate limiter functionality
  - [ ] Ensure tests pass with `npm test`

- [ ] **Task 4: Install and configure Playwright** (AC: 4)
  - [ ] Install Playwright at root level
  - [ ] Configure playwright.config.ts
  - [ ] Create tests/e2e/ directory structure
  - [ ] Write basic login flow test (can use .skip for now)
  - [ ] Set up test fixtures and page objects

- [ ] **Task 5: Create GitHub Actions CI workflow** (AC: 5, 6)
  - [ ] Create .github/workflows/ci.yml
  - [ ] Configure workflow triggers (pull_request, push to main)
  - [ ] Set up job matrix for parallel testing
  - [ ] Add caching for dependencies
  - [ ] Configure status checks as required

- [ ] **Task 6: Implement linting and type checking in CI** (AC: 6)
  - [ ] Add ESLint check for JavaScript/TypeScript
  - [ ] Add PHP CS Fixer or similar for Laravel
  - [ ] Add TypeScript compilation check
  - [ ] Configure Prettier formatting check
  - [ ] Ensure all checks run in parallel

- [ ] **Task 7: Set up test execution in CI** (AC: 5, 6)
  - [ ] Configure Laravel tests with test database
  - [ ] Set up React component tests
  - [ ] Configure Node.js scraper tests
  - [ ] Add E2E tests (allowed to fail initially)
  - [ ] Generate test artifacts on failure

- [ ] **Task 8: Configure frontend CD to Vercel** (AC: 7)
  - [ ] Create .github/workflows/deploy-frontend.yml
  - [ ] Configure trigger on main branch merge
  - [ ] Set up Vercel token in GitHub Secrets
  - [ ] Add build and deploy steps
  - [ ] Configure environment variables

- [ ] **Task 9: Set up backend CD to Laravel Forge** (AC: 8)
  - [ ] Create .github/workflows/deploy-backend.yml
  - [ ] Configure webhook trigger to Forge
  - [ ] Store Forge webhook URL in GitHub Secrets
  - [ ] Add deployment notification
  - [ ] Implement rollback mechanism

- [ ] **Task 10: Configure test coverage reporting** (AC: 9)
  - [ ] Set up coverage collection for each test suite
  - [ ] Configure coverage thresholds (60% minimum)
  - [ ] Add coverage reporting to CI output
  - [ ] Optional: Integrate with Codecov or similar
  - [ ] Create coverage badges for README

- [ ] **Task 11: Set up pre-commit hooks** (AC: 10)
  - [ ] Install Husky at root level
  - [ ] Configure lint-staged for targeted checks
  - [ ] Add pre-commit hook for linting
  - [ ] Add pre-commit hook for type checking
  - [ ] Add pre-push hook for tests (optional)

## Dev Notes

### Previous Story Context

[Source: Stories 1.1-1.6]

- Story 1.1: Monorepo structure with package.json configured
- Story 1.3: GitHub repository created, Vercel and Forge accounts set up
- Story 1.4: Node.js scraper ready for testing (Approved)
- Story 1.5: Laravel health endpoint ready for testing (Approved)
- Story 1.6: Integration endpoints ready for testing

### Testing Framework Configuration

[Source: architecture/testing-strategy.md]

**Testing Stack:**

- **Laravel (PHPUnit 10.x):** Feature and Unit tests
- **React (Vitest 1.0+):** Component and unit tests
- **Scraper (Jest):** Unit and integration tests
- **E2E (Playwright 1.40+):** User flow tests

**Test Organization:**

```
apps/api/tests/
├── Feature/
│   └── HealthControllerTest.php
└── Unit/

apps/web/tests/
├── unit/
│   └── Button.test.tsx
└── setup.ts

apps/scraper/tests/
├── unit/
│   └── fuelMapper.test.ts
└── integration/

tests/e2e/
├── login.spec.ts
└── fixtures/
```

### GitHub Actions CI Configuration

[Source: architecture/deployment-architecture.md]

**.github/workflows/ci.yml structure:**

```yaml
name: CI
on:
  pull_request:
  push:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run lint

  test-laravel:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
      redis:
        image: redis:7
    steps:
      - uses: actions/checkout@v3
      - uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
      - run: cd apps/api && composer install
      - run: cd apps/api && php artisan test

  test-react:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: cd apps/web && npm test

  test-scraper:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: cd apps/scraper && npm test
```

### Vercel Deployment Configuration

[Source: Stories 1.3, architecture/deployment-architecture.md]

**.github/workflows/deploy-frontend.yml:**

```yaml
name: Deploy Frontend
on:
  push:
    branches: [main]
    paths:
      - "apps/web/**"
      - "packages/shared/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./apps/web
```

### Laravel Forge Deployment

[Source: Story 1.3]

**.github/workflows/deploy-backend.yml:**

```yaml
name: Deploy Backend
on:
  push:
    branches: [main]
    paths:
      - "apps/api/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Trigger Forge Deployment
        run: |
          curl -X POST ${{ secrets.FORGE_WEBHOOK_URL }}
```

### Coverage Configuration

[Source: AC 9]

**PHPUnit Coverage (phpunit.xml):**

```xml
<coverage>
  <include>
    <directory suffix=".php">./app</directory>
  </include>
  <report>
    <clover outputFile="coverage.xml"/>
    <html outputDirectory="coverage"/>
  </report>
</coverage>
```

**Vitest Coverage (vitest.config.ts):**

```typescript
export default {
  test: {
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "html"],
      thresholds: {
        branches: 60,
        functions: 60,
        lines: 60,
        statements: 60,
      },
    },
  },
};
```

### Pre-commit Hooks Configuration

[Source: Story 1.1, AC 10]

**Husky + lint-staged setup:**

```json
// package.json
{
  "lint-staged": {
    "*.{js,ts,tsx}": ["eslint --fix", "prettier --write"],
    "*.php": ["php-cs-fixer fix"],
    "*.{json,md,yml}": ["prettier --write"]
  }
}
```

**.husky/pre-commit:**

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npx lint-staged
```

### Environment Variables for CI/CD

[Source: Stories 1.3, 1.6]

**GitHub Secrets Required:**

- `VERCEL_TOKEN`: From Vercel account settings
- `VERCEL_ORG_ID`: Vercel organization ID
- `VERCEL_PROJECT_ID`: Vercel project ID
- `FORGE_WEBHOOK_URL`: Laravel Forge deployment webhook
- `SENTRY_AUTH_TOKEN`: For source map uploads
- Test database credentials for CI

### Test Database Configuration

[Source: Story 1.2]

For CI testing, use separate test database:

```env
DB_CONNECTION=pgsql
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=fuelintel_test
DB_USERNAME=postgres
DB_PASSWORD=password
```

## Testing

### Testing Standards

[Source: architecture/testing-strategy.md]

- Each application must have at least one passing test
- Coverage thresholds: 60% for MVP, increase over time
- Tests must run in CI before merge
- E2E tests can be skipped initially but structure must exist

### Specific Test Cases

1. PHPUnit test for health endpoint returns 200
2. Vitest test for React component renders correctly
3. Jest test for fuel type mapping function
4. Playwright test structure exists (can be skipped)
5. CI workflow triggers on pull request
6. Linting fails CI on errors
7. Type checking fails CI on errors
8. Frontend deploys to Vercel on main merge
9. Backend webhook triggers Forge deployment
10. Coverage reports generated and thresholds enforced
11. Pre-commit hook blocks commit with linting errors
12. All tests run in parallel in CI for speed

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-08-13 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
